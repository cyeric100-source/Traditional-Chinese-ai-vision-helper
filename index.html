<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½è¦–éšœè¼”åŠ© AI åŠ©ç† (å¤šå¼•æ“ç‰ˆ)</title>
    <!-- å¼•å…¥ Markdown è§£æåº« -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00; /* é«˜å°æ¯”é»ƒè‰² */
            --link-color: #88CCFF;
            --input-bg: #1A1A1A;
            --border-color: #555555;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --focus-ring: 4px solid #FFFF00;
            --error-bg: #440000;
            --section-bg: #111;
        }

        /* åŸºç¤è¨­å®š */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            font-size: 1.1rem;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--accent-color);
            color: var(--button-text);
            padding: 8px;
            z-index: 1001;
            text-decoration: none;
            font-weight: bold;
        }
        .skip-link:focus { top: 0; }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 300px 10px; /* åº•éƒ¨ç•™ç™½å¢åŠ  */
        }

        /* ç„¦é»æ¨£å¼ */
        *:focus-visible {
            outline: var(--focus-ring) !important;
            outline-offset: 2px;
            box-shadow: 0 0 15px rgba(255, 255, 0, 0.5);
            border-radius: 4px;
        }

        h1, h2, h3 { color: var(--accent-color); margin-top: 1.5rem; }
        
        /* è¨­å®šå€å¡Šæ¨£å¼ */
        details {
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            padding: 15px;
            background: #222;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        summary::after { content: "â–¼"; font-size: 0.8em; margin-left: 10px; }
        details[open] summary::after { content: "â–²"; }

        label { display: block; margin-top: 15px; font-weight: bold; color: #ddd; }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 15px;
            margin-top: 8px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-size: 1.1rem;
            border-radius: 6px;
            box-sizing: border-box;
        }

        /* ç‰¹åˆ¥æ¨™è¨»ç›®å‰çš„ AI æä¾›å•† */
        .provider-badge {
            display: inline-block;
            background: #333;
            color: var(--accent-color);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9em;
            margin-bottom: 5px;
            border: 1px solid var(--accent-color);
        }

        textarea#system-prompt {
            font-family: monospace;
            min-height: 200px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .char-count { text-align: right; font-size: 0.9rem; color: #aaa; margin-top: 5px; }
        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 2px solid #fff;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            flex: 1;
            min-width: 120px;
            touch-action: manipulation;
        }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        button:active { transform: scale(0.98); }

        /* è¼¸å‡ºèˆ‡ Markdown */
        .message {
            background: #111;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--accent-color);
            font-size: 1.15rem;
            overflow-wrap: break-word;
            position: relative;
        }
        .message.user { border-left-color: #0088ff; background: #0a0a1a; }
        .message.error { border-left-color: #ff0000; background: var(--error-bg); }

        .markdown-body a { color: var(--link-color); text-decoration: underline; word-break: break-all; }
        .markdown-body code { background: #333; padding: 2px 5px; border-radius: 3px; font-family: monospace; color: #ff8888; }
        .markdown-body pre { background: #222; padding: 15px; overflow-x: auto; border-radius: 5px; border: 1px solid #444; }
        .markdown-body img { max-width: 100%; height: auto; border-radius: 5px; }

        /* è¤‡è£½æŒ‰éˆ• */
        .action-bar { margin-top: 15px; padding-top: 15px; border-top: 1px solid #444; display: flex; justify-content: flex-end; }
        .copy-btn { background: #222; color: var(--accent-color); border: 1px solid var(--accent-color); padding: 10px 20px; width: auto; flex: 0 0 auto; display: flex; align-items: center; gap: 8px; }
        .copy-btn:hover { background: #333; }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls-wrapper {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95);
            padding: 15px;
            border-top: 3px solid var(--accent-color);
            z-index: 999;
            backdrop-filter: blur(5px);
        }
        .input-row { display: flex; gap: 10px; align-items: center; }
        
        .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        .search-toggle { display: flex; align-items: center; background: #222; padding: 10px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #555; }
        .search-toggle.disabled { opacity: 0.5; pointer-events: none; }
        
        .loading-spinner {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,0,0.3); border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite; margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<a href="#chat-output" class="skip-link">è·³è½‰è‡³å°è©±å…§å®¹</a>
<a href="#user-input" class="skip-link">è·³è½‰è‡³è¼¸å…¥æ¡†</a>

<div class="container">
    <header role="banner">
        <h1 tabindex="-1">AI è¦–éšœè¼”åŠ©åŠ©ç† (å¤šå¼•æ“åˆ‡æ›ç‰ˆ)</h1>
        <p style="text-align:center; color:#ccc;">æ”¯æ´ Gemini, Groq, OpenAI, Mistral, Perplexity</p>
    </header>

    <!-- è¨­å®šå€åŸŸ (AccessKey: S) -->
    <details id="settings-area">
        <summary accesskey="s" role="button" aria-expanded="false">
            <span>âš™ï¸ ç³»çµ±è¨­å®šèˆ‡å¼•æ“é¸æ“‡ (Alt + S)</span>
        </summary>
        <div style="padding-top: 15px;">
            
            <section aria-labelledby="api-setting-heading">
                <h3 id="api-setting-heading">1. é¸æ“‡ AI æœå‹™å•†</h3>
                <p style="font-size:0.9rem; color:#aaa;">ä¸åŒ AI æœ‰ä¸åŒçš„æ”¶è²»èˆ‡èƒ½åŠ›ã€‚åˆ‡æ›æ™‚ç³»çµ±æœƒè‡ªå‹•è¼‰å…¥è©² AI çš„å°ˆå±¬è¨­å®šã€‚</p>
                
                <label for="provider-select" class="visually-hidden">é¸æ“‡ AI æœå‹™å•†</label>
                <select id="provider-select" onchange="handleProviderChange()" style="border: 2px solid var(--accent-color); color: var(--accent-color); font-weight: bold;">
                    <option value="gemini">Google Gemini (æ¨è–¦/å…è²»/PDFå¼·)</option>
                    <option value="groq">Groq (æ¥µé€Ÿ/Llama/å…è²»é¡åº¦é«˜)</option>
                    <option value="openrouter">OpenRouter (è¬ç”¨/æ•´åˆæ‰€æœ‰AI)</option>
                    <option value="openai">OpenAI (GPT-4o/ä»˜è²»/ç©©å®š)</option>
                    <option value="mistral">Mistral AI (æ­æ´²é ‚å°–/éš±ç§ä½³)</option>
                    <option value="perplexity">Perplexity (è¯ç¶²æœå°‹å¼·)</option>
                </select>

                <hr style="border-color:#333; margin: 20px 0;">

                <h3>2. API é‡‘é‘°èˆ‡æ¨¡å‹è¨­å®š</h3>
                <div class="provider-badge" id="current-provider-badge">ç›®å‰è¨­å®šï¼šGoogle Gemini</div>
                
                <label for="api-key">API Key (é‡‘é‘°):</label>
                <input type="password" id="api-key" placeholder="åœ¨æ­¤è¼¸å…¥é‡‘é‘°..." autocomplete="off">
                
                <label for="model-input">AI æ¨¡å‹åç¨± (Model ID):</label>
                <!-- ä½¿ç”¨ input æ­é… datalist è®“ç”¨æˆ¶å¯ä»¥é¸æ“‡ä¹Ÿå¯ä»¥æ‰‹å‹•è¼¸å…¥ -->
                <input type="text" id="model-input" list="model-suggestions" placeholder="ä¾‹å¦‚: gemini-1.5-flash">
                <datalist id="model-suggestions">
                    <!-- æœƒç”± JS å‹•æ…‹å¡«å…¥å»ºè­° -->
                </datalist>
                
                <p style="font-size:0.8rem; color:#888;">æç¤ºï¼šGroq æ¨è–¦ <code>llama-3.2-11b-vision-preview</code>ï¼ŒOpenAI æ¨è–¦ <code>gpt-4o-mini</code>ã€‚</p>

            </section>

            <hr style="border-color:#333; margin: 20px 0;">

            <section aria-labelledby="prompt-setting-heading">
                <h3 id="prompt-setting-heading">3. é è¨­æŒ‡ä»¤ (System Prompt) - ç¨ç«‹å„²å­˜</h3>
                <p style="font-size:0.9rem; color:#aaa;">æ¯å€‹ AI æœå‹™å•†éƒ½æœ‰è‡ªå·±çš„æŒ‡ä»¤è¨˜æ†¶ï¼Œåˆ‡æ›æœå‹™å•†æœƒè‡ªå‹•è¼‰å…¥å°æ‡‰çš„æŒ‡ä»¤ã€‚</p>
                
                <textarea id="system-prompt" rows="10" placeholder="è¼¸å…¥æ­¤ AI çš„è§’è‰²è¨­å®š..." oninput="updateCharCount()"></textarea>
                <div class="char-count" id="char-count-display">å­—æ•¸: 0</div>

                <div class="btn-group">
                    <button type="button" onclick="saveCurrentSettings()" aria-label="å„²å­˜ç›®å‰ AI çš„è¨­å®š">
                        ğŸ’¾ å„²å­˜ (ç›®å‰ AI)
                    </button>
                    <button type="button" onclick="restoreDefaultPrompt()" class="secondary">
                        â†©ï¸ æ¢å¾©é è¨­å€¼
                    </button>
                </div>
                <p id="save-status" role="status" aria-live="polite" style="text-align:center; margin-top:10px; color: var(--accent-color); font-weight:bold;"></p>
            </section>
        </div>
    </details>

    <!-- å°è©±è¼¸å‡ºå€åŸŸ -->
    <main id="chat-output" role="log" aria-live="polite" aria-atomic="false">
        <div class="message">
            <strong>ç³»çµ±å°±ç·’ã€‚</strong><br>
            ç›®å‰ä½¿ç”¨å¼•æ“ï¼š<span id="active-provider-name" style="color:var(--accent-color)">Google Gemini</span><br>
            è«‹æŒ‰ <strong>Tab</strong> éµç€è¦½ï¼Œæˆ–ä½¿ç”¨ <strong>Alt+I</strong> ç›´æ¥è¼¸å…¥å•é¡Œã€‚
        </div>
    </main>
</div>

<!-- åº•éƒ¨æ§åˆ¶å€ -->
<footer class="controls-wrapper" role="contentinfo">
    <form id="chat-form" onsubmit="handleFormSubmit(event)">
        
        <!-- å·¥å…·åˆ— -->
        <div style="margin-bottom: 10px;">
             <!-- æœå°‹é–‹é—œ (åƒ… Gemini æœ‰æ•ˆ) -->
            <div class="search-toggle" id="search-toggle-container">
                <input type="checkbox" id="enable-search" accesskey="g">
                <label for="enable-search" style="margin:0; cursor:pointer; flex:1;">
                    å•Ÿç”¨è¯ç¶²æœå°‹ <span style="color:#888; font-size:0.8em;">(Alt + G, åƒ… Gemini/Perplexity)</span>
                </label>
            </div>

            <!-- æª”æ¡ˆä¸Šå‚³ -->
            <input type="file" id="file-input" class="visually-hidden" 
                   accept="image/*,application/pdf,text/plain" 
                   onchange="handleFileSelect()">
            
            <button type="button" id="upload-trigger-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u" style="width:100%; text-align:left;">
                ğŸ“ é¸æ“‡åœ–ç‰‡/æª”æ¡ˆ (æœªé¸æ“‡) <span style="float:right; font-weight:normal; font-size:0.8em;">Alt + U</span>
            </button>
        </div>
        
        <!-- è¼¸å…¥å€ -->
        <div class="input-row">
            <div style="flex: 1;">
                <label for="user-input" class="visually-hidden">è¼¸å…¥æ‚¨çš„å•é¡Œ</label>
                <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" accesskey="i">
            </div>
            <button type="submit" id="submit-btn" style="flex: 0 0 100px; padding:10px;">
                å‚³é€
            </button>
        </div>
    </form>
</footer>

<script>
    // === AI æœå‹™å•†è¨­å®šè³‡æ–™åº« ===
    const PROVIDERS = {
        gemini: {
            name: "Google Gemini",
            type: "native_gemini", // ä½¿ç”¨ Google åŸç”Ÿ API çµæ§‹
            defaultModel: "gemini-1.5-flash",
            suggestions: ["gemini-1.5-flash", "gemini-1.5-pro", "gemini-2.0-flash-exp"],
            defaultPrompt: `# è§’è‰²è¨­å®š (Gemini)
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è¦–éšœè¼”åŠ©åŠ©ç†ã€‚è«‹ç™¼æ®ä½ çš„å¤šæ¨¡æ…‹èƒ½åŠ›ã€‚
1. è‹¥åœ–ç‰‡æœ‰æ–‡å­—ï¼Œè«‹å®Œæ•´è®€å‡º (OCR)ã€‚
2. è‹¥æ˜¯ PDFï¼Œè«‹ç¸½çµé‡é»ç« ç¯€ã€‚
3. è‹¥æ˜¯ç”Ÿæ´»ç…§ï¼Œè«‹æè¿°å ´æ™¯ã€é¡è‰²èˆ‡æ°›åœã€‚`,
            supportSearch: true
        },
        groq: {
            name: "Groq",
            type: "openai_compatible",
            baseUrl: "https://api.groq.com/openai/v1",
            defaultModel: "llama-3.2-11b-vision-preview",
            suggestions: ["llama-3.2-11b-vision-preview", "llama-3.2-90b-vision-preview"],
            defaultPrompt: `# è§’è‰²è¨­å®š (Groq)
ä½ æ˜¯ä¸€ä½æ¥µé€Ÿè¦–éšœè¼”åŠ© AIã€‚
è«‹ç”¨æœ€ç°¡æ½”ã€å¿«é€Ÿçš„æ–¹å¼æè¿°åœ–ç‰‡å…§å®¹ã€‚
é‡é»æ”¾åœ¨ï¼šéšœç¤™ç‰©ä½ç½®ã€ç‰©é«”åç¨±ã€æ–‡å­—å…§å®¹ã€‚`,
            supportSearch: false
        },
        openrouter: {
            name: "OpenRouter",
            type: "openai_compatible",
            baseUrl: "https://openrouter.ai/api/v1",
            defaultModel: "google/gemini-flash-1.5",
            suggestions: ["google/gemini-flash-1.5", "qwen/qwen-2.5-vl-72b-instruct:free", "mistralai/pixtral-12b"],
            defaultPrompt: `# è§’è‰²è¨­å®š (OpenRouter)
ä½ æ˜¯ä¸€ä½æ•´åˆå‹è¦–éšœåŠ©ç†ã€‚
è«‹æ ¹æ“šé¸ç”¨çš„æ¨¡å‹ç‰¹æ€§ï¼Œæä¾›æº–ç¢ºçš„åœ–ç‰‡æè¿°èˆ‡å•é¡Œè§£ç­”ã€‚`,
            supportSearch: false
        },
        openai: {
            name: "OpenAI",
            type: "openai_compatible",
            baseUrl: "https://api.openai.com/v1",
            defaultModel: "gpt-4o-mini",
            suggestions: ["gpt-4o-mini", "gpt-4o"],
            defaultPrompt: `# è§’è‰²è¨­å®š (OpenAI)
ä½ æ˜¯ç”± GPT-4 é©…å‹•çš„é«˜ç´šè¦–éšœåŠ©ç†ã€‚
è«‹æä¾›æ¥µç‚ºç´°è†©çš„è¦–è¦ºæè¿°ï¼ŒåŒ…æ‹¬å…‰å½±ã€è¡¨æƒ…èˆ‡ç´°ç¯€ã€‚`,
            supportSearch: false
        },
        mistral: {
            name: "Mistral AI",
            type: "openai_compatible",
            baseUrl: "https://api.mistral.ai/v1",
            defaultModel: "pixtral-12b-2409",
            suggestions: ["pixtral-12b-2409", "mistral-large-latest"],
            defaultPrompt: `# è§’è‰²è¨­å®š (Mistral)
ä½ æ˜¯ä¸€ä½æ³¨é‡éš±ç§çš„è¦–éšœåŠ©ç†ã€‚è«‹ç²¾æº–è­˜åˆ¥åœ–ç‰‡ä¸­çš„æ–‡å­—èˆ‡æ•¸æ“šã€‚`,
            supportSearch: false
        },
        perplexity: {
            name: "Perplexity",
            type: "openai_compatible",
            baseUrl: "https://api.perplexity.ai",
            defaultModel: "llama-3.1-sonar-large-128k-online",
            suggestions: ["llama-3.1-sonar-large-128k-online", "llama-3.1-sonar-small-128k-online"],
            defaultPrompt: `# è§’è‰²è¨­å®š (Perplexity)
ä½ æ˜¯ä¸€ä½å³æ™‚è³‡è¨ŠåŠ©ç†ã€‚
è«‹å°ˆæ³¨æ–¼æä¾›æœ€æ–°çš„ç¶²è·¯è³‡è¨Šã€æ–°èã€åƒ¹æ ¼èˆ‡å¤©æ°£ã€‚
(æ³¨æ„ï¼šæ­¤æ¨¡å¼ä¸æ”¯æ´åœ–ç‰‡åˆ†æï¼Œè«‹å°ˆæ³¨æ–‡å­—å›ç­”)`,
            supportSearch: true // å…¶å¯¦æ˜¯å…§å»ºï¼Œä½†æ¨™è¨˜ç‚º true æ–¹ä¾¿ç†è§£
        }
    };

    // === éŸ³æ•ˆç³»çµ± ===
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }
    function playSuccess() { playTone(880, 'sine', 0.1); setTimeout(() => playTone(1760, 'sine', 0.2), 100); }
    function playError() { playTone(150, 'sawtooth', 0.3); setTimeout(() => playTone(100, 'sawtooth', 0.4), 200); }

    // === åˆå§‹åŒ–èˆ‡ç‹€æ…‹ç®¡ç† ===
    document.addEventListener('DOMContentLoaded', function() {
        // 1. è¼‰å…¥ä¸Šæ¬¡é¸æ“‡çš„ Provider
        const savedProvider = localStorage.getItem('active_provider') || 'gemini';
        document.getElementById('provider-select').value = savedProvider;
        
        // 2. æ ¹æ“š Provider è¼‰å…¥å°æ‡‰è¨­å®š
        handleProviderChange(false); // false ä»£è¡¨ä¸æ’­æ”¾åˆ‡æ›éŸ³æ•ˆ
    });

    function handleProviderChange(playSound = true) {
        const providerKey = document.getElementById('provider-select').value;
        const config = PROVIDERS[providerKey];
        
        // æ›´æ–° UI æ¨™ç¤º
        document.getElementById('current-provider-badge').textContent = `ç›®å‰è¨­å®šï¼š${config.name}`;
        document.getElementById('active-provider-name').textContent = config.name;
        
        // è®€å–è©² Provider çš„å„²å­˜è³‡æ–™ (è‹¥ç„¡å‰‡ç”¨é è¨­å€¼)
        const savedApiKey = localStorage.getItem(`${providerKey}_api_key`) || "";
        const savedPrompt = localStorage.getItem(`${providerKey}_system_prompt`) || config.defaultPrompt;
        const savedModel = localStorage.getItem(`${providerKey}_model`) || config.defaultModel;

        // å¡«å…¥æ¬„ä½
        document.getElementById('api-key').value = savedApiKey;
        document.getElementById('system-prompt').value = savedPrompt;
        document.getElementById('model-input').value = savedModel;
        
        // æ›´æ–°æ¨¡å‹å»ºè­°æ¸…å–®
        const dataList = document.getElementById('model-suggestions');
        dataList.innerHTML = "";
        config.suggestions.forEach(model => {
            let option = document.createElement('option');
            option.value = model;
            dataList.appendChild(option);
        });

        // æ§åˆ¶æœå°‹é–‹é—œé¡¯ç¤º (åƒ… Gemini/Perplexity é©åˆ)
        const searchDiv = document.getElementById('search-toggle-container');
        if (config.supportSearch) {
            searchDiv.classList.remove('disabled');
        } else {
            searchDiv.classList.add('disabled');
            document.getElementById('enable-search').checked = false;
        }

        updateCharCount();
        if(playSound) playSuccess();
        
        // å„²å­˜ç›®å‰çš„é¸æ“‡
        localStorage.setItem('active_provider', providerKey);
    }

    function saveCurrentSettings() {
        const providerKey = document.getElementById('provider-select').value;
        const apiKey = document.getElementById('api-key').value.trim();
        const prompt = document.getElementById('system-prompt').value;
        const model = document.getElementById('model-input').value.trim();

        if (!apiKey) { alert("âš ï¸ è«‹è¼¸å…¥ API Key"); return; }

        // å„²å­˜è‡³ LocalStorage (åŠ ä¸Š provider å‰ç¶´)
        localStorage.setItem(`${providerKey}_api_key`, apiKey);
        localStorage.setItem(`${providerKey}_system_prompt`, prompt);
        localStorage.setItem(`${providerKey}_model`, model);

        playSuccess();
        const status = document.getElementById('save-status');
        status.textContent = `âœ… ${PROVIDERS[providerKey].name} è¨­å®šå·²å„²å­˜ï¼`;
        setTimeout(() => status.textContent = "", 3000);
    }

    function restoreDefaultPrompt() {
        const providerKey = document.getElementById('provider-select').value;
        if(confirm(`ç¢ºå®šè¦æ¢å¾© ${PROVIDERS[providerKey].name} çš„é è¨­æŒ‡ä»¤å—ï¼Ÿ`)) {
            document.getElementById('system-prompt').value = PROVIDERS[providerKey].defaultPrompt;
            updateCharCount();
        }
    }

    function updateCharCount() {
        document.getElementById('char-count-display').textContent = `å­—æ•¸: ${document.getElementById('system-prompt').value.length}`;
    }

    // === æ ¸å¿ƒé‚è¼¯ï¼šè·¯ç”±è«‹æ±‚ ===
    async function handleFormSubmit(event) {
        event.preventDefault();
        const submitBtn = document.getElementById('submit-btn');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const outputDiv = document.getElementById('chat-output');
        
        // å–å¾—ç›®å‰ Provider è¨­å®š
        const providerKey = document.getElementById('provider-select').value;
        const config = PROVIDERS[providerKey];
        const apiKey = localStorage.getItem(`${providerKey}_api_key`);
        const model = localStorage.getItem(`${providerKey}_model`) || config.defaultModel;
        const systemPrompt = localStorage.getItem(`${providerKey}_system_prompt`) || config.defaultPrompt;
        const useSearch = document.getElementById('enable-search').checked;

        if (!apiKey) {
            alert(`è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ ${config.name} çš„ API Key`);
            document.getElementById('settings-area').open = true;
            document.getElementById('api-key').focus();
            return;
        }

        const text = userInput.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) return;

        // UI é–å®š
        playTone(440, 'sine', 0.1);
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner"></span>';

        // é¡¯ç¤ºç”¨æˆ¶è¨Šæ¯
        if (text) {
            outputDiv.innerHTML += `<div class="message user">${text}</div>`;
        }

        // æº–å‚™å›æ‡‰å€å¡Š
        const contentId = 'content-' + Date.now();
        const responseDiv = document.createElement('div');
        responseDiv.className = 'message';
        responseDiv.innerHTML = `AI (${config.name}) æ­£åœ¨æ€è€ƒ...`;
        outputDiv.appendChild(responseDiv);
        window.scrollTo(0, document.body.scrollHeight);

        try {
            let responseText = "";
            let base64Data = null;
            let mimeType = null;

            if (file) {
                base64Data = await fileToBase64(file);
                mimeType = file.type;
            }

            // æ ¹æ“šé¡å‹åˆ†æµ
            if (config.type === 'native_gemini') {
                responseText = await callGeminiAPI(apiKey, model, systemPrompt, text, base64Data, mimeType, useSearch);
            } else {
                // OpenAI ç›¸å®¹æ¨¡å¼ (Groq, OpenRouter, Mistral, OpenAI, Perplexity)
                if (file && mimeType === 'application/pdf') {
                    // å¤§éƒ¨åˆ† OpenAI å…¼å®¹ API ä¸æ”¯æ´ç›´æ¥å‚³ PDFï¼Œéœ€æç¤ºç”¨æˆ¶
                    throw new Error("æ­¤ AI æ¨¡å¼æš«ä¸æ”¯æ´ç›´æ¥ä¸Šå‚³ PDFï¼Œè«‹ä½¿ç”¨ Gemini æˆ–å°‡ PDF è½‰ç‚ºåœ–ç‰‡/æ–‡å­—ã€‚");
                }
                responseText = await callOpenAICompatibleAPI(config.baseUrl, apiKey, model, systemPrompt, text, base64Data, mimeType);
            }

            // æ¸²æŸ“çµæœ
            playSuccess();
            const htmlContent = marked.parse(responseText);
            responseDiv.classList.add('markdown-body');
            responseDiv.innerHTML = `
                <div id="${contentId}">${htmlContent}</div>
                <div class="action-bar">
                    <button type="button" class="copy-btn" onclick="copyToClipboard(this, '${contentId}')">ğŸ“‹ è¤‡è£½å…§å®¹</button>
                </div>
            `;
            
            // æ¸…ç†
            userInput.value = "";
            fileInput.value = "";
            handleFileSelect();
            responseDiv.focus();

        } catch (error) {
            playError();
            responseDiv.className = 'message error';
            responseDiv.innerHTML = `<strong>éŒ¯èª¤ (${config.name})ï¼š</strong> ${error.message}`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "å‚³é€";
        }
    }

    // === API å¯¦ä½œ 1: Google Gemini Native ===
    async function callGeminiAPI(key, model, sysPrompt, userText, base64, mime, useSearch) {
        const parts = [];
        if (sysPrompt) parts.push({ text: "System Instruction: " + sysPrompt }); // Gemini Flash æœ‰æ™‚éœ€æ”¾åœ¨ Content è£¡æ¨¡æ“¬ System
        if (userText) parts.push({ text: userText });
        if (base64) {
            parts.push({ inline_data: { mime_type: mime, data: base64 } });
        }

        const body = {
            contents: [{ parts: parts }],
            generationConfig: { temperature: 0.7 }
        };

        // çœŸæ­£çš„ System Instruction (è‹¥æ¨¡å‹æ”¯æ´)
        // é€™è£¡ç‚ºæ±‚ç°¡ä¾¿ï¼Œä½¿ç”¨ Flash æ™‚é€šå¸¸æ··åˆåœ¨ Prompt æ•ˆæœä¹Ÿä¸éŒ¯ï¼Œ
        // ä½†æ¨™æº–å¯«æ³•å¯åƒè€ƒ API æ–‡ä»¶ã€‚é€™è£¡ä¿æŒç›¸å®¹æ€§ã€‚

        if (useSearch) body.tools = [{ googleSearch: {} }];

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Gemini API Error");
        
        let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡å…§å®¹";
        
        // è™•ç†æœå°‹ä¾†æºå¼•ç”¨
        if (data.candidates?.[0]?.groundingMetadata?.groundingChunks) {
            const chunks = data.candidates[0].groundingMetadata.groundingChunks;
            let refs = "\n\n**åƒè€ƒè³‡æ–™ï¼š**\n";
            chunks.forEach((c, i) => {
                if(c.web?.uri) refs += `- [${c.web.title || 'ä¾†æº '+(i+1)}](${c.web.uri})\n`;
            });
            text += refs;
        }
        return text;
    }

    // === API å¯¦ä½œ 2: OpenAI Compatible (Groq, OpenRouter, etc.) ===
    async function callOpenAICompatibleAPI(baseUrl, key, model, sysPrompt, userText, base64, mime) {
        const messages = [];
        
        // 1. System Prompt
        if (sysPrompt) messages.push({ role: "system", content: sysPrompt });

        // 2. User Content (Text + Image)
        const userContent = [];
        if (userText) userContent.push({ type: "text", text: userText || "è«‹æè¿°é€™å¼µåœ–ç‰‡" });
        
        if (base64) {
            // OpenAI æ ¼å¼: data:image/jpeg;base64,...
            const imageUrl = `data:${mime};base64,${base64}`;
            userContent.push({
                type: "image_url",
                image_url: { url: imageUrl }
            });
        }
        
        messages.push({ role: "user", content: userContent });

        const res = await fetch(`${baseUrl}/chat/completions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${key}`,
                // OpenRouter ç‰¹æ®Šéœ€æ±‚
                'HTTP-Referer': window.location.href, 
                'X-Title': 'Visual Assistant' 
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: 0.7
            })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || JSON.stringify(data.error) || "API Error");
        return data.choices[0].message.content;
    }

    // === å·¥å…·å‡½å¼ ===
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        const triggerBtn = document.getElementById('upload-trigger-btn');
        if (fileInput.files[0]) {
            triggerBtn.innerHTML = `âœ… å·²é¸: ${fileInput.files[0].name}`;
            triggerBtn.style.background = "#004400";
        } else {
            triggerBtn.innerHTML = `ğŸ“ é¸æ“‡åœ–ç‰‡/æª”æ¡ˆ (æœªé¸æ“‡) <span style="float:right;">Alt + U</span>`;
            triggerBtn.style.background = "#333";
        }
    }

    function copyToClipboard(btn, id) {
        const text = document.getElementById(id).innerText;
        navigator.clipboard.writeText(text).then(() => {
            const old = btn.innerHTML;
            btn.innerHTML = "âœ… å·²è¤‡è£½";
            setTimeout(() => btn.innerHTML = old, 2000);
        });
    }
</script>

</body>
</html>
