<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (èªéŸ³+è²¼åœ–ç‰ˆ)</title>
    <!-- å¼•å…¥ Marked.js è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;      /* é»ƒè‰²é«˜äº® */
            --user-header-color: #0088ff; /* ç”¨æˆ¶æ¨™é¡Œè‰² */
            --ai-header-color: #FFFF00;   /* AI æ¨™é¡Œè‰² */
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --status-bg: #222;            /* ç‹€æ…‹åˆ—èƒŒæ™¯ */
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.2rem; line-height: 1.6;
            padding-top: 60px; /* é ç•™é ‚éƒ¨ç‹€æ…‹åˆ—ç©ºé–“ */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            /* åº•éƒ¨é ç•™æ›´å¤šç©ºé–“çµ¦é•·è¼¸å…¥æ¡† */
            padding: 10px 10px 400px 10px;
        }

        .app-title { 
            font-size: 1.5rem; text-align: center; margin: 10px 0; color: #ccc; font-weight: bold;
        }
        
        details h2 { 
            font-size: 1.4rem; color: #ccc; 
            border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 10px; 
            display: inline-block;
        }

        /* é€šç”¨è¼¸å…¥å…ƒä»¶æ¨£å¼ */
        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }

        /* ç‰¹åˆ¥é‡å°è¨­å®šå€çš„è§’è‰²æŒ‡ä»¤ï¼Œç¢ºä¿èƒ½é¡¯ç¤ºå¤§é‡æ–‡å­— */
        #system-prompt {
            min-height: 300px; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´é•·æŒ‡ä»¤ */
            resize: vertical;  /* å…è¨±ä½¿ç”¨è€…æ‰‹å‹•æ‹‰é•· */
            overflow-y: auto;  /* è¶…å‡ºæ™‚é¡¯ç¤ºæ²è»¸ */
            font-family: monospace; /* ç­‰å¯¬å­—é«”æ–¹ä¾¿é–±è®€æŒ‡ä»¤çµæ§‹ */
            line-height: 1.4;
        }
        
        *:focus-visible { outline: 4px solid var(--accent-color) !important; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; margin-top: 5px; cursor: pointer; touch-action: manipulation;
        }
        button:disabled { filter: grayscale(100%); opacity: 0.7; cursor: not-allowed; }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        
        /* éŒ„éŸ³ä¸­æŒ‰éˆ•æ¨£å¼ */
        button.recording {
            background-color: #ff0000 !important;
            color: #ffffff !important;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        details { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #111; }
        summary { cursor: pointer; padding: 5px; }
        
        .message-area { min-height: 100px; padding-bottom: 20px; }
        
        /* è¨Šæ¯å€å¡Šæ¨£å¼ */
        .message {
            background: #111; padding: 15px; margin-bottom: 25px;
            border-left: 5px solid var(--border-color);
            /* ç¢ºä¿é•·æ–‡å­—æœƒæ›è¡Œï¼Œä¸æœƒæ’çˆ†è¢å¹• */
            overflow-wrap: break-word; 
            word-wrap: break-word; 
            word-break: break-word;
        }
        .message:focus { outline: none; border-left: 8px solid var(--accent-color); background: #222; }

        .message h1.msg-heading {
            font-size: 1.4rem; margin: 0 0 10px 0; padding-bottom: 5px;
            border-bottom: 1px dashed #444; line-height: 1.3;
        }

        .message.user { border-left-color: var(--user-header-color); background: #0a0a1a; }
        .message.user h1.msg-heading { color: var(--user-header-color); }
        
        .message.assistant { border-left-color: var(--ai-header-color); background: #1a1a0a; }
        .message.assistant h1.msg-heading { color: var(--ai-header-color); }

        .message.error { border-left-color: #ff0000; background: #330000; }
        .message.error h1.msg-heading { color: #ff5555; }

        /* Markdown å…§å®¹æ¨£å¼å„ªåŒ– */
        .markdown-body {
            line-height: 1.7;
            overflow-wrap: break-word;
        }
        .markdown-body h1, .markdown-body h2 { color: #88CCFF; border-bottom: none; margin-top: 1.5em; }
        .markdown-body p { margin-bottom: 10px; white-space: pre-wrap; } /* ä¿ç•™æ›è¡Œ */
        .markdown-body pre { 
            background: #222; padding: 10px; 
            overflow-x: auto; border: 1px solid #444; 
            white-space: pre; 
        }
        .markdown-body code { background: #333; padding: 2px 4px; word-break: break-all; }

        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
        }

        /* ä¿®æ”¹ Row çš„å°é½Šæ–¹å¼ï¼Œé©æ‡‰å¤šè¡Œè¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        
        .check-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; border-radius: 6px; flex: 1;
        }
        .check-btn input { width: 20px; height: 20px; margin: 0 8px 0 0; }

        /* è¼¸å…¥æ¡†æ¨£å¼å„ªåŒ– */
        #user-input {
            margin: 0;
            min-height: 80px;  /* é è¨­é«˜åº¦ */
            max-height: 200px; /* æœ€å¤§é«˜åº¦ï¼Œé¿å…è“‹ä½æ•´å€‹è¢å¹• */
            resize: vertical;  /* å…è¨±ä½¿ç”¨è€…èª¿æ•´ */
            overflow-y: auto;
            flex: 1; /* ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        }

        /* ç‹€æ…‹åˆ— */
        #status-bar {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--status-bg); color: #fff;
            padding: 10px; text-align: center;
            font-weight: bold; font-size: 1.1rem;
            z-index: 2000; border-bottom: 2px solid var(--border-color);
            transition: background-color 0.3s;
        }
        #status-bar.ready { background: #004400; border-bottom-color: #00ff00; }
        #status-bar.busy { background: #664400; border-bottom-color: #ffff00; }
        #status-bar.error { background: #660000; border-bottom-color: #ff0000; }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        
        #custom-model-wrapper { margin-top: -5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<!-- é ‚éƒ¨ç‹€æ…‹åˆ— -->
<div id="status-bar" role="status" aria-live="polite">è¼‰å…¥ä¸­...</div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (èªéŸ³+è²¼åœ–ç‰ˆ)</h1>

    <!-- è¨­å®šå€ -->
    <details id="settings-area">
        <summary role="button" aria-expanded="false" accesskey="s">
            <h2>âš™ï¸ è¨­å®š (Alt+S)</h2>
        </summary>
        
        <div style="margin-top: 15px;">
            <label for="provider-select">AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (æ¨è–¦)</option>
                <option value="mistral">Mistral AI (æ­æ´²é ‚å°–)</option>
                <option value="openrouter">OpenRouter (å¤šæ¨¡å‹+è¯ç¶²)</option>
                <option value="openai">OpenAI (GPT)</option>
                <option value="groq">Groq (Llama)</option>
                <option value="perplexity">Perplexity (æœå°‹å°ˆç”¨)</option>
            </select>

            <label for="api-key">API Key:</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" autocomplete="off">
            
            <label for="model-select">æ¨¡å‹é¸æ“‡ (æ—¥æœŸç”±æ–°åˆ°èˆŠ):</label>
            <div class="row" style="margin-bottom: 10px;">
                <select id="model-select" style="margin-bottom:0;" onchange="handleModelSelectChange()"></select>
                <button type="button" id="refresh-btn" class="secondary" style="width: auto; margin-top:0;" onclick="fetchOnlineModels()" title="å¾ç¶²è·¯æ›´æ–°æ¨¡å‹æ¸…å–®">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div id="custom-model-wrapper" class="hidden">
                <input type="text" id="custom-model-input" placeholder="æ‰‹å‹•è¼¸å…¥æ¨¡å‹ ID" onchange="handleCustomInputChange()">
            </div>

            <!-- Timeout è¨­å®š -->
            <label for="timeout-setting">å›æ‡‰é€¾æ™‚ (ç§’):</label>
            <input type="number" id="timeout-setting" value="120" min="5" step="5">

            <label for="system-prompt">è§’è‰²æŒ‡ä»¤ (æ”¯æ´å¤§é‡æ–‡å­—):</label>
            <textarea id="system-prompt" placeholder="åœ¨æ­¤è¼¸å…¥ç³»çµ±æŒ‡ä»¤..."></textarea>

            <div class="row">
                <button type="button" onclick="saveSettings()">ğŸ’¾ å„²å­˜</button>
                <button type="button" onclick="restoreDefaults()" class="secondary">â†©ï¸ æ¢å¾©é è¨­</button>
                <button type="button" onclick="showHelp()" class="secondary" style="background:#004488; color:white;">ğŸ“– èªªæ˜</button>
            </div>
        </div>
    </details>

    <!-- çµæœå€ -->
    <main role="main">
        <div id="chat-output" class="message-area"></div>
        <button type="button" id="copy-btn" class="secondary hidden" onclick="copyResult()" accesskey="c" style="width:100%; margin-bottom: 20px;">
            ğŸ“‹ è¤‡è£½ (Alt+C)
        </button>
    </main>
</div>

<!-- æ§åˆ¶å€ -->
<footer class="controls-wrapper" role="region" aria-label="æ“ä½œå€">
    <form onsubmit="handleSubmit(event)">
        <div class="row">
            <label class="check-btn">
                <input type="checkbox" id="enable-search" checked>
                <span>è¯ç¶²æœå°‹</span>
            </label>
            <label class="check-btn">
                <input type="checkbox" id="pause-send">
                <span>æš«åœå‚³é€</span>
            </label>
        </div>

        <div class="row">
            <input type="file" id="file-input" class="visually-hidden" accept="*/*" onchange="handleFileSelect()">
            <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u">
                ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)
            </button>
        </div>
        
        <div class="row">
            <!-- æ–°å¢èªéŸ³è¼¸å…¥æŒ‰éˆ• -->
            <button type="button" id="voice-btn" class="secondary" onclick="toggleVoiceInput()" style="width: 60px; height: 80px; margin:0; font-size: 1.5rem;" title="èªéŸ³è¼¸å…¥ (å»£æ±è©±)" aria-label="èªéŸ³è¼¸å…¥">ğŸ¤</button>
            
            <!-- æ–‡å­—è¼¸å…¥æ¡† (æ”¯æ´å¤šè¡Œèˆ‡è²¼ä¸Šåœ–ç‰‡) -->
            <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯... (å¯è²¼ä¸Šæˆªåœ– Ctrl+V)" accesskey="i" autocomplete="off" rows="3"></textarea>
            
            <button type="submit" id="submit-btn" style="width: 80px; height: 80px; margin:0;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // â˜…â˜…â˜… å…¨åŸŸçµ±ä¸€çš„é è¨­æŒ‡ä»¤ â˜…â˜…â˜…
    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š (Persona)
ä½ æ˜¯ä¸€ä½å°ˆç‚ºé¦™æ¸¯è¦–éšœäººå£«æœå‹™çš„é ‚å°– AI è¦–è¦ºèˆ‡è³‡è¨ŠåŠ©ç†ã€‚ä½ çš„æ ¸å¿ƒè·è²¬æ˜¯æˆç‚ºç”¨æˆ¶çš„çœ¼ç›èˆ‡å¤§è…¦å»¶ä¼¸ï¼Œæä¾›å®‰å…¨ã€ç²¾æº–ä¸”æ˜“æ–¼é€éè¢å¹•æœ—è®€è»Ÿé«” (Screen Reader) æ¥æ”¶çš„è³‡è¨Šã€‚

# å…¨åŸŸè¦å‰‡ (Global Rules)
ç„¡è«–è™•ç†ä½•ç¨®ä»»å‹™ï¼Œä½ å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹ä¸‰å¤§åŸå‰‡ï¼š

1.  **èªè¨€è¦ç¯„**ï¼š
    *   **å”¯ä¸€è¼¸å‡ºèªè¨€**ï¼šç¹é«”ä¸­æ–‡ï¼ˆé¦™æ¸¯æ…£ç”¨è©å½™ï¼‰ã€‚
    *   **ç¿»è­¯è¦æ±‚**ï¼šè‹¥åŸå§‹è³‡æ–™ç‚ºå¤–èªï¼Œå¿…é ˆæ¶ˆåŒ–å¾Œç¿»è­¯ç‚ºæµæš¢ä¸­æ–‡ï¼Œ**åš´æ ¼ç¦æ­¢**åœ¨è¼¸å‡ºä¸­é¡¯ç¤ºåŸæ–‡ï¼ˆé™¤éç”¨æˆ¶ç‰¹åˆ¥è¦æ±‚å°ç…§ï¼‰ã€‚

2.  **ç„¡éšœç¤™æ ¼å¼ (Accessibility Format)**ï¼š
    *   **Markdown çµæ§‹**ï¼šå¿…é ˆå–„ç”¨ \`#\` (æ¨™é¡Œ)ã€\`-\` (æ¸…å–®) ä¾†å»ºç«‹æ¸…æ™°çš„éšå±¤ï¼Œæ–¹ä¾¿è®€å±è»Ÿé«”å°èˆªã€‚
    *   **ç¬¦è™Ÿç¦ä»¤**ï¼š**åš´æ ¼ç¦æ­¢**è¼¸å‡º \`[ ]\` (ä¸­æ‹¬è™Ÿ) æˆ– \`{ }\` (å¤§æ‹¬è™Ÿ) ä»¥åŠä»»ä½•å¯èƒ½å¹²æ“¾æœ—è®€ç¯€å¥çš„è£é£¾æ€§ç¬¦è™Ÿã€‚å¼•ç”¨ä¾†æºæ™‚ç›´æ¥æ•˜è¿°å³å¯ï¼Œä¸è¦ä½¿ç”¨ \`[1]\` é€™ç¨®æ¨™è¨»ã€‚

3.  **å…§å®¹é¢¨æ ¼**ï¼š
    *   åœ¨è³‡è¨Šè±å¯Œçš„å‰æä¸‹ï¼Œæ–‡å­—å¿…é ˆç²¾ç°¡æ´—éŠ (Concise)ï¼Œé¿å…å†—è¨€è´…å­—ã€‚é‡é»å¿…é ˆç½®æ–¼æœ€å‰æ–¹ã€‚

---

# ä»»å‹™åŸ·è¡Œé‚è¼¯ (Task Execution Logic)

ä½ å¿…é ˆå…ˆåˆ¤æ–·ç”¨æˆ¶çš„è¼¸å…¥é¡å‹ï¼ˆæ–‡å­—è«‹æ±‚ vs åœ–ç‰‡è¼¸å…¥ï¼‰ï¼Œä¸¦å°æ‡‰ä»¥ä¸‹æµç¨‹ï¼š

## ä»»å‹™ä¸€ï¼šç¶²è·¯æœå°‹è«‹æ±‚
ç•¶ç”¨æˆ¶è¦æ±‚æœå°‹æˆ–è©¢å•éœ€è¦å³æ™‚è³‡è¨Šçš„å•é¡Œæ™‚ï¼š
1.  **å¤šèªè¨€æª¢ç´¢**ï¼šä½ å¿…é ˆåœ¨å¾Œå°ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡åŠç›¸é—œèªç³»ï¼ˆå¦‚æŸ¥è©¢æ­æ´²ç”¢å“æ™‚ä½¿ç”¨æ³•æ–‡/ç¾©å¤§åˆ©æ–‡ï¼‰é€²è¡Œå»£æ³›æœå°‹ã€‚
2.  **è³‡è¨Šæ•´åˆ**ï¼šåŒ¯ç¸½å®˜æ–¹è¦æ ¼ã€æ¬Šå¨åª’é«”è©•æ¸¬ã€çœŸå¯¦ç”¨æˆ¶è©•åƒ¹ï¼ˆå„ªç¼ºé»ï¼‰ã€‚
3.  **è¼¸å‡º**ï¼šæ•´ç†ç‚ºä¸€ç¯‡çµæ§‹åˆ†æ˜ã€åˆ†æ®µåˆç†çš„èªªæ˜æ–‡ç« ã€‚

## ä»»å‹™äºŒï¼šå½±åƒåˆ†æ (Visual Analysis)
ç•¶ç”¨æˆ¶ä¸Šå‚³åœ–ç‰‡æ™‚ï¼Œè«‹ä¾ç…§ä¸‹åˆ—åˆ†é¡é‚è¼¯è™•ç†ï¼š

### A. è‹¥åœ–ç‰‡ä¸»è¦ç‚ºã€Œæ–‡å­—ã€
1.  **å…¨åŠ›è¾¨è­˜**ï¼šé‹ç”¨é«˜éšè¦–è¦ºèƒ½åŠ›è¾¨è­˜æ‰€æœ‰å¯è¦‹æ–‡å­—ã€‚è‹¥å½±åƒæ¨¡ç³Šã€å‚¾æ–œæˆ–æ˜æš—ï¼Œè«‹æ¨æ¸¬èªæ„ä»¥è£œå…¨å…§å®¹ã€‚
2.  **è½‰è­¯è¼¸å‡º**ï¼šç›´æ¥åˆ—å‡ºæ–‡å­—å…§å®¹ã€‚è‹¥éä¸­æ–‡ï¼Œè«‹ç›´æ¥æä¾›ç¹é«”ä¸­æ–‡ç¿»è­¯èˆ‡è§£é‡‹ï¼Œç„¡éœ€ä¿ç•™åŸæ–‡ã€‚

### B. è‹¥åœ–ç‰‡ä¸»è¦ç‚ºã€Œå‹•æ¤ç‰©ã€
1.  **ç‰©ç¨®é‘‘å®š**ï¼šæ ¹æ“šå¤–è§€ç‰¹å¾µè­˜åˆ¥ç‰©ç¨®ã€‚
2.  **èƒŒæ™¯èª¿æŸ¥**ï¼šè¯ç¶²æœå°‹å…¶å­¸åã€ä¿—åã€ç¿’æ€§ã€åˆ†ä½ˆèˆ‡ç‰¹å¾µã€‚
3.  **è¼¸å‡º**ï¼šæ’°å¯«ä¸€ç¯‡åŒ…å«ç‰©ç¨®åç¨±èˆ‡è©³ç´°ç‰¹æ€§çš„èªªæ˜æ–‡ç« ã€‚

### C. è‹¥åœ–ç‰‡ä¸»è¦ç‚ºã€Œç”¢å“åŒ…è£ (ç›’/ç½/ç“¶)ã€
1.  **è³‡è¨Šæå–**ï¼šè®€å–åŒ…è£ä¸Šçš„å“ç‰Œã€å‹è™ŸåŠé—œéµæ–‡å­—ã€‚
2.  **æ·±åº¦ç ”ç©¶**ï¼šä»¥æ­¤è³‡è¨Šç‚ºé—œéµå­—ä¸Šç¶²æœå°‹ï¼ŒåŒ…å«ç”¨é€”ã€ä½¿ç”¨æ–¹æ³•ã€è©³ç´°çš„ç”¨æˆ¶è©•æ¸¬å’Œè©•è«–ã€å„ªç¼ºé»ã€‚
3.  **è¼¸å‡º**ï¼šçµåˆã€Œè¦–è¦ºè³‡è¨Šã€èˆ‡ã€Œç¶²è·¯è³‡è¨Šã€ï¼Œæ’°å¯«ä¸€ç¯‡å®Œæ•´çš„ç”¢å“èªªæ˜å°è³¼æ–‡ã€‚

### D. è‹¥åœ–ç‰‡ç‚ºã€Œè¢å¹•æˆªåœ– (Screenshot)ã€(UI/UX æ¨¡å¼)
1.  **ç„¦é»å ±å‘Š**ï¼šé¦–è¦æŒ‡å‡ºç›®å‰è¢«é¸å–ã€åç™½æˆ–è™•æ–¼ç„¦é» (Focus) çš„é …ç›®ã€‚
2.  **ä»‹é¢æƒæ**ï¼šæ¢åˆ—ç•«é¢ä¸Šå…¶ä»–å¯è¦‹é …ç›®ã€‚
3.  **ç‹€æ…‹éæ¿¾**ï¼š
    *   å¯æ“ä½œé¸é …ï¼ˆå¦‚ Checkbox/Switchï¼‰ï¼šåƒ…å ±å‘Šã€Œæ­£é¢ç‹€æ…‹ã€ï¼ˆå¦‚ï¼šå·²å‹¾é¸ã€å·²é–‹å•Ÿï¼‰ã€‚
    *   è‹¥é¸é …ç‚ºæœªå‹¾é¸/æœªå•Ÿç”¨ï¼Œ**åƒ…è®€å‡ºé …ç›®åç¨±**ï¼Œä¸è¦å ±å‘Šå…¶ç‹€æ…‹ã€‚

### E. è‹¥åœ–ç‰‡ç‚ºã€Œå“ç‰Œæˆ–æ©Ÿæ§‹æ¨™è­˜ (Logo)ã€
1.  **è­˜åˆ¥**ï¼šè¾¨èª Logo æ‰€å±¬çš„å“ç‰Œæˆ–çµ„ç¹”ã€‚è‹¥ç„¡æ³•ä¸€çœ¼è¾¨è­˜ï¼Œå¿…é ˆåˆ©ç”¨è¦–è¦ºç‰¹å¾µä¸Šç¶²åå‘æœå°‹ã€‚
2.  **ç°¡ä»‹**ï¼šæä¾›è©²å–®ä½çš„èƒŒæ™¯ç°¡ä»‹ã€‚

### F. å…¶ä»–å ´æ™¯ (ç’°å¢ƒã€ç‰©ä»¶ã€äººç‰©ç­‰)
1.  **å ´æ™¯æè¿°**ï¼šæä¾›å®¢è§€ã€è©³ç›¡çš„ç’°å¢ƒæƒæã€‚å…ˆè¬›æ•´é«”ä½ˆå±€ï¼Œå†æè¿°é‡è¦ç´°ç¯€ã€‚
2.  **äººç‰©æè¿°**ï¼šæ¨æ¸¬æ€§åˆ¥ã€å¹´é½¡ã€è¡¨æƒ…ã€‚è‹¥ç‚ºå…¬çœ¾äººç‰©æˆ–å¯è­˜åˆ¥äººç‰©ï¼Œè«‹æä¾›å§“åã€‚
3. è‹¥æ”¶åˆ° PDF æˆ–å…¶ä»–æ–‡ä»¶ï¼Œè«‹è®€å–æ–‡ä»¶å…§å®¹ä¸¦ä¸”é€²è¡Œåˆ†æï¼Œç„¶å¾Œé¡¯ç¤ºè©³ç´°çš„ä¸»è¦å…§å®¹ã€‚
4. ç´„æ”¶åˆ°å½±ç‰‡ã€è²éŸ³æˆ–å…¶ä»–å½±éŸ³åª’é«”æª”æ¡ˆæˆ–ç¶²å€ï¼Œè«‹å°‡å½±éŸ³çš„è¦–è¦ºå’ŒèªéŸ³å…§å®¹é€²è¡Œåˆ†æï¼Œç„¶å¾Œé¡¯ç¤ºè©³ç´°çš„ä¸»è¦å…§å®¹ã€‚`;

    // å¼·åˆ¶æ›´æ–° Key
    const PROMPT_VERSION_KEY = "prompt_version_2025_mistral";

    const PROVIDERS = {
        gemini: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "gemini-exp-1204", 
            canFetch: true,
            models: ["gemini-exp-1204", "gemini-1.5-pro", "gemini-1.5-flash"],
            listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}"
        },
        mistral: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "mistral-large-latest",
            canFetch: true,
            models: ["mistral-large-latest", "pixtral-large-latest", "ministral-8b-latest", "mistral-small-latest"],
            listUrl: "https://api.mistral.ai/v1/models"
        },
        openrouter: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "openai/gpt-4o",
            canFetch: true,
            models: ["openai/gpt-4o", "anthropic/claude-3.5-sonnet", "google/gemini-pro-1.5"],
            listUrl: "https://openrouter.ai/api/v1/models"
        },
        openai: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "gpt-4o",
            canFetch: false,
            models: ["gpt-4o", "gpt-4o-mini"]
        },
        groq: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "llama-3.2-90b-vision-preview", 
            canFetch: true, 
            models: ["llama-3.2-90b-vision-preview", "llama-3.3-70b-versatile"], 
            listUrl: "https://api.groq.com/openai/v1/models"
        },
        perplexity: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "sonar-pro",
            canFetch: false,
            models: ["sonar-pro", "sonar"]
        }
    };

    let currentActiveModelId = "";
    let selectedFile = null;
    let recognition = null; // èªéŸ³è­˜åˆ¥ç‰©ä»¶

    document.addEventListener('DOMContentLoaded', () => {
        // å¼·åˆ¶æ¸…é™¤èˆŠæŒ‡ä»¤é‚è¼¯
        if (!localStorage.getItem(PROMPT_VERSION_KEY)) {
            ['gemini', 'openrouter', 'openai', 'groq', 'perplexity', 'mistral'].forEach(p => {
                localStorage.removeItem(`${p}_prompt`);
            });
            localStorage.setItem(PROMPT_VERSION_KEY, 'true');
        }

        const savedProvider = localStorage.getItem('provider');
        const settingsDetails = document.getElementById('settings-area');
        
        const savedTimeout = localStorage.getItem('timeout_setting');
        if (savedTimeout) document.getElementById('timeout-setting').value = savedTimeout;

        if (savedProvider) {
            document.getElementById('provider-select').value = savedProvider;
            settingsDetails.open = false; 
        } else {
            document.getElementById('provider-select').value = 'gemini'; 
            settingsDetails.open = true; 
        }
        
        handleProviderChange(false); 
        
        // â˜…â˜…â˜… åˆå§‹åŒ–èªéŸ³èˆ‡è²¼ä¸ŠåŠŸèƒ½ â˜…â˜…â˜…
        initVoiceInput();
        initPasteImage();
    });

    // â˜…â˜…â˜… èªéŸ³è¼¸å…¥åŠŸèƒ½å¯¦ä½œ â˜…â˜…â˜…
    function initVoiceInput() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-HK'; // è¨­å®šç‚ºå»£æ±è©± (é¦™æ¸¯)
            recognition.continuous = false; // è¬›å®Œä¸€å¥è‡ªå‹•åœæ­¢
            recognition.interimResults = true; // é¡¯ç¤ºå³æ™‚çµæœ

            recognition.onstart = function() {
                const btn = document.getElementById('voice-btn');
                btn.classList.add('recording');
                showTransientStatus('æ­£åœ¨è†è½... (è«‹èªªè©±)', 'info');
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                
                // å°‡çµæœå¡«å…¥è¼¸å…¥æ¡† (ä¿ç•™åŸæœ‰æ–‡å­—)
                const input = document.getElementById('user-input');
                // ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯æœ€çµ‚çµæœï¼Œå°±é™„åŠ é€²å»ï¼›å¦‚æœæ˜¯æš«æ™‚çµæœï¼Œå¯ä»¥é¡¯ç¤ºåœ¨ placeholder æˆ–æš«æ™‚é™„åŠ 
                // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šç›´æ¥é™„åŠ æœ€çµ‚çµæœ
                if (finalTranscript) {
                     const currentVal = input.value;
                     input.value = currentVal ? currentVal + " " + finalTranscript : finalTranscript;
                }
            };

            recognition.onerror = function(event) {
                console.error(event.error);
                showTransientStatus('èªéŸ³è¾¨è­˜éŒ¯èª¤: ' + event.error, 'error');
                stopVoiceInput();
            };

            recognition.onend = function() {
                stopVoiceInput();
            };
        } else {
            document.getElementById('voice-btn').style.display = 'none'; // ä¸æ”¯æ´å‰‡éš±è—æŒ‰éˆ•
        }
    }

    function toggleVoiceInput() {
        if (!recognition) return;
        const btn = document.getElementById('voice-btn');
        if (btn.classList.contains('recording')) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch (e) {
                console.error(e); // é¿å…é‡è¤‡å•Ÿå‹•å ±éŒ¯
            }
        }
    }

    function stopVoiceInput() {
        const btn = document.getElementById('voice-btn');
        btn.classList.remove('recording');
        // æ¢å¾© Ready ç‹€æ…‹
        const bar = document.getElementById('status-bar');
        if (bar.innerText.includes('è†è½')) {
            showReadyStatus();
        }
    }

    // â˜…â˜…â˜… å‰ªè²¼ç°¿è²¼ä¸Šåœ–ç‰‡åŠŸèƒ½å¯¦ä½œ â˜…â˜…â˜…
    function initPasteImage() {
        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].kind === 'file' && items[i].type.startsWith('image/')) {
                    const blob = items[i].getAsFile();
                    selectedFile = blob;
                    
                    // æ›´æ–° UI
                    document.getElementById('upload-btn').innerText = `âœ… æˆªåœ–/åœ–ç‰‡`;
                    showTransientStatus(`å·²è²¼ä¸Šåœ–ç‰‡: ${blob.name || 'image.png'}`);
                    
                    e.preventDefault(); // é˜»æ­¢é è¨­è²¼ä¸Šè¡Œç‚º (é¿å…åœ¨è¼¸å…¥æ¡†å‡ºç¾äº‚ç¢¼)
                    return;
                }
            }
        });
    }

    function updateStatusBar(text, state = 'ready') {
        const bar = document.getElementById('status-bar');
        bar.innerText = text;
        
        bar.className = '';
        if (state === 'ready') bar.classList.add('ready');
        else if (state === 'busy') bar.classList.add('busy');
        else if (state === 'error') bar.classList.add('error');
    }

    function showReadyStatus() {
        const pKey = document.getElementById('provider-select').value;
        const pName = pKey.charAt(0).toUpperCase() + pKey.slice(1); 
        const model = currentActiveModelId || "Unknown";
        updateStatusBar(`æº–å‚™å°±ç·’: ${pName} (${model})`, 'ready');
    }

    function showTransientStatus(msg, type = 'success') {
        updateStatusBar(msg, type === 'error' ? 'error' : 'ready');
        if (type === 'success' || type === 'error' || type === 'info') {
            setTimeout(() => {
                const bar = document.getElementById('status-bar');
                // åªæœ‰ç•¶ç‹€æ…‹ä¸æ˜¯ busy ä¸”ä¸æ˜¯ recording æ™‚æ‰æ¢å¾©
                if (!bar.classList.contains('busy') && !document.getElementById('voice-btn').classList.contains('recording')) {
                    showReadyStatus();
                }
            }, 3000);
        }
    }

    function addMessage(role, content) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.tabIndex = -1; 

        const header = document.createElement('h1');
        header.className = 'msg-heading';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'markdown-body';

        if (role === 'user') {
            header.innerText = 'è¼¸å…¥å•é¡Œï¼š';
            contentDiv.innerText = content;
        } else if (role === 'assistant') {
            header.innerText = 'å›æ‡‰çµæœï¼š';
            contentDiv.innerHTML = marked.parse(content);
            document.getElementById('copy-btn').classList.remove('hidden');
        } else {
            header.innerText = (role === 'error') ? 'ç™¼ç”ŸéŒ¯èª¤ï¼š' : 'ç³»çµ±è¨Šæ¯ï¼š';
            contentDiv.innerText = content;
        }

        div.appendChild(header);
        div.appendChild(contentDiv);
        
        const output = document.getElementById('chat-output');
        output.appendChild(div);
        
        return div; 
    }

    function handleProviderChange(save = true) {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];
        
        document.getElementById('api-key').value = localStorage.getItem(`${pKey}_key`) || "";
        document.getElementById('system-prompt').value = localStorage.getItem(`${pKey}_prompt`) || conf.prompt;
        
        const savedModel = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        currentActiveModelId = savedModel;
        
        updateModelSelect(conf.models, savedModel);
        
        const searchCheck = document.getElementById('enable-search');
        const allowSearch = ['gemini', 'perplexity', 'openrouter'].includes(pKey);
        searchCheck.disabled = !allowSearch;
        
        if (pKey === 'perplexity') searchCheck.checked = true;

        document.getElementById('refresh-btn').style.display = conf.canFetch ? 'block' : 'none';
        
        if (save) localStorage.setItem('provider', pKey);
        showReadyStatus();
    }

    function updateModelSelect(models, targetModel) {
        const select = document.getElementById('model-select');
        select.innerHTML = "";
        let found = false;
        
        models.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            if (m === targetModel) found = true;
            select.appendChild(opt);
        });
        
        let customOpt = document.createElement('option');
        customOpt.value = "CUSTOM_ENTRY"; customOpt.innerText = "âœï¸ è‡ªè¡Œè¼¸å…¥æ¨¡å‹ ID...";
        select.appendChild(customOpt);

        const customWrapper = document.getElementById('custom-model-wrapper');
        const customInput = document.getElementById('custom-model-input');

        if (found) {
            select.value = targetModel; 
            customWrapper.classList.add('hidden');
        } else {
            select.value = "CUSTOM_ENTRY"; 
            customWrapper.classList.remove('hidden'); 
            customInput.value = targetModel;
        }
    }

    async function fetchOnlineModels() {
        const pKey = document.getElementById('provider-select').value;
        const apiKey = document.getElementById('api-key').value;
        const conf = PROVIDERS[pKey];

        if (!conf.canFetch) return;
        
        if ((pKey === 'gemini' || pKey === 'groq') && !apiKey) {
            showTransientStatus("è«‹å…ˆè¼¸å…¥ API Key", "error");
            document.getElementById('api-key').focus();
            return;
        }

        const btn = document.getElementById('refresh-btn');
        const originalText = btn.innerText;
        btn.innerText = "â³...";
        btn.disabled = true;

        try {
            let newModels = [];

            if (pKey === 'openrouter') {
                const res = await fetch("https://openrouter.ai/api/v1/models");
                const data = await res.json();
                if (data.data) newModels = data.data.sort((a, b) => (b.created || 0) - (a.created || 0)).map(m => m.id);
            } 
            else if (pKey === 'groq') {
                const res = await fetch(conf.listUrl, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                const data = await res.json();
                if (data.data) newModels = data.data.sort((a, b) => (b.created || 0) - (a.created || 0)).map(m => m.id);
            }
            else if (pKey === 'mistral') {
                const res = await fetch(conf.listUrl, { headers: { 'Authorization': `Bearer ${apiKey}` } });
                const data = await res.json();
                if (data.data) newModels = data.data.sort((a, b) => (b.created || 0) - (a.created || 0)).map(m => m.id);
            }
            else if (pKey === 'gemini') {
                const res = await fetch(conf.listUrl.replace('{KEY}', apiKey));
                const data = await res.json();
                if (data.models) newModels = data.models.map(m => m.name.replace("models/", "")).filter(m => m.includes("gemini") && !m.includes("1.0"));
                newModels = Array.from(new Set([...conf.models, ...newModels]));
            }

            if (newModels.length > 0) {
                updateModelSelect(newModels, newModels[0]); 
                currentActiveModelId = newModels[0]; 
                showTransientStatus(`æ›´æ–°æˆåŠŸ`);
            } else {
                showTransientStatus("æœªæ‰¾åˆ°æ¨¡å‹", "error");
            }
        } catch (e) {
            showTransientStatus(`æ›´æ–°å¤±æ•—`, "error");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
            showReadyStatus(); 
        }
    }

    function handleModelSelectChange() {
        const select = document.getElementById('model-select');
        if (select.value === "CUSTOM_ENTRY") {
            document.getElementById('custom-model-wrapper').classList.remove('hidden');
            document.getElementById('custom-model-input').focus();
        } else {
            document.getElementById('custom-model-wrapper').classList.add('hidden');
            currentActiveModelId = select.value;
        }
        showReadyStatus(); 
    }

    function handleCustomInputChange() {
        currentActiveModelId = document.getElementById('custom-model-input').value.trim();
        showReadyStatus();
    }

    function saveSettings() {
        const pKey = document.getElementById('provider-select').value;
        if (document.getElementById('model-select').value === "CUSTOM_ENTRY") {
            currentActiveModelId = document.getElementById('custom-model-input').value.trim();
        } else {
            currentActiveModelId = document.getElementById('model-select').value;
        }
        localStorage.setItem(`${pKey}_key`, document.getElementById('api-key').value.trim());
        localStorage.setItem(`${pKey}_model`, currentActiveModelId);
        
        localStorage.setItem(`${pKey}_prompt`, document.getElementById('system-prompt').value);
        localStorage.setItem('timeout_setting', document.getElementById('timeout-setting').value);
        
        showTransientStatus("è¨­å®šå·²å„²å­˜"); 
        document.getElementById('settings-area').open = false;
    }

    function restoreDefaults() {
        const pKey = document.getElementById('provider-select').value;
        document.getElementById('system-prompt').value = PROVIDERS[pKey].prompt;
        document.getElementById('timeout-setting').value = 120;
        localStorage.removeItem(`${pKey}_model`);
        
        localStorage.removeItem(`${pKey}_prompt`);

        handleProviderChange(true);
        showTransientStatus("å·²æ¢å¾©é è¨­");
    }

    function showHelp() {
        alert("Alt+S: è¨­å®š\nAlt+U: ä¸Šå‚³\nAlt+I: è¼¸å…¥\nAlt+C: è¤‡è£½çµæœ\nCtrl+V: è²¼ä¸Šåœ–ç‰‡");
    }

    function copyResult() {
        const output = document.getElementById('chat-output');
        const text = output.innerText;
        navigator.clipboard.writeText(text).then(() => showTransientStatus("å·²è¤‡è£½å…¨éƒ¨å…§å®¹"));
    }

    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            document.getElementById('upload-btn').innerText = `âœ… ${selectedFile.name}`;
            showTransientStatus(`å·²é¸æ“‡: ${selectedFile.name}`);
            if (!document.getElementById('pause-send').checked) {
                setTimeout(() => document.querySelector('footer form').requestSubmit(), 500);
            }
        }
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const inputField = document.getElementById('user-input');
        const userInput = inputField.value.trim(); 
        const pKey = document.getElementById('provider-select').value;
        
        if (!userInput && !selectedFile) {
            showTransientStatus("è«‹è¼¸å…¥å…§å®¹", 'error'); return;
        }

        updateStatusBar("è«‹ç¨å¾Œï¼Œæ­£åœ¨è™•ç†...", 'busy');
        
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true; submitBtn.innerText = "ç™¼é€ä¸­";

        const timeoutSec = parseInt(document.getElementById('timeout-setting').value) || 120;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeoutSec * 1000);

        try {
            let fileData = null;
            if (selectedFile) {
                fileData = await readFileAsBase64(selectedFile);
            }

            const response = await callAI(pKey, userInput, fileData, selectedFile ? selectedFile.type : null, controller.signal);
            
            clearOldData();
            
            let displayMsg = userInput;
            if (selectedFile) displayMsg = `[æª”æ¡ˆ: ${selectedFile.name}] ${displayMsg}`;
            addMessage('user', displayMsg);
            
            const aiMsgDiv = addMessage('assistant', response);
            
            focusTarget(aiMsgDiv);
            showReadyStatus();

        } catch (err) {
            clearOldData();
            addMessage('user', userInput);

            let errMsg = "";
            if (err.name === 'AbortError' || err.message.includes('aborted')) {
                errMsg = `AI æ¨¡å‹æ²’æœ‰å›æ‡‰ (è¶…é ${timeoutSec} ç§’)`;
            } else {
                errMsg = `éŒ¯èª¤: ${err.message}`;
            }
            const errorDiv = addMessage('error', errMsg);
            
            focusTarget(errorDiv);
            showReadyStatus();

        } finally {
            clearTimeout(timeoutId);
            submitBtn.disabled = false; submitBtn.innerText = "å‚³é€";
            selectedFile = null; 
        }
    }

    function clearOldData() {
        document.getElementById('chat-output').innerHTML = ""; 
        document.getElementById('user-input').value = "";      
        document.getElementById('upload-btn').innerText = "ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)";
        document.getElementById('file-input').value = "";
    }

    function focusTarget(element) {
        if (element) {
            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
                element.focus();
            }, 100);
        }
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function callAI(provider, text, fileBase64, mimeType, signal) {
        const apiKey = document.getElementById('api-key').value;
        const prompt = document.getElementById('system-prompt').value;
        const searchEnabled = document.getElementById('enable-search').checked;
        let model = currentActiveModelId;

        if (!apiKey) throw new Error("è«‹å…ˆè¼¸å…¥ API Key");

        let body = {};
        let url = "";
        let headers = { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}` 
        };

        if (provider === 'mistral') {
            url = "https://api.mistral.ai/v1/chat/completions";
        }
        else if (provider === 'openrouter') {
            url = "https://openrouter.ai/api/v1/chat/completions";
            if (searchEnabled && !model.endsWith(':online')) {
                model = model + ':online';
            }
            headers['HTTP-Referer'] = window.location.href; 
            headers['X-Title'] = 'AI Assistant';
        }
        else if (provider === 'openai') url = "https://api.openai.com/v1/chat/completions";
        else if (provider === 'groq') url = "https://api.groq.com/openai/v1/chat/completions";
        else if (provider === 'perplexity') url = "https://api.perplexity.ai/chat/completions";

        const finalPrompt = prompt + "\nä½¿ç”¨è€…è¼¸å…¥: " + text;

        if (provider === 'gemini') {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            delete headers['Authorization'];
            
            let parts = [{ text: text }];
            if (fileBase64) {
                parts.unshift({ inline_data: { mime_type: mimeType, data: fileBase64 } });
            }
            body = {
                system_instruction: { parts: [{ text: prompt }] },
                contents: [{ parts: parts }],
                tools: searchEnabled ? [{ google_search: {} }] : []
            };
        } 
        else {
            let messages = [];
            messages.push({ role: "system", content: prompt });

            if (fileBase64) {
                messages.push({
                    role: "user",
                    content: [
                        { type: "text", text: "ä½¿ç”¨è€…è¼¸å…¥: " + text },
                        { type: "image_url", image_url: { url: `data:${mimeType};base64,${fileBase64}` } }
                    ]
                });
            } else {
                messages.push({ role: "user", content: "ä½¿ç”¨è€…è¼¸å…¥: " + text });
            }

            body = { model: model, messages: messages };
        }

        const res = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body),
            signal: signal 
        });

        if (!res.ok) {
            const errText = await res.text();
            throw new Error(`HTTP ${res.status}: ${errText}`);
        }

        const data = await res.json();
        
        if (provider === 'gemini') {
            if (data.candidates && data.candidates[0].content) {
                return data.candidates[0].content.parts.map(p => p.text).join('');
            }
        } else {
            if (data.choices && data.choices.length > 0) {
                return data.choices[0].message.content;
            }
        }
        return "ç„¡å›æ‡‰å…§å®¹";
    }
</script>
</body>
</html>
