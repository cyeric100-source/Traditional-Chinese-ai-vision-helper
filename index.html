<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–éšœè¼”åŠ© AI åŠ©ç† (å…¨èƒ½ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("ç³»çµ±éŒ¯èª¤ï¼š" + msg);
            return false;
        };
    </script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --input-bg: #222222;
            --border-color: #666666;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --focus-ring: 4px solid #FFFF00;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 20px;
            line-height: 1.6;
        }

        /* ç„¦é»å¢å¼· */
        *:focus {
            outline: var(--focus-ring) !important;
            outline-offset: 4px;
            box-shadow: 0 0 10px var(--accent-color);
        }

        h1 { margin-bottom: 20px; text-align: center; }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 400px; /* é ç•™æ›´å¤šåº•éƒ¨ç©ºé–“ */
        }

        details {
            background: #111;
            border: 2px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 10px;
            background: #333;
            border-radius: 4px;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            color: var(--text-color);
            font-size: 20px;
            border-radius: 8px;
            box-sizing: border-box;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls-wrapper {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #000000;
            padding: 15px;
            border-top: 4px solid var(--accent-color);
            z-index: 999;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        #chat-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
        }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: 2px solid #fff;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            border-radius: 10px;
            text-align: center;
            min-height: 60px; /* åŠ å¤§è§¸æ§å€ */
        }

        button.secondary {
            background-color: #444;
            color: #fff;
            border-color: #888;
        }

        /* ä¸Šå‚³æŒ‰éˆ• */
        .upload-btn-style {
            background-color: #222;
            color: #fff;
            border: 2px dashed #fff;
            white-space: pre-wrap; /* å…è¨±æ›è¡Œ */
        }

        .search-toggle-container {
            display: flex;
            align-items: center;
            background: #222;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        input[type="checkbox"] {
            width: 30px;
            height: 30px;
            margin-right: 15px;
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .message {
            background: #1a1a1a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .error-msg { background: #400; border: 2px solid #f00; }

        .markdown-body h1, .markdown-body h2 { 
            border-bottom: 1px solid #555; 
            padding-bottom: 5px; margin-top: 1.5em; 
        }
        .markdown-body a { color: #8cf; font-weight: bold; }
        .markdown-body strong { color: var(--accent-color); }

        .shortcut-hint {
            font-size: 0.8em;
            font-weight: normal;
            color: #aaa;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 tabindex="0">AI è¦–è¦ºèˆ‡è½è¦ºåŠ©ç†</h1>
        <p style="text-align:center; font-size: 0.9em; color:#aaa;">
            æ”¯æ´åœ–ç‰‡ã€éŒ„éŸ³ã€PDF æ–‡ä»¶èˆ‡è¯ç¶²æœå°‹
        </p>
    </header>

    <!-- è¨­å®šå€åŸŸ (AccessKey: S) -->
    <details id="settings-area">
        <summary accesskey="s">
            âš™ï¸ è¨­å®šé¸é … (å¿«é€Ÿéµ: Alt + S)
        </summary>
        <div>
            <label for="api-key">Google Gemini API Key:</label>
            <input type="password" id="api-key" placeholder="è«‹è²¼ä¸Š AIza é–‹é ­çš„é‡‘é‘°">
            
            <button type="button" onclick="checkAndSaveKeys()" class="secondary" style="margin-top:15px;">
                ğŸ”„ æ›´æ–° Key ä¸¦æª¢æŸ¥æ¨¡å‹
            </button>
            
            <label for="model-select">é¸æ“‡ AI æ¨¡å‹:</label>
            <select id="model-select">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (æ¨è–¦)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
            <div id="model-status" role="status" aria-live="polite"></div>

            <label for="system-prompt">é è¨­æŒ‡ä»¤ (System Prompt):</label>
            <textarea id="system-prompt"></textarea>
            
            <button type="button" onclick="saveSettings()" style="margin-top:15px;">
                ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š
            </button>
            <p id="save-status" role="status" aria-live="polite"></p>
        </div>
    </details>

    <!-- è¼¸å‡ºå€åŸŸ -->
    <main id="chat-output" aria-live="polite">
        <div class="message">
            <strong>ç³»çµ±å°±ç·’ã€‚</strong><br>
            è«‹æŒ‰ <strong>Tab</strong> éµç€è¦½æ§åˆ¶é …ã€‚<br>
            æ”¯æ´æª”æ¡ˆï¼šJPG, PNG, MP3, WAV, MP4, PDFã€‚
        </div>
    </main>
</div>

<!-- åº•éƒ¨æ§åˆ¶å€ -->
<footer class="controls-wrapper">
    <form id="chat-form" onsubmit="handleFormSubmit(event)">
        
        <!-- 1. æœå°‹é–‹é—œ (AccessKey: G) -->
        <div class="search-toggle-container">
            <input type="checkbox" id="enable-search" accesskey="g">
            <label for="enable-search" style="margin:0; cursor:pointer; flex:1;">
                å•Ÿç”¨ Google è¯ç¶²æœå°‹
                <span class="shortcut-hint">(Alt + G)</span>
            </label>
        </div>

        <!-- 2. æª”æ¡ˆä¸Šå‚³ (AccessKey: U) -->
        <div>
            <!-- 
               accept å±¬æ€§è¨­å®šèªªæ˜ï¼š
               image/* : æ‰€æœ‰åœ–ç‰‡ (æ‹ç…§)
               audio/* : æ‰€æœ‰éŸ³è¨Š (éŒ„éŸ³/MP3)
               video/* : æ‰€æœ‰å½±ç‰‡ (MP4)
               application/pdf : PDF æ–‡ä»¶
               text/plain : ç´”æ–‡å­—æª”
            -->
            <input type="file" id="file-input" class="visually-hidden" 
                   accept="image/*,audio/*,video/*,application/pdf,text/plain" 
                   onchange="handleFileSelect()">
            
            <button type="button" id="upload-trigger-btn" class="upload-btn-style" onclick="document.getElementById('file-input').click()" accesskey="u">
                ğŸ“ é¸æ“‡æª”æ¡ˆ (åœ–ç‰‡/éŒ„éŸ³/PDF/å½±ç‰‡)
                <span class="shortcut-hint"><br>(å¿«é€Ÿéµ: Alt + U)</span>
            </button>
            
            <div id="file-status" role="status" style="color:var(--accent-color); margin-top:5px; text-align:center; font-size:0.9em;"></div>
        </div>
        
        <!-- 3. æ–‡å­—è¼¸å…¥ (AccessKey: I) -->
        <div>
            <label for="user-input" class="sr-only">è¼¸å…¥å•é¡Œ</label>
            <input type="text" id="user-input" placeholder="è¼¸å…¥æ–‡å­—... (Enter é€å‡º)" autocomplete="off" accesskey="i">
        </div>
        
        <!-- 4. éäº¤æŒ‰éˆ• -->
        <button type="submit" id="submit-btn">
            éäº¤ / å‚³é€
            <span class="shortcut-hint">(Enter)</span>
        </button>
    </form>
</footer>

<script>
    // === é è¨­æŒ‡ä»¤ (åŒ…å«å¤šæ¨¡æ…‹è™•ç†é‚è¼¯) ===
    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š
ä½ æ˜¯ä¸€ä½è¦–éšœè¼”åŠ©åŠ©ç†ï¼Œä½¿ç”¨ç¹é«”ä¸­æ–‡(é¦™æ¸¯)ã€‚
# ä»»å‹™é‚è¼¯
1. **åœ–ç‰‡**ï¼šæè¿°å ´æ™¯ã€äººç‰©ã€æ–‡å­—æˆ–ç‰©é«”ç´°ç¯€ã€‚
2. **éŸ³è¨Š**ï¼šè†è½å…§å®¹ï¼Œé€²è¡Œã€ŒèªéŸ³è½‰æ–‡å­—ã€ä¸¦ç¸½çµé‡é»ã€‚
3. **PDF/æ–‡ä»¶**ï¼šé–±è®€æ–‡ä»¶å…§å®¹ï¼Œæå–é—œéµè³‡è¨Šèˆ‡æ‘˜è¦ã€‚
4. **å½±ç‰‡**ï¼šæè¿°å½±ç‰‡ä¸­ç™¼ç”Ÿçš„äº‹ä»¶èˆ‡å‹•ä½œã€‚
5. **æœå°‹**ï¼šè‹¥æœ‰å•Ÿç”¨ï¼Œæ•´åˆæœ€æ–°è³‡è¨Šä¸¦æ¨™è¨»ä¾†æºã€‚
# é¢¨æ ¼
ç²¾ç°¡ã€æ¢åˆ—å¼ï¼Œå°‡æœ€é‡è¦çš„çµè«–æ”¾åœ¨ç¬¬ä¸€å¥ã€‚`;

    // === åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        const key = localStorage.getItem('gemini_api_key');
        if (!key) {
            document.getElementById('settings-area').open = true;
            document.getElementById('api-key').focus();
        } else {
            document.getElementById('user-input').focus();
        }
    });

    // === æª”æ¡ˆé¸æ“‡è™•ç† ===
    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        const statusDiv = document.getElementById('file-status');
        const triggerBtn = document.getElementById('upload-trigger-btn');
        
        if (fileInput.files && fileInput.files[0]) {
            const file = fileInput.files[0];
            const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
            
            // ç‹€æ…‹å›å ±
            let typeLabel = "æª”æ¡ˆ";
            if (file.type.startsWith("image")) typeLabel = "åœ–ç‰‡";
            else if (file.type.startsWith("audio")) typeLabel = "éŸ³è¨Š";
            else if (file.type.startsWith("video")) typeLabel = "å½±ç‰‡";
            else if (file.type === "application/pdf") typeLabel = "PDFæ–‡ä»¶";

            const msg = `å·²é¸æ“‡: ${file.name} (${typeLabel}, ${sizeMB}MB)`;
            statusDiv.textContent = msg;
            triggerBtn.innerHTML = `âœ… ${msg} <span class='shortcut-hint'>(Alt+U é‡é¸)</span>`;
            triggerBtn.style.background = "#004400";
            triggerBtn.style.borderColor = "#00ff00";
            
            // æª¢æŸ¥å¤§å° (Base64 ä¸Šå‚³å»ºè­° < 20MB)
            if (file.size > 20 * 1024 * 1024) {
                alert("âš ï¸ æ³¨æ„ï¼šæª”æ¡ˆè¶…é 20MBï¼Œå¯èƒ½æœƒå°è‡´ä¸Šå‚³å¤±æ•—ã€‚å»ºè­°ä½¿ç”¨è¼ƒå°çš„æª”æ¡ˆã€‚");
            }

            document.getElementById('user-input').focus();
        } else {
            statusDiv.textContent = "";
            triggerBtn.innerHTML = `ğŸ“ é¸æ“‡æª”æ¡ˆ (åœ–ç‰‡/éŒ„éŸ³/PDF/å½±ç‰‡) <span class='shortcut-hint'><br>(å¿«é€Ÿéµ: Alt + U)</span>`;
            triggerBtn.style.background = "#222";
            triggerBtn.style.borderColor = "#fff";
        }
    }

    // === è¡¨å–®éäº¤ ===
    async function handleFormSubmit(event) {
        event.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const outputDiv = document.getElementById('chat-output');
        const useSearch = document.getElementById('enable-search').checked;
        
        const apiKey = localStorage.getItem('gemini_api_key');
        const modelName = localStorage.getItem('gemini_model') || "gemini-1.5-flash"; 
        const systemPrompt = localStorage.getItem('gemini_system_prompt') || DEFAULT_PROMPT;

        const text = userInput.value.trim();
        const file = fileInput.files[0];

        if (!apiKey) {
            alert("è«‹è¼¸å…¥ API Key");
            document.getElementById('settings-area').open = true;
            document.getElementById('api-key').focus();
            return;
        }

        if (!text && !file) {
            alert("è«‹è¼¸å…¥æ–‡å­—æˆ–é¸æ“‡æª”æ¡ˆã€‚");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "â³ æ­£åœ¨ä¸Šå‚³ä¸¦åˆ†æ...";
        outputDiv.innerHTML = `<div class="message" role="status">æ­£åœ¨è™•ç†æ‚¨çš„è«‹æ±‚ (${modelName})...</div>`;

        try {
            let contentsParts = [];
            
            // æ ¹æ“šæª”æ¡ˆé¡å‹èª¿æ•´æç¤ºè©
            let promptText = systemPrompt + "\n\nç”¨æˆ¶æŒ‡ä»¤ï¼š\n" + (text || "è«‹åˆ†æé€™å€‹æª”æ¡ˆçš„å…§å®¹");
            
            contentsParts.push({ text: promptText });

            if (file) {
                const base64Data = await fileToBase64(file);
                contentsParts.push({
                    inline_data: {
                        mime_type: file.type,
                        data: base64Data
                    }
                });
            }

            const requestBody = {
                contents: [{ parts: contentsParts }],
                generationConfig: { temperature: 0.5, maxOutputTokens: 2000 }
            };

            if (useSearch) {
                requestBody.tools = [{ googleSearch: {} }];
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            
            const candidate = data.candidates?.[0];
            const resultText = candidate?.content?.parts?.[0]?.text;
            const groundingMeta = candidate?.groundingMetadata;

            if (resultText) {
                let htmlContent = marked.parse(resultText);

                if (groundingMeta?.groundingChunks) {
                    let sourcesList = "";
                    groundingMeta.groundingChunks.forEach(chunk => {
                        if (chunk.web?.uri) {
                            const title = chunk.web.title || "åƒè€ƒé€£çµ";
                            sourcesList += `<li><a href="${chunk.web.uri}" target="_blank">${title}</a></li>`;
                        }
                    });
                    if (sourcesList) {
                        htmlContent += `<div style="margin-top:20px; padding-top:10px; border-top:1px solid #555;"><h4>ğŸ“š åƒè€ƒä¾†æºï¼š</h4><ul>${sourcesList}</ul></div>`;
                    }
                }

                outputDiv.innerHTML = `<div class="message markdown-body">${htmlContent}</div>`;
                
                userInput.value = "";
                fileInput.value = ""; 
                handleFileSelect();
                outputDiv.focus();
            } else {
                let msg = "ç„¡æ³•å–å¾—å›æ‡‰ã€‚";
                if (data.error) msg = `API éŒ¯èª¤: ${data.error.message}`;
                outputDiv.innerHTML = `<div class="message error-msg" role="alert">${msg}</div>`;
            }

        } catch (error) {
            outputDiv.innerHTML = `<div class="message error-msg" role="alert">é€£ç·šéŒ¯èª¤: ${error.message}</div>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "éäº¤ / å‚³é€";
        }
    }

    // === å·¥å…·å‡½å¼ ===
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function loadSettings() {
        const savedKey = localStorage.getItem('gemini_api_key');
        const savedPrompt = localStorage.getItem('gemini_system_prompt');
        const savedModel = localStorage.getItem('gemini_model');

        document.getElementById('system-prompt').value = savedPrompt || DEFAULT_PROMPT;
        if (savedKey) document.getElementById('api-key').value = savedKey;
        if (savedModel) addAndSelectModel(savedModel);
    }

    function saveSettings() {
        const key = document.getElementById('api-key').value.trim();
        if(!key) { alert("è«‹è¼¸å…¥ Key"); return; }
        
        localStorage.setItem('gemini_api_key', key);
        localStorage.setItem('gemini_system_prompt', document.getElementById('system-prompt').value);
        localStorage.setItem('gemini_model', document.getElementById('model-select').value);
        
        const status = document.getElementById('save-status');
        status.textContent = "âœ… è¨­å®šå·²å„²å­˜ï¼";
        setTimeout(() => status.textContent = "", 3000);
        document.getElementById('settings-area').open = false;
        document.getElementById('user-input').focus();
    }

    function addAndSelectModel(modelId) {
        const select = document.getElementById('model-select');
        if (![...select.options].some(o => o.value === modelId)) {
            let opt = document.createElement('option');
            opt.value = modelId;
            opt.text = modelId + " (ç´€éŒ„)";
            select.add(opt);
        }
        select.value = modelId;
    }

    async function checkAndSaveKeys() {
        const key = document.getElementById('api-key').value.trim();
        const statusDiv = document.getElementById('model-status');
        if(!key) { alert("è«‹å…ˆè¼¸å…¥ Key"); return; }

        statusDiv.textContent = "é€£ç·šæª¢æŸ¥ä¸­...";
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            if(!res.ok) throw new Error("Key ç„¡æ•ˆ");
            const data = await res.json();
            
            const select = document.getElementById('model-select');
            select.innerHTML = "";
            let best = "";
            
            const valid = data.models
                .filter(m => m.supportedGenerationMethods?.includes("generateContent"))
                .sort((a,b) => b.name.includes('flash') - a.name.includes('flash'));
            
            valid.forEach(m => {
                const id = m.name.replace("models/", "");
                let opt = document.createElement("option");
                opt.value = id;
                opt.text = m.displayName + ` (${id})`;
                select.add(opt);
                if(!best && id.includes("flash")) best = id;
            });
            
            if(best) select.value = best;
            statusDiv.textContent = "âœ… æˆåŠŸ";
            localStorage.setItem('gemini_api_key', key);
        } catch(e) {
            statusDiv.textContent = "âŒ éŒ¯èª¤: " + e.message;
        }
    }
</script>

</body>
</html>
