<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (2025 é€£ç·šä¿®æ­£ç‰ˆ)</title>
    <!-- å¼•å…¥ Marked.js è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;     /* é»ƒè‰²é«˜äº® */
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.2rem; line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 350px 10px;
        }

        .app-title { 
            font-size: 1.5rem; text-align: center; margin: 10px 0; color: #ccc; font-weight: bold;
        }
        
        h2 { 
            font-size: 1.4rem; color: var(--accent-color); 
            border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 30px; 
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }
        
        *:focus-visible { outline: 4px solid var(--accent-color) !important; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; margin-top: 5px; cursor: pointer; touch-action: manipulation;
        }
        button:disabled { filter: grayscale(100%); opacity: 0.7; }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        
        details { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #111; }
        summary { cursor: pointer; padding: 5px; }
        
        .message-area { min-height: 100px; padding-bottom: 20px; }
        .message {
            background: #111; padding: 15px; margin-bottom: 15px;
            border-left: 5px solid var(--accent-color);
            overflow-wrap: break-word; word-break: break-word;
        }
        .message.user { border-left-color: #0088ff; background: #0a0a1a; }
        .message.error { border-left-color: #ff0000; background: #330000; }
        .message.info { border-left-color: #88CCFF; background: #0a1a2a; } 

        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
        }

        .row { display: flex; gap: 10px; margin-bottom: 8px; }
        
        .check-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; border-radius: 6px; flex: 1;
        }
        .check-btn input { width: 20px; height: 20px; margin: 0 8px 0 0; }

        #status-toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 0, 0.95); color: #000;
            padding: 20px 40px; border-radius: 10px; font-weight: bold; font-size: 1.5rem;
            z-index: 2000; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #status-toast.show { opacity: 1; }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        
        #custom-model-wrapper { margin-top: -5px; margin-bottom: 10px; }

        /* Markdown Styles */
        .markdown-body h1, .markdown-body h2 { color: #88CCFF; border-bottom: none; margin-top: 1.5em; }
        .markdown-body p { margin-bottom: 10px; }
        .markdown-body pre { background: #222; padding: 10px; overflow-x: auto; border: 1px solid #444; }
        .markdown-body code { background: #333; padding: 2px 4px; }
    </style>
</head>
<body>

<div id="status-toast" role="status" aria-live="polite"></div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (2025 é€£ç·šä¿®æ­£ç‰ˆ)</h1>

    <!-- è¨­å®šå€ -->
    <details id="settings-area">
        <summary role="button" aria-expanded="false" accesskey="s">
            <h2>âš™ï¸ è¨­å®š (Alt+S)</h2>
        </summary>
        
        <div style="margin-top: 15px;">
            <label for="provider-select">AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (æ¨è–¦)</option>
                <option value="openrouter">OpenRouter (å¤šæ¨¡å‹/è‡ªå‹•æ’åº)</option>
                <option value="openai">OpenAI (GPT)</option>
                <option value="groq">Groq (Llama)</option>
                <option value="perplexity">Perplexity (æœå°‹)</option>
            </select>

            <label for="api-key">API Key (OpenRouter/Gemini/Groq å¿…å¡«):</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" autocomplete="off">
            
            <label for="model-select">æ¨¡å‹é¸æ“‡ (æ—¥æœŸç”±æ–°åˆ°èˆŠ):</label>
            <div class="row" style="margin-bottom: 10px;">
                <select id="model-select" style="margin-bottom:0;" onchange="handleModelSelectChange()"></select>
                <button type="button" id="refresh-btn" class="secondary" style="width: auto; margin-top:0;" onclick="fetchOnlineModels()" title="å¾ç¶²è·¯æ›´æ–°æ¨¡å‹æ¸…å–®">ğŸ”„ æ›´æ–°</button>
            </div>
            
            <div id="custom-model-wrapper" class="hidden">
                <input type="text" id="custom-model-input" placeholder="æ‰‹å‹•è¼¸å…¥æ¨¡å‹ ID" onchange="handleCustomInputChange()">
            </div>

            <label for="system-prompt">è§’è‰²æŒ‡ä»¤:</label>
            <textarea id="system-prompt" rows="5"></textarea>

            <div class="row">
                <button type="button" onclick="saveSettings()">ğŸ’¾ å„²å­˜</button>
                <button type="button" onclick="restoreDefaults()" class="secondary">â†©ï¸ æ¢å¾©é è¨­</button>
                <button type="button" onclick="showHelp()" class="secondary" style="background:#004488; color:white;">ğŸ“– èªªæ˜</button>
            </div>
        </div>
    </details>

    <!-- çµæœå€ -->
    <main>
        <h2 id="result-heading" tabindex="-1">å°è©±çµæœ</h2>
        <div id="chat-output" class="message-area"></div>
        <button type="button" id="copy-btn" class="secondary hidden" onclick="copyResult()" accesskey="c" style="width:100%; margin-bottom: 20px;">
            ğŸ“‹ è¤‡è£½ (Alt+C)
        </button>
    </main>
</div>

<!-- æ§åˆ¶å€ -->
<footer class="controls-wrapper" role="region" aria-label="æ“ä½œå€">
    <form onsubmit="handleSubmit(event)">
        <div class="row">
            <label class="check-btn">
                <input type="checkbox" id="enable-search" checked>
                <span>è¯ç¶²æœå°‹</span>
            </label>
            <label class="check-btn">
                <input type="checkbox" id="pause-send">
                <span>æš«åœå‚³é€</span>
            </label>
        </div>

        <div class="row">
            <input type="file" id="file-input" class="visually-hidden" accept="*/*" onchange="handleFileSelect()">
            <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u">
                ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)
            </button>
        </div>
        
        <div class="row">
            <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." accesskey="i" autocomplete="off" style="margin:0;">
            <button type="submit" id="submit-btn" style="width: 90px; margin:0;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    const DEFAULT_PROMPT = `å¿…é ˆè¼¸å‡ºç¹é«”ä¸­æ–‡.
è«‹é©ç•¶åˆ©ç”¨ Markdown æ¨™é¡Œå±¤ç´šè¼¸å‡ºçµæœ.
é‡åˆ°åœ–ç‰‡ã€å½±ç‰‡æˆ–éŸ³è¨Šï¼Œè«‹é€²è¡Œå·¨ç´°ç„¡éºã€å®¢è§€ã€æº–ç¢ºçš„æè¿°.
è‹¥åŒ…å«æ–‡å­—å°±ä½œ OCR ç„¶å¾Œå…¨éƒ¨é¡¯ç¤ºå‡ºä¾†ã€‚
è‹¥è¦ä¸Šç¶²æœå°‹å°±å‹™å¿…æœå°‹ 2025 å¹´çš„æœ€æ–°è³‡æ–™ã€‚`;

    const PROVIDERS = {
        gemini: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "gemini-exp-1204", 
            canFetch: true,
            models: ["gemini-exp-1204", "gemini-2.0-flash-exp", "gemini-1.5-flash"],
            listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}"
        },
        openrouter: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "deepseek/deepseek-chat",
            canFetch: true,
            models: ["deepseek/deepseek-chat", "perplexity/sonar-large-online", "google/gemini-2.0-flash-exp:free", "openai/gpt-4o"],
            listUrl: "https://openrouter.ai/api/v1/models"
        },
        openai: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "gpt-4o",
            canFetch: false,
            models: ["gpt-4o", "gpt-4o-mini"]
        },
        groq: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "llama-3.3-70b-versatile",
            canFetch: true, 
            models: ["llama-3.3-70b-versatile"],
            listUrl: "https://api.groq.com/openai/v1/models"
        },
        perplexity: {
            prompt: DEFAULT_PROMPT,
            defaultModel: "sonar-pro",
            canFetch: false,
            models: ["sonar-pro", "sonar"]
        }
    };

    let currentActiveModelId = "";
    let selectedFile = null;

    document.addEventListener('DOMContentLoaded', () => {
        const settingsDetails = document.getElementById('settings-area');
        if (!localStorage.getItem('visited_2025_fixed')) {
            settingsDetails.open = true;
            localStorage.setItem('visited_2025_fixed', 'true');
        }
        const savedProvider = localStorage.getItem('provider') || 'gemini';
        document.getElementById('provider-select').value = savedProvider;
        handleProviderChange(false);
    });

    function showStatus(msg, type = 'success') {
        const toast = document.getElementById('status-toast');
        toast.innerText = msg;
        toast.style.backgroundColor = type === 'error' ? 'rgba(255, 0, 0, 0.95)' : 'rgba(255, 255, 0, 0.95)';
        toast.style.color = type === 'error' ? '#fff' : '#000';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function addMessage(role, text) {
        const chatOutput = document.getElementById('chat-output');
        const div = document.createElement('div');
        div.className = `message ${role}`;
        
        if (role === 'assistant') {
            try {
                div.innerHTML = marked.parse(text);
            } catch (e) {
                div.innerText = text;
            }
            // è®“è¢å¹•å ±è®€è»Ÿé«”èƒ½è®€åˆ°æ–°è¨Šæ¯
            div.setAttribute('tabindex', '0');
        } else {
            div.innerText = text;
        }
        
        chatOutput.appendChild(div);
        document.getElementById('copy-btn').classList.remove('hidden');
        
        if(role === 'assistant') {
            div.focus();
            window.scrollTo(0, document.body.scrollHeight);
        }
    }

    function handleProviderChange(save = true) {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];
        
        document.getElementById('api-key').value = localStorage.getItem(`${pKey}_key`) || "";
        document.getElementById('system-prompt').value = localStorage.getItem(`${pKey}_prompt`) || conf.prompt;
        
        const savedModel = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        currentActiveModelId = savedModel;
        
        updateModelSelect(conf.models, savedModel);
        
        const searchCheck = document.getElementById('enable-search');
        // â˜…ä¿®æ­£ï¼šOpenRouter ç¾åœ¨ä¹Ÿå…è¨±å‹¾é¸æœå°‹ (å› ç‚ºå¯èƒ½é¸åˆ°ç·šä¸Šæ¨¡å‹)
        searchCheck.disabled = (pKey !== 'gemini' && pKey !== 'perplexity' && pKey !== 'openrouter');
        
        // Perplexity å¼·åˆ¶é–‹å•Ÿ
        if (!searchCheck.disabled && pKey === 'perplexity') searchCheck.checked = true;

        document.getElementById('refresh-btn').style.display = conf.canFetch ? 'block' : 'none';
        if (save) localStorage.setItem('provider', pKey);
    }

    function updateModelSelect(models, targetModel) {
        const select = document.getElementById('model-select');
        select.innerHTML = "";
        let found = false;
        
        models.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m; opt.innerText = m;
            if (m === targetModel) found = true;
            select.appendChild(opt);
        });
        
        let customOpt = document.createElement('option');
        customOpt.value = "CUSTOM_ENTRY"; customOpt.innerText = "âœï¸ è‡ªè¡Œè¼¸å…¥æ¨¡å‹ ID...";
        select.appendChild(customOpt);

        const customWrapper = document.getElementById('custom-model-wrapper');
        const customInput = document.getElementById('custom-model-input');

        if (found) {
            select.value = targetModel; 
            customWrapper.classList.add('hidden');
        } else {
            select.value = "CUSTOM_ENTRY"; 
            customWrapper.classList.remove('hidden'); 
            customInput.value = targetModel;
        }
    }

    async function fetchOnlineModels() {
        const pKey = document.getElementById('provider-select').value;
        const apiKey = document.getElementById('api-key').value;
        const conf = PROVIDERS[pKey];

        if (!conf.canFetch) {
            showStatus("æ­¤æœå‹™å•†ä¸æ”¯æ´è‡ªå‹•æ›´æ–°", "info"); return;
        }
        
        if ((pKey === 'gemini' || pKey === 'groq') && !apiKey) {
            showStatus("è«‹å…ˆè¼¸å…¥ API Key æ‰èƒ½å–å¾—æ¸…å–®", "error");
            document.getElementById('api-key').focus();
            return;
        }

        const btn = document.getElementById('refresh-btn');
        const originalText = btn.innerText;
        btn.innerText = "â³ è¼‰å…¥ä¸­...";
        btn.disabled = true;

        try {
            let newModels = [];

            if (pKey === 'openrouter') {
                const res = await fetch("https://openrouter.ai/api/v1/models");
                const data = await res.json();
                
                if (data.data && Array.isArray(data.data)) {
                    // æ’åºï¼šä¾ç…§å»ºç«‹æ™‚é–“ç”±æ–°åˆ°èˆŠ
                    newModels = data.data
                        .sort((a, b) => (b.created || 0) - (a.created || 0))
                        .map(m => m.id);
                }
            } 
            else if (pKey === 'groq') {
                const res = await fetch(conf.listUrl, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                const data = await res.json();
                if (data.data && Array.isArray(data.data)) {
                    newModels = data.data
                        .sort((a, b) => (b.created || 0) - (a.created || 0))
                        .map(m => m.id);
                }
            }
            else if (pKey === 'gemini') {
                const res = await fetch(conf.listUrl.replace('{KEY}', apiKey));
                const data = await res.json();
                if (data.models && Array.isArray(data.models)) {
                    newModels = data.models
                        .map(m => m.name.replace("models/", ""))
                        .filter(m => m.includes("gemini") && !m.includes("1.0"));
                    
                    const topModels = conf.models;
                    newModels = Array.from(new Set([...topModels, ...newModels]));
                }
            }

            if (newModels.length > 0) {
                updateModelSelect(newModels, newModels[0]); 
                currentActiveModelId = newModels[0];
                showStatus(`æ›´æ–°æˆåŠŸï¼šå…± ${newModels.length} å€‹æ¨¡å‹ (å·²æŒ‰æ—¥æœŸæ’åº)`);
            } else {
                showStatus("æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹", "error");
            }

        } catch (e) {
            console.error(e);
            showStatus(`æ›´æ–°å¤±æ•—: ${e.message}`, "error");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function handleModelSelectChange() {
        const select = document.getElementById('model-select');
        if (select.value === "CUSTOM_ENTRY") {
            document.getElementById('custom-model-wrapper').classList.remove('hidden');
            document.getElementById('custom-model-input').focus();
        } else {
            document.getElementById('custom-model-wrapper').classList.add('hidden');
            currentActiveModelId = select.value;
        }
    }

    function handleCustomInputChange() {
        currentActiveModelId = document.getElementById('custom-model-input').value.trim();
    }

    function saveSettings() {
        const pKey = document.getElementById('provider-select').value;
        if (document.getElementById('model-select').value === "CUSTOM_ENTRY") {
            currentActiveModelId = document.getElementById('custom-model-input').value.trim();
        } else {
            currentActiveModelId = document.getElementById('model-select').value;
        }
        localStorage.setItem(`${pKey}_key`, document.getElementById('api-key').value.trim());
        localStorage.setItem(`${pKey}_model`, currentActiveModelId);
        localStorage.setItem(`${pKey}_prompt`, document.getElementById('system-prompt').value);
        showStatus("è¨­å®šå·²å„²å­˜"); document.getElementById('settings-area').open = false;
    }

    function restoreDefaults() {
        const pKey = document.getElementById('provider-select').value;
        document.getElementById('system-prompt').value = PROVIDERS[pKey].prompt;
        localStorage.removeItem(`${pKey}_model`);
        handleProviderChange(true);
        showStatus("å·²æ¢å¾©é è¨­");
    }

    function showHelp() {
        const helpText = `
# å¿«é€Ÿèªªæ˜
1. **API è¨­å®š**ï¼šé¦–æ¬¡ä½¿ç”¨è«‹åˆ°ã€Œè¨­å®šã€è²¼ä¸Šæ‚¨çš„ API Key (Gemini/OpenRouter)ã€‚
2. **æ¨¡å‹æ›´æ–°**ï¼šé»æ“Šã€Œæ›´æ–°ã€æŒ‰éˆ•å¯æŠ“å–æœ€æ–°æ¨¡å‹ (å¦‚ Gemini Exp æˆ– Sonar Online)ã€‚
3. **è¯ç¶²æœå°‹**ï¼š
   - Gemini: å‹¾é¸å³å¯ã€‚
   - OpenRouter: è«‹é¸æ“‡æ”¯æ´æœå°‹çš„æ¨¡å‹ (å¦‚ perplexity/sonar-large-online) ä¸¦ç¢ºä¿ã€Œè¯ç¶²æœå°‹ã€å·²å‹¾é¸ã€‚
4. **æª”æ¡ˆä¸Šå‚³**ï¼šæ”¯æ´åœ–ç‰‡èˆ‡æ–‡å­—æª”ï¼Œç³»çµ±æœƒè‡ªå‹•è™•ç†ã€‚
`;
        addMessage('info', helpText);
    }

    function handleFileSelect() {
        const fileInput = document.getElementById('file-input');
        if (fileInput.files.length > 0) {
            selectedFile = fileInput.files[0];
            document.getElementById('upload-btn').innerText = `âœ… ${selectedFile.name}`;
            showStatus(`å·²é¸æ“‡: ${selectedFile.name}`);
            if (!document.getElementById('pause-send').checked) {
                setTimeout(() => document.querySelector('footer form').requestSubmit(), 500);
            }
        }
    }

    function copyResult() {
        const output = document.getElementById('chat-output');
        const text = output.innerText;
        navigator.clipboard.writeText(text).then(() => showStatus("å·²è¤‡è£½å…¨éƒ¨å…§å®¹"));
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const userInput = document.getElementById('user-input').value.trim();
        const pKey = document.getElementById('provider-select').value;
        
        if (!userInput && !selectedFile) {
            showStatus("è«‹è¼¸å…¥å…§å®¹", 'error'); return;
        }

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true; submitBtn.innerText = "ç™¼é€ä¸­";

        let displayMsg = userInput;
        if (selectedFile) displayMsg = `[æª”æ¡ˆ: ${selectedFile.name} (${selectedFile.type})] ${displayMsg}`;
        addMessage('user', displayMsg);

        try {
            let fileData = null;
            if (selectedFile) {
                fileData = await readFileAsBase64(selectedFile);
            }

            const response = await callAI(pKey, userInput, fileData, selectedFile ? selectedFile.type : null);
            addMessage('assistant', response);
            
            document.getElementById('user-input').value = "";
            selectedFile = null;
            document.getElementById('upload-btn').innerText = "ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)";
            document.getElementById('file-input').value = "";

        } catch (err) {
            console.error(err);
            addMessage('error', `API éŒ¯èª¤: ${err.message}`);
        } finally {
            submitBtn.disabled = false; submitBtn.innerText = "å‚³é€";
        }
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function callAI(provider, text, fileBase64, mimeType) {
        const apiKey = document.getElementById('api-key').value;
        const prompt = document.getElementById('system-prompt').value;
        const model = currentActiveModelId;
        const searchEnabled = document.getElementById('enable-search').checked;

        if (!apiKey) throw new Error("è«‹å…ˆè¼¸å…¥ API Key");

        let body = {};
        let url = "";
        let headers = { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}` 
        };

        const finalPrompt = prompt + "\nä½¿ç”¨è€…è¼¸å…¥: " + text;

        if (provider === 'gemini') {
            // Google Gemini Logic
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            delete headers['Authorization'];
            
            let parts = [{ text: finalPrompt }];
            if (fileBase64) {
                parts.unshift({
                    inline_data: { mime_type: mimeType, data: fileBase64 }
                });
            }
            
            body = {
                contents: [{ parts: parts }],
                tools: searchEnabled ? [{ google_search: {} }] : []
            };

        } else {
            // OpenAI / OpenRouter / Groq Logic
            if (provider === 'openrouter') {
                url = "https://openrouter.ai/api/v1/chat/completions";
                // OpenRouter å»ºè­°åŠ å…¥é€™äº› Header ä»¥ä¾¿æ”¯æ´å…è²»æ¨¡å‹èˆ‡çµ±è¨ˆ
                headers['HTTP-Referer'] = window.location.href;
                headers['X-Title'] = "AI Assistant Visually Impaired";
            }
            else if (provider === 'groq') {
                url = "https://api.groq.com/openai/v1/chat/completions";
            }
            else if (provider === 'openai') {
                url = "https://api.openai.com/v1/chat/completions";
            }
            else if (provider === 'perplexity') {
                url = "https://api.perplexity.ai/chat/completions";
            }

            // æ§‹å»º OpenAI æ ¼å¼çš„ Messages
            let messages = [
                { role: "system", content: prompt }
            ];

            let userContent = [];
            
            // è™•ç†åœ–ç‰‡ (OpenAI Vision æ ¼å¼)
            if (fileBase64) {
                userContent.push({ type: "text", text: text });
                userContent.push({
                    type: "image_url",
                    image_url: {
                        url: `data:${mimeType};base64,${fileBase64}`
                    }
                });
            } else {
                userContent = text; // ç´”æ–‡å­—
            }

            messages.push({ role: "user", content: userContent });

            body = {
                model: model,
                messages: messages,
                temperature: 0.7
            };
            
            // æ³¨æ„ï¼šä¸€èˆ¬ OpenAI ä»‹é¢ä¸æ”¯æ´ç›´æ¥é€éåƒæ•¸é–‹å•Ÿæœå°‹ï¼Œ
            // ä½†å¦‚æœé¸ç”¨äº† Perplexity/Sonar æ¨¡å‹ï¼Œå®ƒå€‘æœƒè‡ªå‹•æœå°‹ã€‚
            // å¦‚æœé¸ç”¨äº† OpenRouter ä¸Šçš„ Google æ¨¡å‹ï¼Œä¸”å¸Œæœ›å¼·åˆ¶å‚³å…¥ toolsï¼Œå¯åœ¨æ­¤æ“´å……ï¼Œ
            // ä½†ç›®å‰æœ€ç©©å®šçš„æ–¹å¼æ˜¯ä¾è³´æ¨¡å‹æœ¬èº«çš„èƒ½åŠ› (å¦‚ Sonar)ã€‚
        }

        const res = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        });

        const data = await res.json();
        
        if (!res.ok) {
            const errDetail = data.error ? (data.error.message || JSON.stringify(data.error)) : res.statusText;
            throw new Error(errDetail);
        }

        // è§£æå›æ‡‰
        if (provider === 'gemini') {
            if (data.candidates && data.candidates[0].content) {
                return data.candidates[0].content.parts.map(p => p.text).join('');
            }
        } else {
            // OpenAI Format
            if (data.choices && data.choices[0].message) {
                // è™•ç† DeepSeek æˆ–éƒ¨åˆ†æ¨¡å‹å¯èƒ½è¿”å›çš„ reasoning_content (æ€è€ƒéç¨‹)
                // é€™è£¡æˆ‘å€‘åªé¡¯ç¤ºæœ€çµ‚çµæœ
                return data.choices[0].message.content || "ç„¡å…§å®¹å›æ‡‰";
            }
        }
        
        return "ç„¡æ³•è§£æå›æ‡‰å…§å®¹";
    }
</script>
</body>
</html>
