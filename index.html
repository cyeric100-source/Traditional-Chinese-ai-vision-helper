<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (2025 è¨ºæ–·è¨˜éŒ„ç‰ˆ)</title>
    
    <!-- å¼•å…¥å¤–éƒ¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/lib/marked.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>

    <!-- ã€PDF æ ¸å¿ƒã€‘Fetch + Blob Worker æ–¹æ¡ˆ -->
    <script type="module">
        const PDF_VERSION = '5.4.449';
        const PDF_BASE = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDF_VERSION}/legacy/build/pdf.mjs`;
        const WORKER_URL = `https://cdn.jsdelivr.net/npm/pdfjs-dist@${PDF_VERSION}/legacy/build/pdf.worker.mjs`;

        window.initPdfSystem = async function() {
            Logger.info("æ­£åœ¨åˆå§‹åŒ– PDF æ ¸å¿ƒ...");
            try {
                const pdfjsLib = await import(PDF_BASE);
                window.pdfjsLib = pdfjsLib;

                // ä¸‹è¼‰ Worker ä¸¦è½‰ç‚º Blob
                Logger.info(`ä¸‹è¼‰ Worker: ${WORKER_URL}`);
                const response = await fetch(WORKER_URL);
                if (!response.ok) throw new Error(`Worker download failed: ${response.status}`);
                const workerScript = await response.text();
                const blob = new Blob([workerScript], { type: "application/javascript" });
                const blobUrl = URL.createObjectURL(blob);

                pdfjsLib.GlobalWorkerOptions.workerSrc = blobUrl;
                Logger.info("PDF æ ¸å¿ƒè¼‰å…¥æˆåŠŸ (Blob Mode)");
                
                window.dispatchEvent(new Event('pdfjs-loaded'));
            } catch (e) {
                Logger.error("PDF æ ¸å¿ƒè¼‰å…¥å¤±æ•—", e);
                alert("PDF æ ¸å¿ƒè¼‰å…¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è¨˜éŒ„æª”ã€‚");
            }
        };
        initPdfSystem();
    </script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --user-header-color: #0088ff;
            --ai-header-color: #FFFF00;
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --status-bg: #222;
            --tool-bg: #112233;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.2rem; line-height: 1.6;
            padding-top: 60px;
        }
        
        .container { max-width: 900px; margin: 0 auto; padding: 10px 10px 450px 10px; }
        .app-title { font-size: 1.5rem; text-align: center; margin: 10px 0; color: #ccc; font-weight: bold; }
        
        /* è¨˜éŒ„æª”å°ˆç”¨æ¨£å¼ */
        #debug-log-textarea {
            width: 100%; height: 200px; 
            background: #000; color: #00ff00; 
            font-family: monospace; font-size: 0.9rem;
            border: 1px solid #004400; padding: 10px;
            white-space: pre; overflow-x: auto;
            margin-bottom: 10px;
        }
        .debug-section {
            border: 2px solid #ff4444; background: #220000; 
            padding: 15px; margin-top: 20px; border-radius: 8px;
        }
        .debug-section h3 { color: #ff8888; margin-top: 0; }

        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }
        
        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; margin-top: 5px; cursor: pointer;
        }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        button.tool-btn { background-color: #0066cc; color: white; border: 2px solid #44aaff; }
        
        .message {
            background: #111; padding: 15px; margin-bottom: 25px;
            border-left: 5px solid var(--border-color);
        }
        .message.user { border-left-color: var(--user-header-color); background: #0a0a1a; }
        .message.assistant { border-left-color: var(--ai-header-color); background: #1a1a0a; }
        .message.error { border-left-color: #ff0000; background: #330000; }

        .markdown-body h1, .markdown-body h2 { color: #88CCFF; }
        
        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
        }
        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        
        #status-bar-container { position: fixed; top: 0; left: 0; right: 0; z-index: 2000; }
        #status-bar {
            background: #222; color: #fff; padding: 10px; text-align: center;
            font-weight: bold; border-bottom: 2px solid #555;
        }
        #status-bar.busy { background: #664400; border-bottom-color: #ffff00; }
        #status-bar.error { background: #660000; border-bottom-color: #ff0000; }
        
        .hidden { display: none !important; }
        details { border: 1px solid #555; padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #111; }
        summary { cursor: pointer; padding: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div id="status-bar-container">
    <div id="status-bar" role="status" aria-live="polite">ç³»çµ±å°±ç·’</div>
</div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (2025 è¨ºæ–·è¨˜éŒ„ç‰ˆ)</h1>

    <details id="settings-area" open>
        <summary>è¨­å®š & è¨ºæ–·æ—¥èªŒ (Settings & Debug Log)</summary>
        
        <div style="margin-top: 15px;">
            <label>ä¸»è¦æœå‹™å•† (Provider):</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (æ¨è–¦)</option>
                <option value="openrouter">OpenRouter (ä¸­è½‰)</option>
                <option value="openai">OpenAI</option>
                <option value="groq">Groq</option>
            </select>

            <label>API Key (éš±ç¢¼è™•ç†):</label>
            <input type="password" id="api-key" placeholder="API Key" onchange="Logger.info('API Key å·²æ›´æ–°')">
            
            <label>æ¨¡å‹ ID (Model):</label>
            <div class="row">
                <input type="text" id="model-input" placeholder="ä¾‹å¦‚: google/gemini-2.5-flash" onchange="saveSettings()">
                <button type="button" class="secondary" style="width:auto;" onclick="saveSettings()">å„²å­˜</button>
            </div>

            <div style="border:1px solid #444; padding:10px; margin:10px 0;">
                <strong>ç›®å‰åˆ†å·¥è¨­å®šï¼š</strong>
                <div class="row">
                    <button type="button" onclick="setSpecificConfig('ocr')">è¨­ç‚º OCR å°ˆç”¨</button>
                    <button type="button" onclick="setSpecificConfig('translate')">è¨­ç‚º ç¿»è­¯ å°ˆç”¨</button>
                    <button type="button" class="secondary" onclick="clearSpecificConfigs()">é‡ç½®</button>
                </div>
                <div id="config-status">é è¨­ï¼šè·Ÿéš¨ä¸»è¦è¨­å®š</div>
            </div>

            <!-- è¨ºæ–·è¨˜éŒ„å€ -->
            <div class="debug-section">
                <h3>ğŸ› ï¸ ç³»çµ±è¨ºæ–·è¨˜éŒ„ (Debug Log)</h3>
                <p style="font-size:0.9rem; color:#ccc;">
                    è‹¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹å°‡ä¸‹æ–¹å…§å®¹è¤‡è£½ä¸¦æä¾›çµ¦é–‹ç™¼è€…æª¢æŸ¥ã€‚
                </p>
                <textarea id="debug-log-textarea" readonly></textarea>
                <div class="row">
                    <button type="button" onclick="copyDebugLog()">è¤‡è£½å®Œæ•´è¨ºæ–·è¨˜éŒ„</button>
                    <button type="button" class="secondary" onclick="clearDebugLog()">æ¸…é™¤è¨˜éŒ„</button>
                </div>
            </div>
        </div>
    </details>

    <details class="pdf-tool-group" open>
        <summary>PDF æ™ºèƒ½é–±è®€å·¥å…·</summary>
        <div style="margin-top: 15px;">
            <input type="file" id="pdf-tool-input" class="hidden" accept="application/pdf" onchange="handlePDFToolFileSelect()">
            <button type="button" id="pdf-start-btn" class="tool-btn" onclick="document.getElementById('pdf-tool-input').click()" disabled>
                ğŸ“„ é¸æ“‡ PDF æª”æ¡ˆ (æ ¸å¿ƒè¼‰å…¥ä¸­...)
            </button>
            <div class="row" style="margin-top:10px;">
                <label><input type="checkbox" id="pdf-always-ai"> å¼·åˆ¶ AI è¾¨è­˜ (è·³éæ–‡å­—æå–)</label>
                <label><input type="checkbox" id="pdf-translate"> è‡ªå‹•ç¿»è­¯</label>
            </div>
        </div>
    </details>

    <main id="chat-output" style="min-height: 200px; padding-bottom: 20px;"></main>
</div>

<footer class="controls-wrapper">
    <form onsubmit="handleSubmit(event)">
        <div class="row">
            <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." rows="2"></textarea>
            <button type="submit" id="submit-btn" style="width: 80px;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // --- 1. å¼·å¤§çš„è¨˜éŒ„ç³»çµ± (Logger) ---
    const Logger = {
        entries: [],
        add: function(level, msg, data = null) {
            const time = new Date().toLocaleTimeString();
            let logStr = `[${time}] [${level}] ${msg}`;
            
            // å¦‚æœæœ‰è³‡æ–™ï¼Œå˜—è©¦åºåˆ—åŒ–ä½†è¦ä¿è­·æ•æ„Ÿè³‡è¨Š
            if (data) {
                try {
                    // æ·±æ‹·è²ä¸¦é®è”½ Key
                    let cleanData = JSON.parse(JSON.stringify(data));
                    if(cleanData.headers && cleanData.headers.Authorization) {
                        cleanData.headers.Authorization = "Bearer sk-****(MASKED)";
                    }
                    if(cleanData.body) {
                        const bodyObj = JSON.parse(cleanData.body);
                        // é¿å… Base64 å¡çˆ†è¨˜éŒ„æª”ï¼Œåªé¡¯ç¤ºé•·åº¦
                        if (bodyObj.messages) {
                            bodyObj.messages.forEach(m => {
                                if(Array.isArray(m.content)) {
                                    m.content.forEach(c => {
                                        if(c.image_url) c.image_url = `[Base64 Image Data, Length: ${c.image_url.url.length}]`;
                                        if(c.inline_data) c.inline_data.data = `[Base64 Data, Length: ${c.inline_data.data.length}]`;
                                    });
                                }
                            });
                        }
                        cleanData.body = JSON.stringify(bodyObj).substring(0, 500) + "...(truncated)";
                    }
                    logStr += `\nDATA: ${JSON.stringify(cleanData, null, 2)}`;
                } catch(e) {
                    logStr += `\nDATA (Parse Error): ${data}`;
                }
            }
            
            this.entries.push(logStr);
            console.log(logStr); // åŒæ­¥è¼¸å‡ºåˆ°æ§åˆ¶å°

            // æ›´æ–° UI
            const el = document.getElementById('debug-log-textarea');
            if(el) {
                el.value = this.entries.join('\n\n');
                el.scrollTop = el.scrollHeight;
            }
        },
        info: function(msg, data) { this.add('INFO', msg, data); },
        warn: function(msg, data) { this.add('WARN', msg, data); },
        error: function(msg, data) { this.add('ERROR', msg, data); },
        clear: function() { this.entries = []; document.getElementById('debug-log-textarea').value = ""; }
    };

    window.onerror = function(msg, source, line, col, error) {
        Logger.error(`Global Error: ${msg}`, { source, line, error });
    };

    function copyDebugLog() {
        const txt = document.getElementById('debug-log-textarea').value;
        navigator.clipboard.writeText(txt).then(() => alert("è¨ºæ–·è¨˜éŒ„å·²è¤‡è£½ï¼è«‹è²¼çµ¦é–‹ç™¼è€…ã€‚"));
    }
    function clearDebugLog() { Logger.clear(); }

    // --- 2. æ ¸å¿ƒé‚è¼¯è®Šæ•¸ ---
    const DEFAULT_SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä½è¦–éšœå”åŠ©åŠ©ç†ã€‚è«‹ç›´æ¥è¼¸å‡ºå…§å®¹ï¼Œä¸è¦è§£é‡‹æ€è€ƒéç¨‹ã€‚";
    let specificConfigs = { ocr: null, translate: null };

    // --- 3. åˆå§‹åŒ–èˆ‡è¨­å®š ---
    document.addEventListener('DOMContentLoaded', () => {
        Logger.info("ç¨‹å¼å•Ÿå‹• (v2025.12.15)");
        
        // è¼‰å…¥è¨­å®š
        const p = localStorage.getItem('provider') || 'gemini';
        document.getElementById('provider-select').value = p;
        document.getElementById('api-key').value = localStorage.getItem(`${p}_key`) || '';
        document.getElementById('model-input').value = localStorage.getItem(`${p}_model`) || getDefaultModel(p);
        
        const savedSpec = localStorage.getItem('specific_configs');
        if(savedSpec) {
            specificConfigs = JSON.parse(savedSpec);
            updateConfigDisplay();
        }
        
        Logger.info("è¨­å®šè¼‰å…¥å®Œæˆ", { provider: p, model: document.getElementById('model-input').value });
    });

    window.addEventListener('pdfjs-loaded', () => {
        document.getElementById('pdf-start-btn').innerText = "ğŸ“„ é¸æ“‡ PDF æª”æ¡ˆ (ç³»çµ±å°±ç·’)";
        document.getElementById('pdf-start-btn').disabled = false;
        Logger.info("PDF.js è¼‰å…¥äº‹ä»¶å·²æ¥æ”¶");
    });

    function getDefaultModel(provider) {
        const defaults = {
            'gemini': 'gemini-2.5-flash',
            'openrouter': 'google/gemini-2.5-flash', // æ¨è–¦è¨­ç‚º Gemini ä»¥é¿é–‹ Qwen çš„å•é¡Œ
            'openai': 'gpt-4o',
            'groq': 'llama-3.3-70b-versatile'
        };
        return defaults[provider] || '';
    }

    function handleProviderChange() {
        const p = document.getElementById('provider-select').value;
        document.getElementById('api-key').value = localStorage.getItem(`${p}_key`) || '';
        document.getElementById('model-input').value = localStorage.getItem(`${p}_model`) || getDefaultModel(p);
        Logger.info(`åˆ‡æ›æœå‹™å•†ç‚º: ${p}`);
    }

    function saveSettings() {
        const p = document.getElementById('provider-select').value;
        const k = document.getElementById('api-key').value;
        const m = document.getElementById('model-input').value;
        
        localStorage.setItem('provider', p);
        localStorage.setItem(`${p}_key`, k);
        localStorage.setItem(`${p}_model`, m);
        Logger.info("è¨­å®šå·²å„²å­˜", { provider: p, model: m });
        alert("è¨­å®šå·²å„²å­˜");
    }

    // --- 4. åˆ†å·¥è¨­å®š ---
    function setSpecificConfig(type) {
        const p = document.getElementById('provider-select').value;
        const m = document.getElementById('model-input').value;
        specificConfigs[type] = { provider: p, model: m };
        localStorage.setItem('specific_configs', JSON.stringify(specificConfigs));
        // å„²å­˜ç•¶ä¸‹çš„ Key åˆ°å°æ‡‰ Provider
        localStorage.setItem(`${p}_key`, document.getElementById('api-key').value);
        
        updateConfigDisplay();
        Logger.info(`å·²æŒ‡å®š ${type} ä»»å‹™ä½¿ç”¨: ${p} / ${m}`);
    }

    function clearSpecificConfigs() {
        specificConfigs = { ocr: null, translate: null };
        localStorage.removeItem('specific_configs');
        updateConfigDisplay();
        Logger.info("åˆ†å·¥è¨­å®šå·²é‡ç½®");
    }

    function updateConfigDisplay() {
        const div = document.getElementById('config-status');
        let html = "";
        if(specificConfigs.ocr) html += `OCR: ${specificConfigs.ocr.provider}/${specificConfigs.ocr.model} | `;
        if(specificConfigs.translate) html += `Trans: ${specificConfigs.translate.provider}/${specificConfigs.translate.model}`;
        div.innerHTML = html || "é è¨­ï¼šè·Ÿéš¨ä¸»è¦è¨­å®š";
    }

    // --- 5. PDF è™•ç† (å«è©³ç´°è¨˜éŒ„) ---
    function handlePDFToolFileSelect() {
        const file = document.getElementById('pdf-tool-input').files[0];
        if(file) processPDF(file);
    }

    async function processPDF(file) {
        Logger.info(`é–‹å§‹è™•ç† PDF: ${file.name}, Size: ${file.size} bytes`);
        document.getElementById('chat-output').innerHTML = "";
        updateStatus("æ­£åœ¨è®€å– PDF...", "busy");

        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer, cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@5.4.449/cmaps/', cMapPacked: true }).promise;
            
            const totalPages = pdf.numPages;
            Logger.info(`PDF è¼‰å…¥æˆåŠŸï¼Œå…± ${totalPages} é `);
            
            let fullText = "";
            const alwaysAI = document.getElementById('pdf-always-ai').checked;
            const needTranslate = document.getElementById('pdf-translate').checked;

            // æ±ºå®š OCR æ¨¡å‹
            let ocrProv = specificConfigs.ocr ? specificConfigs.ocr.provider : document.getElementById('provider-select').value;
            let ocrMod = specificConfigs.ocr ? specificConfigs.ocr.model : document.getElementById('model-input').value;
            let ocrKey = localStorage.getItem(`${ocrProv}_key`);
            
            Logger.info(`OCR è¨­å®š -> Provider: ${ocrProv}, Model: ${ocrMod}`);

            if(!alwaysAI) {
                Logger.info("å˜—è©¦æå–ç´”æ–‡å­—...");
                try {
                    let extracted = "";
                    for(let i=1; i<=totalPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        extracted += content.items.map(item => item.str).join(" ") + "\n";
                    }
                    if(extracted.replace(/\s/g, '').length > 50) {
                        Logger.info("ç´”æ–‡å­—æå–æˆåŠŸ (é•·åº¦ > 50)");
                        fullText = extracted;
                    } else {
                        Logger.warn("ç´”æ–‡å­—éå°‘ï¼Œåˆ‡æ›è‡³ åœ–åƒ OCR æ¨¡å¼");
                    }
                } catch(e) { Logger.warn("æå–ç´”æ–‡å­—å¤±æ•—", e); }
            }

            if(!fullText) {
                Logger.info("é€²å…¥åœ–åƒ OCR æ¨¡å¼ (é€é æˆªåœ–)");
                for(let i=1; i<=totalPages; i++) {
                    updateStatus(`OCR è­˜åˆ¥ä¸­: ç¬¬ ${i}/${totalPages} é `, "busy");
                    
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 }); // 1.5 å€ç‡å…¼é¡§é€Ÿåº¦èˆ‡æ¸…æ™°åº¦
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport }).promise;

                    // ç©ºç™½æª¢æŸ¥
                    if(isCanvasBlank(canvas)) {
                        Logger.info(`ç¬¬ ${i} é è¢«æª¢æ¸¬ç‚ºç©ºç™½ï¼Œè·³é`);
                        fullText += `[ç¬¬ ${i} é : ç©ºç™½]\n`;
                        continue;
                    }

                    const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                    Logger.info(`ç¬¬ ${i} é æˆªåœ–å®Œæˆï¼ŒBase64 é•·åº¦: ${base64.length}`);

                    try {
                        const res = await callAI(ocrProv, ocrMod, ocrKey, "Transcribe the text in this image exactly.", base64);
                        Logger.info(`ç¬¬ ${i} é  OCR æˆåŠŸ`, { responseSnippet: res.substring(0, 50) });
                        fullText += `## Page ${i}\n${res}\n\n`;
                    } catch(err) {
                        Logger.error(`ç¬¬ ${i} é  OCR å¤±æ•—`, err);
                        fullText += `## Page ${i}\n(OCR å¤±æ•—: ${err.message})\n\n`;
                    }
                }
            }

            // é¡¯ç¤ºæˆ–ç¿»è­¯
            if(needTranslate) {
                Logger.info("é–‹å§‹ç¿»è­¯å…¨æ–‡...");
                updateStatus("æ­£åœ¨ç¿»è­¯...", "busy");
                let transProv = specificConfigs.translate ? specificConfigs.translate.provider : document.getElementById('provider-select').value;
                let transMod = specificConfigs.translate ? specificConfigs.translate.model : document.getElementById('model-input').value;
                let transKey = localStorage.getItem(`${transProv}_key`);
                
                const transRes = await callAI(transProv, transMod, transKey, `Translate the following content to Traditional Chinese (Hong Kong style):\n\n${fullText}`);
                addMessage('assistant', transRes);
            } else {
                addMessage('assistant', fullText);
            }

            updateStatus("è™•ç†å®Œæˆ", "ready");
            Logger.info("ä»»å‹™å…¨éƒ¨å®Œæˆ");

        } catch(e) {
            Logger.error("PDF è™•ç†æµç¨‹å´©æ½°", e);
            updateStatus("éŒ¯èª¤ (è«‹æŸ¥çœ‹è¨˜éŒ„æª”)", "error");
            alert("è™•ç†å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹è¨˜éŒ„æª”ã€‚");
        }
    }

    // --- 6. AI å‘¼å«æ ¸å¿ƒ (å«è©³ç´°è¨˜éŒ„) ---
    async function callAI(provider, model, key, prompt, imageBase64 = null) {
        if(!key) throw new Error("ç¼ºå°‘ API Key");
        
        Logger.info(`æº–å‚™å‘¼å« AI API: ${provider} / ${model}`);
        
        let url = "", headers = {}, body = {};
        headers['Authorization'] = `Bearer ${key}`;
        headers['Content-Type'] = 'application/json';

        if(provider === 'gemini') {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
            delete headers['Authorization']; // Gemini ç”¨ URL param
            
            let parts = [];
            if(imageBase64) {
                parts.push({ inline_data: { mime_type: "image/jpeg", data: imageBase64 } });
            }
            parts.push({ text: prompt });
            body = { contents: [{ parts: parts }] };
        
        } else {
            // OpenAI / OpenRouter / Groq æ ¼å¼
            if(provider === 'openrouter') {
                url = "https://openrouter.ai/api/v1/chat/completions";
                headers['HTTP-Referer'] = window.location.href;
                headers['X-Title'] = 'AI Vision Helper Debugger';
            } else if(provider === 'openai') {
                url = "https://api.openai.com/v1/chat/completions";
            } else if(provider === 'groq') {
                url = "https://api.groq.com/openai/v1/chat/completions";
            }

            let content = [];
            if(imageBase64) {
                content.push({ type: "text", text: prompt });
                content.push({ type: "image_url", image_url: { url: `data:image/jpeg;base64,${imageBase64}` } });
            } else {
                content = prompt;
            }

            body = {
                model: model,
                messages: [
                    { role: "system", content: DEFAULT_SYSTEM_PROMPT },
                    { role: "user", content: content }
                ],
                temperature: 0.3
            };
        }

        // è¨˜éŒ„è«‹æ±‚å…§å®¹ (Logger æœƒè‡ªå‹•æˆªæ–·éé•·çš„ Base64)
        Logger.info("ç™¼é€è«‹æ±‚", { url, method: 'POST', body: JSON.stringify(body), headers });

        const response = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
        });

        // è®€å–åŸå§‹å›æ‡‰æ–‡å­—ä»¥ä¾¿åµéŒ¯
        const rawText = await response.text();
        Logger.info(`æ”¶åˆ°å›æ‡‰ Status: ${response.status}`, { rawResponseSnippet: rawText.substring(0, 1000) });

        if(!response.ok) {
            throw new Error(`API Error ${response.status}: ${rawText}`);
        }

        try {
            const data = JSON.parse(rawText);
            let resultText = "";
            
            if(provider === 'gemini') {
                resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
            } else {
                resultText = data.choices?.[0]?.message?.content;
            }

            if(!resultText) throw new Error("å›æ‡‰ä¸­æ²’æœ‰æ–‡å­—å…§å®¹ (Empty Response)");
            return resultText;

        } catch(e) {
            throw new Error(`è§£æå›æ‡‰å¤±æ•—: ${e.message}`);
        }
    }

    // --- è¼”åŠ©å‡½å¼ ---
    function isCanvasBlank(canvas) {
        const ctx = canvas.getContext('2d');
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
        // ç°¡å–®æŠ½æ¨£æª¢æŸ¥ï¼šè‹¥æœ‰ä»»ä½•éç™½è‰²/é€æ˜åƒç´ ï¼Œå‰‡è¦–ç‚ºæœ‰å…§å®¹
        for(let i=0; i<data.length; i+=400) { // æ¯ 100 åƒç´ æŠ½æ¨£ä¸€æ¬¡
            if(data[i] < 250 || data[i+1] < 250 || data[i+2] < 250) return false;
        }
        return true;
    }

    function updateStatus(msg, type) {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.className = type;
    }

    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `message ${role}`;
        div.innerHTML = marked.parse(text);
        document.getElementById('chat-output').appendChild(div);
    }

    function handleSubmit(e) {
        e.preventDefault();
        const txt = document.getElementById('user-input').value;
        if(!txt) return;
        
        document.getElementById('user-input').value = "";
        addMessage('user', txt);
        updateStatus("æ€è€ƒä¸­...", "busy");
        
        const p = document.getElementById('provider-select').value;
        const m = document.getElementById('model-input').value;
        const k = localStorage.getItem(`${p}_key`);

        callAI(p, m, k, txt).then(res => {
            addMessage('assistant', res);
            updateStatus("å°±ç·’", "ready");
        }).catch(err => {
            Logger.error("å°è©±å¤±æ•—", err);
            addMessage('error', `éŒ¯èª¤: ${err.message}`);
            updateStatus("éŒ¯èª¤", "error");
        });
    }

</script>
</body>
</html>
