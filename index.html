<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;     /* é»ƒè‰²é«˜äº® */
            --border-color: #555555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --section-bg: #111;
        }

        body {
            font-family: system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.15rem; line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 350px 10px; /* åº•éƒ¨ç•™ç™½çµ¦æ§åˆ¶åˆ— */
        }

        /* æ¨™é¡Œæ¨£å¼ (æ–¹ä¾¿è®€å±å°èˆª) */
        h1, h2, h3 { color: var(--accent-color); margin-top: 20px; outline: none; }
        h1 { font-size: 1.8rem; border-bottom: 2px solid #333; padding-bottom: 10px; }
        h2 { font-size: 1.4rem; background: #222; padding: 5px 10px; border-radius: 4px; }

        /* è¼¸å…¥èˆ‡äº’å‹•å…ƒä»¶ */
        *:focus-visible {
            outline: 4px solid var(--accent-color) !important;
            outline-offset: 2px;
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem;
            border-radius: 6px; box-sizing: border-box;
        }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            border-radius: 8px; margin-top: 5px;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        
        /* è¨­å®šå€åŸŸ */
        details {
            border: 1px solid var(--border-color); padding: 10px;
            border-radius: 8px; margin-bottom: 20px;
        }
        summary { cursor: pointer; font-size: 1.2rem; font-weight: bold; list-style: none; }
        
        /* è¨Šæ¯é¡¯ç¤ºå€ */
        .message-area { min-height: 100px; }
        .message {
            background: #111; padding: 15px; margin-bottom: 15px;
            border-left: 5px solid var(--accent-color);
            overflow-wrap: break-word;
        }
        .message.user { border-left-color: #0088ff; background: #0a0a1a; }
        .message.error { border-left-color: #ff0000; background: #300; }

        /* åº•éƒ¨å›ºå®šæ§åˆ¶å€ */
        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
        }

        .row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .flex-1 { flex: 1; }
        
        /* Checkbox æ¨£å¼å„ªåŒ– */
        .check-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; border-radius: 6px; cursor: pointer; flex: 1;
        }
        .check-btn input { width: 20px; height: 20px; margin-right: 8px; margin-top: 0; }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; }

        /* Markdown æ¨£å¼ */
        .markdown-body p { margin-bottom: 10px; }
        .markdown-body ul { padding-left: 20px; }
        .markdown-body a { color: var(--link-color); }
    </style>
</head>
<body>

<div class="container">
    <h1 tabindex="-1">AI è¦–éšœåŠ©ç†</h1>

    <!-- å€åŸŸ 1: è¨­å®š -->
    <details id="settings-area">
        <summary role="button" accesskey="s">
            <h2>âš™ï¸ è¨­å®š (Alt+S)</h2>
        </summary>
        
        <label for="provider-select">æœå‹™å•†:</label>
        <select id="provider-select" onchange="handleProviderChange()">
            <option value="gemini">Google Gemini (æ¨è–¦)</option>
            <option value="openrouter">OpenRouter (æ•´åˆ)</option>
            <option value="groq">Groq (æ¥µé€Ÿ)</option>
            <option value="openai">OpenAI (ä»˜è²»)</option>
            <option value="mistral">Mistral (æ­æ´²)</option>
            <option value="perplexity">Perplexity (æœå°‹)</option>
        </select>

        <label for="api-key" style="margin-top:10px; display:block;">API Key:</label>
        <input type="password" id="api-key" placeholder="è¼¸å…¥é‡‘é‘°" autocomplete="off">
        
        <label for="model-input" style="margin-top:10px; display:block;">æ¨¡å‹ ID:</label>
        <div class="row" style="margin-top:0;">
            <input type="text" id="model-input" list="model-list" placeholder="é¸æ“‡æˆ–è¼¸å…¥ ID">
            <datalist id="model-list"></datalist>
            <!-- åƒ…åœ¨æ”¯æ´çš„æœå‹™å•†é¡¯ç¤º -->
            <button type="button" id="refresh-btn" class="secondary" style="width: auto;" onclick="fetchOnlineModels()" title="å¾ç¶²è·¯æ›´æ–°">ğŸ”„</button>
        </div>

        <label for="system-prompt" style="margin-top:10px; display:block;">è§’è‰²è¨­å®š:</label>
        <textarea id="system-prompt" rows="3"></textarea>

        <div class="row">
            <button type="button" onclick="saveSettings()">ğŸ’¾ å„²å­˜</button>
            <button type="button" onclick="restoreDefaults()" class="secondary">â†©ï¸ æ¢å¾©é è¨­</button>
        </div>
    </details>

    <!-- å€åŸŸ 2: çµæœé¡¯ç¤º -->
    <main>
        <h2 id="result-heading" tabindex="-1">å°è©±çµæœ</h2>
        <div id="chat-output" class="message-area" role="log" aria-live="polite"></div>
        
        <!-- è¤‡è£½æŒ‰éˆ•ï¼šé è¨­éš±è—ï¼Œæœ‰çµæœæ‰é¡¯ç¤º -->
        <button type="button" id="copy-btn" class="secondary hidden" onclick="copyResult()" accesskey="c" style="width:100%; margin-bottom: 20px;">
            ğŸ“‹ è¤‡è£½çµæœ (Alt+C)
        </button>
    </main>
</div>

<!-- å€åŸŸ 3: åº•éƒ¨æ§åˆ¶åˆ— -->
<footer class="controls-wrapper">
    <form onsubmit="handleSubmit(event)">
        <!-- åŠŸèƒ½é–‹é—œèˆ‡ä¸Šå‚³ -->
        <div class="row">
            <label class="check-btn">
                <input type="checkbox" id="enable-search" checked>
                <span>è¯ç¶²</span>
            </label>
            
            <label class="check-btn">
                <input type="checkbox" id="pause-send">
                <span>æš«åœå‚³é€</span>
            </label>
        </div>

        <div class="row">
            <input type="file" id="file-input" class="visually-hidden" accept="image/*,application/pdf,text/plain" onchange="handleFileSelect()">
            <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u">
                ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)
            </button>
        </div>
        
        <!-- æ–‡å­—è¼¸å…¥ -->
        <div class="row">
            <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." accesskey="i" autocomplete="off">
            <button type="submit" id="submit-btn" style="width: 80px;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // === 1. æ¨¡å‹è³‡æ–™åº« (å…§å»ºæ¸…å–®) ===
    const PROVIDERS = {
        gemini: {
            prompt: "è«‹è­˜åˆ¥åœ–ç‰‡æ–‡å­—(OCR)ã€æè¿°ç´°ç¯€æˆ–ç¸½çµæ–‡ä»¶ã€‚",
            defaultModel: "gemini-2.0-flash-exp",
            canFetch: true,
            models: ["gemini-2.0-flash-exp", "gemini-1.5-pro", "gemini-1.5-flash", "gemini-exp-1206"],
            listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}"
        },
        openrouter: {
            prompt: "è«‹æ ¹æ“šæ¨¡å‹å¼·é …æä¾›å”åŠ©ã€‚",
            defaultModel: "qwen/qwen-2.5-vl-72b-instruct:free",
            canFetch: true,
            models: ["qwen/qwen-2.5-vl-72b-instruct:free", "google/gemini-2.0-flash-exp:free", "meta-llama/llama-3.2-90b-vision-instruct", "openai/gpt-4o"],
            listUrl: "https://openrouter.ai/api/v1/models"
        },
        groq: {
            prompt: "è«‹ç°¡æ½”æè¿°åœ–ç‰‡å…§å®¹ã€‚",
            defaultModel: "llama-3.2-90b-vision-preview",
            canFetch: false,
            models: ["llama-3.2-90b-vision-preview", "llama-3.3-70b-versatile", "mixtral-8x7b-32768"]
        },
        openai: {
            prompt: "è«‹æä¾›ç´°è†©çš„è¦–è¦ºæè¿°ã€‚",
            defaultModel: "gpt-4o",
            canFetch: false,
            models: ["gpt-4o", "gpt-4o-mini", "o1-preview"]
        },
        mistral: {
            prompt: "è«‹è­˜åˆ¥æ–‡å­—èˆ‡çµæ§‹ã€‚",
            defaultModel: "pixtral-large-latest",
            canFetch: false,
            models: ["pixtral-large-latest", "pixtral-12b-2409"]
        },
        perplexity: {
            prompt: "è«‹æä¾›æœ€æ–°æœå°‹è³‡è¨Šã€‚",
            defaultModel: "sonar-pro",
            canFetch: false,
            models: ["sonar-pro", "sonar", "sonar-reasoning"]
        }
    };

    // === 2. åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
        // é¦–æ¬¡åŸ·è¡Œè‡ªå‹•å±•é–‹è¨­å®š
        const hasRun = localStorage.getItem('app_init');
        if (!hasRun) {
            document.getElementById('settings-area').open = true;
            localStorage.setItem('app_init', 'true');
        }

        // è¼‰å…¥ä¸Šæ¬¡è¨­å®š
        const savedProvider = localStorage.getItem('provider') || 'gemini';
        document.getElementById('provider-select').value = savedProvider;
        handleProviderChange(false);
    });

    // === 3. è¨­å®šé‚è¼¯ ===
    function handleProviderChange(save = true) {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];

        // è¼‰å…¥è©²æœå‹™å•†çš„è¨­å®š (è‹¥ç„¡å‰‡ç”¨é è¨­å€¼)
        document.getElementById('api-key').value = localStorage.getItem(`${pKey}_key`) || "";
        document.getElementById('model-input').value = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        document.getElementById('system-prompt').value = localStorage.getItem(`${pKey}_prompt`) || conf.prompt;

        // é‡å»ºæ¨¡å‹æ¸…å–® (è§£æ±ºå•é¡Œ 1ï¼šç›´æ¥åˆ—å‡ºæ¸…å–®)
        const dataList = document.getElementById('model-list');
        dataList.innerHTML = "";
        conf.models.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m;
            dataList.appendChild(opt);
        });

        // æ§åˆ¶ "è¯ç¶²æœå°‹" èˆ‡ "æ›´æ–°æŒ‰éˆ•" é¡¯ç¤º
        const searchCheck = document.getElementById('enable-search');
        if (pKey === 'gemini' || pKey === 'perplexity') {
            searchCheck.disabled = false;
            if(pKey === 'gemini') searchCheck.checked = true;
        } else {
            searchCheck.disabled = true;
            searchCheck.checked = false;
        }

        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.style.display = conf.canFetch ? 'block' : 'none';

        if (save) localStorage.setItem('provider', pKey);
    }

    function saveSettings() {
        const pKey = document.getElementById('provider-select').value;
        localStorage.setItem(`${pKey}_key`, document.getElementById('api-key').value.trim());
        localStorage.setItem(`${pKey}_model`, document.getElementById('model-input').value.trim());
        localStorage.setItem(`${pKey}_prompt`, document.getElementById('system-prompt').value);
        alert("è¨­å®šå·²å„²å­˜");
    }

    function restoreDefaults() {
        const pKey = document.getElementById('provider-select').value;
        document.getElementById('system-prompt').value = PROVIDERS[pKey].prompt;
    }

    // === 4. åŠŸèƒ½é‚è¼¯ ===
    
    // è¤‡è£½çµæœ (è§£æ±ºå•é¡Œ 2)
    function copyResult() {
        const msgs = document.querySelectorAll('.message:not(.user):not(.error)');
        if (msgs.length === 0) return;
        
        const text = msgs[msgs.length - 1].innerText;
        navigator.clipboard.writeText(text).then(() => {
            alert("å·²è¤‡è£½");
        }).catch(() => alert("è¤‡è£½å¤±æ•—"));
    }

    // æª”æ¡ˆé¸æ“‡
    function handleFileSelect() {
        const file = document.getElementById('file-input').files[0];
        if (file) {
            document.getElementById('upload-btn').innerText = `âœ… ${file.name}`;
            // è‹¥æœªå‹¾é¸æš«åœï¼Œå‰‡è‡ªå‹•å‚³é€
            if (!document.getElementById('pause-send').checked) {
                setTimeout(() => document.getElementById('submit-btn').click(), 200);
            }
        }
    }

    // æ›´æ–°æ¨¡å‹æ¸…å–® (åƒ…é™æ”¯æ´çš„æœå‹™å•†)
    async function fetchOnlineModels() {
        const pKey = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value;
        const conf = PROVIDERS[pKey];

        if (!key && pKey !== 'gemini') { alert("éœ€è¼¸å…¥ API Key"); return; }
        
        const btn = document.getElementById('refresh-btn');
        btn.innerText = "â³";
        
        try {
            let newModels = [];
            if (pKey === 'gemini') {
                const res = await fetch(conf.listUrl.replace('{KEY}', key));
                const data = await res.json();
                newModels = (data.models || []).map(m => m.name.replace("models/", ""));
            } else if (pKey === 'openrouter') {
                const res = await fetch(conf.listUrl); // OpenRouter å…¶å¯¦ä¸éœ€è¦ Key ä¹Ÿèƒ½æŠ“åˆ—è¡¨
                const data = await res.json();
                newModels = (data.data || []).map(m => m.id);
            }

            if (newModels.length > 0) {
                // æ›´æ–° datalist
                const dataList = document.getElementById('model-list');
                dataList.innerHTML = ""; // æ¸…ç©ºèˆŠçš„
                // åˆä½µæ–°èˆŠä¸¦å»é‡
                const allModels = Array.from(new Set([...conf.models, ...newModels]));
                allModels.forEach(m => {
                    let opt = document.createElement('option');
                    opt.value = m;
                    dataList.appendChild(opt);
                });
                alert(`æ›´æ–°æˆåŠŸï¼Œæ‰¾åˆ° ${newModels.length} å€‹æ¨¡å‹`);
            }
        } catch (e) {
            alert("æ›´æ–°å¤±æ•—: " + e.message);
        } finally {
            btn.innerText = "ğŸ”„";
        }
    }

    // === 5. å°è©±æ ¸å¿ƒ ===
    async function handleSubmit(e) {
        e.preventDefault();
        const pKey = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('model-input').value;
        const prompt = document.getElementById('system-prompt').value;
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const output = document.getElementById('chat-output');
        const submitBtn = document.getElementById('submit-btn');

        if (!key) { alert("è«‹è¼¸å…¥ API Key"); document.getElementById('settings-area').open = true; return; }
        if (!userInput.value && !fileInput.files[0]) return;

        submitBtn.disabled = true;
        submitBtn.innerText = "è™•ç†ä¸­...";

        // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        const userText = userInput.value || (fileInput.files[0] ? "åˆ†æåœ–ç‰‡..." : "...");
        output.innerHTML = `<div class="message user">${safeHtml(userText)}</div>`; // æ¸…é™¤èˆŠçµæœåªç•™æœ€æ–°? ä¸ï¼Œé€™è£¡ä¿ç•™æ­·å²æ¯”è¼ƒå¥½ï¼Œä½†ç‚ºäº†ç°¡å–®ï¼Œæ¯æ¬¡ append
        
        const responseDiv = document.createElement('div');
        responseDiv.className = 'message';
        responseDiv.innerText = "æ€è€ƒä¸­...";
        output.appendChild(responseDiv);
        
        // éš±è—è¤‡è£½æŒ‰éˆ• (ç›´åˆ°å®Œæˆ)
        document.getElementById('copy-btn').classList.add('hidden');
        window.scrollTo(0, document.body.scrollHeight);

        try {
            let base64 = null, mime = null;
            if (fileInput.files[0]) {
                base64 = await toBase64(fileInput.files[0]);
                mime = fileInput.files[0].type;
            }

            // å‘¼å« API
            let text = "";
            const textPrompt = userInput.value || "è«‹è©³ç´°æè¿°å…§å®¹";

            if (pKey === 'gemini') {
                text = await callGemini(key, model, prompt, textPrompt, base64, mime);
            } else {
                text = await callOpenAICompatible(pKey, key, model, prompt, textPrompt, base64, mime);
            }

            // æ¸²æŸ“çµæœ
            responseDiv.innerHTML = marked.parse(text);
            responseDiv.classList.add('markdown-body');
            
            // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
            document.getElementById('copy-btn').classList.remove('hidden');

            // é‡ç½®è¼¸å…¥
            userInput.value = "";
            fileInput.value = "";
            document.getElementById('upload-btn').innerText = "ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)";

        } catch (err) {
            responseDiv.className = 'message error';
            responseDiv.innerText = "éŒ¯èª¤: " + err.message;
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "å‚³é€";
            window.scrollTo(0, document.body.scrollHeight);
            // è®“è®€å±è»Ÿé«”èšç„¦æ¨™é¡Œï¼Œæç¤ºæœ‰æ–°å…§å®¹
            document.getElementById('result-heading').focus();
        }
    }

    // API å¯¦ä½œ
    async function callGemini(key, model, sys, user, b64, mime) {
        const useSearch = document.getElementById('enable-search').checked;
        const parts = [{text: sys + "\n\n" + user}];
        if (b64) parts.push({inline_data: {mime_type: mime, data: b64}});

        const body = { contents: [{ parts }], generationConfig: { temperature: 0.7 } };
        if (useSearch) body.tools = [{googleSearch: {}}];

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "API Error");
        
        let txt = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        const chunks = data.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
        if (chunks.length > 0) txt += "\n\n**ä¾†æº:**\n" + chunks.map((c,i) => c.web ? `${i+1}. [${c.web.title}](${c.web.uri})` : "").join("\n");
        return txt;
    }

    async function callOpenAICompatible(provider, key, model, sys, user, b64, mime) {
        let url = PROVIDERS[provider].listUrl; // hacky way to get base url
        if (provider === 'openrouter') url = "https://openrouter.ai/api/v1";
        else if (provider === 'groq') url = "https://api.groq.com/openai/v1";
        else if (provider === 'openai') url = "https://api.openai.com/v1";
        else if (provider === 'mistral') url = "https://api.mistral.ai/v1";
        else if (provider === 'perplexity') url = "https://api.perplexity.ai";

        if (mime === 'application/pdf') throw new Error("æ­¤æ¨¡å¼ä¸æ”¯æ´ PDFï¼Œè«‹ç”¨ Geminiã€‚");

        const content = [{type: "text", text: user}];
        if (b64) content.push({type: "image_url", image_url: {url: `data:${mime};base64,${b64}`}});
        
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
        if (provider === 'openrouter') { headers['HTTP-Referer'] = location.href; headers['X-Title'] = 'Visual Assistant'; }

        const res = await fetch(`${url}/chat/completions`, {
            method: 'POST', headers,
            body: JSON.stringify({ model, messages: [{role:"system", content:sys}, {role:"user", content}], temperature: 0.7 })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || JSON.stringify(data));
        return data.choices[0].message.content;
    }

    // å·¥å…·å‡½å¼
    function toBase64(file) {
        return new Promise((r, j) => {
            const reader = new FileReader();
            reader.onload = () => r(reader.result.split(',')[1]);
            reader.onerror = j;
            reader.readAsDataURL(file);
        });
    }
    function safeHtml(t) { return t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
</script>

</body>
</html>
