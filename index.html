<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (æ¥µç°¡å…¨èƒ½ç‰ˆ - 2025)</title>
    
    <!-- å¼•å…¥ Marked.js è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <!-- å¼•å…¥ DOMPurify é€²è¡Œ HTML æ¶ˆæ¯’ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <!-- ã€æ ¸å¿ƒä¿®æ­£ã€‘PDF.js v4.10.38 æ¨¡çµ„åŒ–è¼‰å…¥ä¸¦æ›è¼‰è‡³å…¨åŸŸ -->
    <script type="module">
        import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.mjs';
        
        // è¨­å®š Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.mjs';
        
        // å°‡ pdfjsLib æ›è¼‰åˆ° windowï¼Œè®“ä¸‹æ–¹çš„ä¸€èˆ¬ script å¯ä»¥å‘¼å«
        window.pdfjsLib = pdfjsLib;
        
        console.log("PDF.js v4.10.38 module loaded and exposed to window.");
    </script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;      /* é»ƒè‰²é«˜äº® */
            --user-header-color: #0088ff; /* ç”¨æˆ¶æ¨™é¡Œè‰² */
            --ai-header-color: #FFFF00;   /* AI æ¨™é¡Œè‰² */
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --status-bg: #222;
            --tool-bg: #112233;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.2rem; line-height: 1.6;
            padding-top: 60px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 450px 10px;
        }

        .app-title { 
            font-size: 1.5rem; text-align: center; margin: 10px 0; color: #ccc; font-weight: bold;
        }
        
        details h2 { 
            font-size: 1.4rem; color: #ccc; 
            border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 10px; 
            display: inline-block;
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; border-radius: 6px; box-sizing: border-box;
        }

        #system-prompt {
            min-height: 300px;
            resize: vertical;
            overflow-y: auto;
            font-family: monospace;
            line-height: 1.4;
        }
        
        *:focus-visible { outline: 4px solid var(--accent-color) !important; }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px; font-size: 1.1rem; font-weight: bold;
            border-radius: 8px; margin-top: 5px; cursor: pointer; touch-action: manipulation;
        }
        button:disabled { filter: grayscale(100%); opacity: 0.7; cursor: not-allowed; }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        
        button.mini-copy-btn {
            background-color: #333; color: #fff; border: 1px solid #777;
            padding: 6px 12px; font-size: 0.9rem; margin-top: 10px;
            width: auto; display: inline-block;
        }
        button.mini-copy-btn:hover { background-color: #555; }
        
        button.danger {
            background-color: #550000; color: #ffcccc; border-color: #ff4444;
        }

        button.tool-btn {
            background-color: #0066cc; color: white; border: 2px solid #44aaff;
        }

        button.recording {
            background-color: #ff0000 !important; color: #ffffff !important; animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        details { border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; margin-bottom: 10px; background: #111; }
        summary { cursor: pointer; padding: 5px; }
        
        .pdf-tool-group {
            background: var(--tool-bg); border: 2px solid #005588;
        }
        .pdf-tool-group h2 { color: #88ccff; border-bottom-color: #005588; }
        
        .message-area { min-height: 100px; padding-bottom: 20px; }
        
        .message {
            background: #111; padding: 15px; margin-bottom: 25px;
            border-left: 5px solid var(--border-color);
            overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;
        }
        .message:focus { outline: none; border-left: 8px solid var(--accent-color); background: #222; }

        .message h1.msg-heading {
            font-size: 1.4rem; margin: 0 0 10px 0; padding-bottom: 5px;
            border-bottom: 1px dashed #444; line-height: 1.3;
        }

        .message.user { border-left-color: var(--user-header-color); background: #0a0a1a; }
        .message.user h1.msg-heading { color: var(--user-header-color); }
        
        .message.assistant { border-left-color: var(--ai-header-color); background: #1a1a0a; }
        .message.assistant h1.msg-heading { color: var(--ai-header-color); }

        .message.error { border-left-color: #ff0000; background: #330000; }
        .message.error h1.msg-heading { color: #ff5555; }

        .markdown-body { line-height: 1.7; overflow-wrap: break-word; }
        .markdown-body h1, .markdown-body h2 { color: #88CCFF; border-bottom: none; margin-top: 1.5em; }
        .markdown-body p { margin-bottom: 10px; white-space: pre-wrap; } 
        .markdown-body pre { 
            background: #222; padding: 10px; overflow-x: auto; 
            border: 1px solid #444; white-space: pre; 
        }
        .markdown-body code { background: #333; padding: 2px 4px; word-break: break-all; }

        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
        }

        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-end; }
        
        .check-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; border-radius: 6px; flex: 1;
            cursor: pointer; margin-top: 5px;
            height: auto; min-height: 52px;
        }
        .check-btn input { width: 20px; height: 20px; margin: 0 8px 0 0; }

        #user-input {
            margin: 0; min-height: 80px; max-height: 200px;
            resize: vertical; overflow-y: auto; flex: 1;
            transition: border-color 0.2s;
        }
        #user-input.dragover { border-color: var(--accent-color) !important; background-color: #222; }

        #status-bar {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--status-bg); color: #fff;
            padding: 10px; text-align: center;
            font-weight: bold; font-size: 1.1rem;
            z-index: 2000; border-bottom: 2px solid var(--border-color);
            transition: background-color 0.3s;
        }
        #status-bar.ready { background: #004400; border-bottom-color: #00ff00; }
        #status-bar.busy { background: #664400; border-bottom-color: #ffff00; }
        #status-bar.error { background: #660000; border-bottom-color: #ff0000; }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        
        #custom-model-wrapper { margin-top: -5px; margin-bottom: 10px; }
        .settings-subsection { border: 1px solid #444; padding: 10px; border-radius: 6px; margin: 10px 0; background: #222; }
        .settings-subsection h3 { margin: 0 0 10px 0; font-size: 1.1rem; color: var(--accent-color); }
        .export-actions { margin-bottom: 20px; display: flex; gap: 10px; }
    </style>
</head>
<body>

<!-- ç‹€æ…‹åˆ— -->
<div id="status-bar" role="status" aria-live="polite" aria-atomic="true" tabindex="-1">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (æ¥µç°¡å…¨èƒ½ç‰ˆ - 2025)</h1>

    <!-- è¨­å®šå€ -->
    <details id="settings-area">
        <summary role="button" aria-expanded="false" id="settings-summary" aria-keyshortcuts="Alt+Shift+S">
            <h2>è¨­å®š (Alt+Shift+S)</h2>
        </summary>
        
        <div style="margin-top: 15px;">
            <label for="provider-select">ä¸»è¦ AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (æ¨è–¦)</option>
                <option value="openrouter">OpenRouter (å¤šæ¨¡å‹ - æ”¯æ´ CORS)</option>
                <option value="mistral">Mistral AI</option>
                <option value="openai">OpenAI (GPT)</option>
                <option value="groq">Groq</option>
                <option value="perplexity">Perplexity</option>
            </select>

            <label for="api-key">ä¸»è¦ API Key:</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" autocomplete="off">
            
            <label for="model-filter-input">ç¯©é¸æ¨¡å‹ (å³æ™‚æœå°‹):</label>
            <input type="text" id="model-filter-input" placeholder="è¼¸å…¥é—œéµå­—ç¯©é¸ (å¦‚: gemini, latest)..." oninput="handleModelFilter()">

            <label for="model-select">æ¨¡å‹é¸æ“‡ (2025æœ€æ–°):</label>
            <div class="row" style="margin-bottom: 10px;">
                <select id="model-select" style="margin-bottom:0;" onchange="handleModelSelectChange()"></select>
                <button type="button" id="refresh-btn" class="secondary" style="width: auto; margin-top:0;" onclick="fetchOnlineModels()" title="å¾ç¶²è·¯æ›´æ–°æ¨¡å‹æ¸…å–®">æ›´æ–°æ¨¡å‹æ¸…å–®</button>
            </div>
            
            <div id="custom-model-wrapper" class="hidden">
                <input type="text" id="custom-model-input" placeholder="æ‰‹å‹•è¼¸å…¥æ¨¡å‹ ID" onchange="handleCustomInputChange()">
            </div>

            <div id="openrouter-settings" class="hidden settings-subsection">
                <h3>OpenRouter æœå°‹è¨­å®š</h3>
                <label class="check-btn">
                    <input type="checkbox" id="openrouter-web-search">
                    <span>å•Ÿç”¨è¯ç¶²æœå°‹ (Web Search)</span>
                </label>
            </div>
            
            <label class="check-btn" style="flex:none; width:auto; margin-bottom: 10px;">
                <input type="checkbox" id="enter-to-send" checked>
                <span>æŒ‰ Enter éµå‚³é€ (å–æ¶ˆå‹¾é¸å‰‡ Enter ç‚ºæ›è¡Œ)</span>
            </label>

            <div class="settings-subsection">
                <h3>èªéŸ³è¼¸å…¥è¨­å®š</h3>
                <label for="voice-engine">èªéŸ³è¾¨è­˜å¼•æ“:</label>
                <select id="voice-engine" onchange="saveVoiceSettings()">
                    <option value="browser">ç€è¦½å™¨åŸç”Ÿ (å…è²»ï¼Œå“è³ªæ™®é€š)</option>
                    <option value="openai">OpenAI Whisper (é«˜æº–ç¢ºï¼Œéœ€ä»˜è²»)</option>
                    <option value="groq">Groq Whisper (æ¥µé€Ÿï¼Œéœ€ Key)</option>
                </select>
                <label for="voice-api-key">èªéŸ³è¾¨è­˜å°ˆç”¨ API Key (é¸å¡«):</label>
                <input type="password" id="voice-api-key" placeholder="è‹¥ç•™ç©ºï¼Œå°‡å˜—è©¦ä½¿ç”¨ä¸»è¦ API Key" autocomplete="off" onchange="saveVoiceSettings()">
            </div>

            <label for="timeout-setting">å›æ‡‰é€¾æ™‚ (ç§’):</label>
            <input type="number" id="timeout-setting" value="120" min="5" step="5">

            <label for="system-prompt">è§’è‰²æŒ‡ä»¤:</label>
            <textarea id="system-prompt" placeholder="åœ¨æ­¤è¼¸å…¥ç³»çµ±æŒ‡ä»¤..."></textarea>

            <div class="row">
                <button type="button" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
                <button type="button" onclick="restoreDefaults()" class="secondary">æ¢å¾©é è¨­å€¼</button>
                <button type="button" onclick="showHelp()" class="secondary" style="background:#004488; color:white;">åŠŸèƒ½èªªæ˜</button>
            </div>
        </div>
    </details>

    <!-- PDF å®Œæ•´é–±è®€å·¥å…·ç®± -->
    <details class="pdf-tool-group" open>
        <summary role="button" aria-expanded="true">
            <h2>PDF æ™ºèƒ½é–±è®€å·¥å…·ç®± (OCR & ç¿»è­¯)</h2>
        </summary>
        <div style="margin-top: 15px;">
            <input type="file" id="pdf-tool-input" class="visually-hidden" accept="application/pdf" onchange="handlePDFToolFileSelect()">

            <!-- æ§åˆ¶é … A -->
            <button type="button" class="tool-btn" onclick="document.getElementById('pdf-tool-input').click()">
                ğŸ“„ PDF å®Œæ•´é–±è®€ (æ™ºèƒ½åµæ¸¬å•Ÿå‹•)
            </button>
            <small style="display:block; margin: 5px 0 15px 0; color:#ccc;">
                * èªªæ˜ï¼šå„ªå…ˆä½¿ç”¨æœ¬æ©Ÿæå–ï¼ˆæ”¯æ´ç¹/ç°¡/æ—¥/éŸ“/è‹±ï¼‰ã€‚è‹¥å¤±æ•—ï¼Œå°‡è‡ªå‹•è½‰æˆåœ–ç‰‡å‚³çµ¦ AI (Gemini/OpenRouter) é€²è¡Œå®Œæ•´ OCRã€‚
            </small>

            <div class="row">
                <!-- æ§åˆ¶é … B -->
                <label class="check-btn">
                    <input type="checkbox" id="pdf-always-ai">
                    <span>ç¸½æ˜¯å°‡ PDF å‚³çµ¦ AI (è·³éæœ¬æ©Ÿæå–)</span>
                </label>

                <!-- æ§åˆ¶é … C -->
                <label class="check-btn">
                    <input type="checkbox" id="pdf-translate">
                    <span>å¼·åˆ¶ç¿»è­¯æˆç¹é«”ä¸­æ–‡ (ä¸åˆªæ¸›å…§å®¹)</span>
                </label>
            </div>
        </div>
    </details>

    <!-- çµæœå€ -->
    <main role="main">
        <div id="chat-output" class="message-area"></div>
        
        <div class="export-actions">
            <button type="button" id="copy-btn" class="secondary hidden" onclick="copyResult()" aria-keyshortcuts="Alt+Shift+C" style="flex:1;">
                è¤‡è£½ (Alt+Shift+C)
            </button>
            <button type="button" id="export-txt-btn" class="secondary hidden" onclick="exportChat('txt')" aria-keyshortcuts="Alt+Shift+T" style="flex:1;">
                åŒ¯å‡º TXT (Alt+Shift+T)
            </button>
            <button type="button" id="export-html-btn" class="secondary hidden" onclick="exportChat('html')" aria-keyshortcuts="Alt+Shift+H" style="flex:1;">
                åŒ¯å‡º HTML (Alt+Shift+H)
            </button>
        </div>
    </main>
</div>

<!-- æ§åˆ¶å€ -->
<footer class="controls-wrapper" role="region" aria-label="æ“ä½œå€">
    <form onsubmit="handleSubmit(event)">
        <div class="row">
            <input type="file" id="file-input" class="visually-hidden" accept="*/*" onchange="handleFileSelect()">
            
            <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()" aria-keyshortcuts="Alt+Shift+U" style="flex:1;">
                é¸æ“‡æª”æ¡ˆ (Alt+Shift+U)
            </button>
            
            <button type="button" id="new-chat-btn" class="danger" onclick="resetConversation()" aria-keyshortcuts="Alt+Shift+N" style="flex:1;">
                æ¸…é™¤å°è©± (Alt+Shift+N)
            </button>

            <label class="check-btn" style="flex:1;">
                <input type="checkbox" id="pause-send" aria-keyshortcuts="Alt+Shift+P">
                <span>æš«åœå‚³é€ (Alt+Shift+P)</span>
            </label>
        </div>
        
        <div class="row">
            <button type="button" id="voice-btn" class="secondary" onclick="toggleVoiceInput()" aria-keyshortcuts="Alt+Shift+V" style="width: auto; padding: 0 15px; height: 80px; margin:0; font-size: 1.2rem;" title="èªéŸ³è¼¸å…¥ (Alt+Shift+V)" aria-label="èªéŸ³è¼¸å…¥ (Alt+Shift+V)">èªéŸ³è¼¸å…¥</button>
            
            <textarea id="user-input" placeholder="è¼¸å…¥è¨Šæ¯... (å¯æ‹–æ”¾æª”æ¡ˆæˆ– Ctrl+V)" aria-keyshortcuts="Alt+Shift+I" autocomplete="off" rows="3" aria-label="è¼¸å…¥è¨Šæ¯å€"></textarea>
            
            <button type="submit" id="submit-btn" aria-keyshortcuts="Alt+Shift+K" style="width: 80px; height: 80px; margin:0;" title="ç™¼é€ (Alt+Shift+K)">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // å…¨åŸŸéŒ¯èª¤æ•æ‰
    window.onerror = function(message, source, lineno, colno, error) {
        const statusBar = document.getElementById('status-bar');
        if (statusBar) {
            statusBar.innerText = `ç™¼ç”ŸéŒ¯èª¤: ${message}`;
            statusBar.className = 'error';
            statusBar.setAttribute('aria-live', 'assertive');
        }
        console.error("Global Error:", message, error);
    };

    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š (Persona)
ä½ æ˜¯ä¸€ä½å°ˆç‚ºé¦™æ¸¯è¦–éšœäººå£«æœå‹™çš„é ‚å°– AI è¦–è¦ºèˆ‡è³‡è¨ŠåŠ©ç†ã€‚ä½ çš„æ ¸å¿ƒè·è²¬æ˜¯æˆç‚ºç”¨æˆ¶çš„çœ¼ç›èˆ‡å¤§è…¦å»¶ä¼¸ã€‚

# å…¨åŸŸè¦å‰‡ (Global Rules)
1. **èªè¨€**ï¼šç¹é«”ä¸­æ–‡ï¼ˆé¦™æ¸¯æ…£ç”¨ï¼‰ã€‚
2. **ç„¡éšœç¤™æ ¼å¼**ï¼šä½¿ç”¨ Markdown æ¨™é¡Œ (#) èˆ‡æ¸…å–® (-)ï¼Œä¸ä½¿ç”¨å¹²æ“¾æœ—è®€çš„ç¬¦è™Ÿã€‚
3. **ç²¾ç°¡**ï¼šé‡é»ç½®å‰ï¼Œé¿å…å†—é•·ã€‚
`;

    const PDF_OCR_PROMPT = `
# SYSTEM INSTRUCTION: HIGH-PRECISION OCR MODE

## ROLE
You are a specialized OCR (Optical Character Recognition) engine. You are NOT a conversational assistant.

## MISSION
Transcribe every single visible word from the provided document images into raw text.

## STRICT EXECUTION RULES (MUST FOLLOW)
1. **VERBATIM TRANSCRIPTION**: Output the text EXACTLY as it appears. Do NOT correct grammar. Do NOT summarize. Do NOT skip any sections.
2. **FULL COMPLETENESS**: Transcribe headers, footers, page numbers, side notes, legal disclaimers, and tables.
3. **FORMATTING**: Use natural newlines to separate paragraphs. Preserve layout structure using Markdown.
4. **NO CONVERSATIONAL FILLER**: Do NOT say "Here is the text" or "Sure". Output ONLY the transcribed content.
5. **UNCERTAINTY**: If text is absolutely illegible, write \`[ILLEGIBLE]\`. Do NOT guess.

## INPUT-OUTPUT AGREEMENT
Input: [Images of PDF Pages]
Output: [Raw String of Text Only]
`;

    const PDF_TRANSLATE_PROMPT = `
# SYSTEM INSTRUCTION: PROFESSIONAL DOCUMENT TRANSLATION

## ROLE
You are a professional document translator specializing in Traditional Chinese (Hong Kong usage).

## MISSION
Translate the provided source content FULLY and ACCURATELY into Traditional Chinese.

## STRICT EXECUTION RULES (MUST FOLLOW)
1. **100% COMPLETENESS**: Translate every single sentence, header, footer, page number, and number. Do NOT summarize. Do NOT omit any paragraph.
2. **ACCURACY**: Preserve the original meaning, tone, and legal implications.
3. **STRUCTURE**: Maintain the original paragraph structure and layout logic.
4. **OUTPUT FORMAT**: Output ONLY the translated text. Do NOT include the original text unless explicitly asked. Do NOT add conversational filler like "Here is the translation".

## INPUT-OUTPUT AGREEMENT
Input: [Source Text/Document Images]
Output: [Translated Text in Traditional Chinese (HK)]
`;

    const PROMPT_VERSION_KEY = "prompt_version_2025_fixed_v16_pdf_final_fix";
    
    const PROVIDERS = {
        gemini: { prompt: DEFAULT_PROMPT, defaultModel: "gemini-2.5-flash", canFetch: true, listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}", models: ["gemini-2.5-flash", "gemini-1.5-flash", "gemini-1.5-pro"] },
        openrouter: { prompt: DEFAULT_PROMPT, defaultModel: "openai/gpt-4o", canFetch: true, listUrl: "https://openrouter.ai/api/v1/models", models: ["openai/gpt-4o", "google/gemini-2.5-flash", "google/gemini-flash-1.5", "anthropic/claude-3.5-sonnet"] },
        mistral: { prompt: DEFAULT_PROMPT, defaultModel: "mistral-large-latest", canFetch: true, listUrl: "https://api.mistral.ai/v1/models", models: ["mistral-large-latest"] },
        openai: { prompt: DEFAULT_PROMPT, defaultModel: "gpt-4o", canFetch: true, listUrl: "https://api.openai.com/v1/models", models: ["gpt-4o"] },
        groq: { prompt: DEFAULT_PROMPT, defaultModel: "llama-3.3-70b-versatile", canFetch: true, listUrl: "https://api.groq.com/openai/v1/models", models: ["llama-3.3-70b-versatile"] },
        perplexity: { prompt: DEFAULT_PROMPT, defaultModel: "sonar-pro", canFetch: false, models: ["sonar-pro"] }
    };

    let currentActiveModelId = "";
    let selectedFile = null;
    let recognition = null; 
    let mediaRecorder = null;
    let audioChunks = [];
    let chatHistory = [];
    let audioContext = null;
    let allCurrentModels = [];

    function unlockAudioContext() {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
            audioContext.resume().then(() => {
                document.removeEventListener('click', unlockAudioContext);
                document.removeEventListener('touchstart', unlockAudioContext);
            });
        }
    }
    document.addEventListener('click', unlockAudioContext);
    document.addEventListener('touchstart', unlockAudioContext);
    document.addEventListener('keydown', handleGlobalShortcuts);

    function handleGlobalShortcuts(e) {
        if (!e.altKey || !e.shiftKey) return;
        const key = e.key.toLowerCase();
        const actions = {
            's': { id: 'settings-summary', type: 'click' },
            'c': { id: 'copy-btn', type: 'click' },
            't': { id: 'export-txt-btn', type: 'click' },
            'h': { id: 'export-html-btn', type: 'click' },
            'u': { id: 'upload-btn', type: 'click' },
            'n': { id: 'new-chat-btn', type: 'click' },
            'p': { id: 'pause-send', type: 'click' },
            'v': { id: 'voice-btn', type: 'click' },
            'k': { id: 'submit-btn', type: 'click' },
            'i': { id: 'user-input', type: 'focus' },
            'r': { selector: '.latest-copy-btn', type: 'click' }
        };

        if (actions[key]) {
            e.preventDefault();
            let target;
            if (actions[key].id) target = document.getElementById(actions[key].id);
            else if (actions[key].selector) target = document.querySelector(actions[key].selector);
            if (target) {
                if (actions[key].type === 'click') target.click();
                else if (actions[key].type === 'focus') target.focus();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            if (!localStorage.getItem(PROMPT_VERSION_KEY)) {
                ['gemini', 'openrouter', 'openai', 'groq', 'perplexity', 'mistral'].forEach(p => localStorage.removeItem(`${p}_prompt`));
                localStorage.setItem(PROMPT_VERSION_KEY, 'true');
            }

            const savedProvider = localStorage.getItem('provider');
            const settingsDetails = document.getElementById('settings-area');
            const savedTimeout = localStorage.getItem('timeout_setting');
            if (savedTimeout) document.getElementById('timeout-setting').value = savedTimeout;
            
            document.getElementById('openrouter-web-search').checked = (localStorage.getItem('openrouter_web_search') === 'true');
            const savedVoiceEngine = localStorage.getItem('voice_engine');
            if (savedVoiceEngine) document.getElementById('voice-engine').value = savedVoiceEngine;
            const savedVoiceKey = localStorage.getItem('voice_api_key');
            if (savedVoiceKey) document.getElementById('voice-api-key').value = savedVoiceKey;
            
            const savedEnter = localStorage.getItem('enter_to_send');
            document.getElementById('enter-to-send').checked = (savedEnter === null || savedEnter === 'true');

            if (savedProvider && PROVIDERS[savedProvider]) {
                document.getElementById('provider-select').value = savedProvider;
                settingsDetails.open = false; 
            } else {
                document.getElementById('provider-select').value = 'gemini'; 
                settingsDetails.open = true; 
            }
            
            handleProviderChange(false); 
            initVoiceSystem();
            initPasteImage();
            initDragAndDrop();
            initEnterKey();

        } catch (e) {
            updateStatusBar("åˆå§‹åŒ–éŒ¯èª¤: " + e.message, "error");
        } finally {
            setTimeout(showReadyStatus, 500);
        }
    });

    function playAudioCue(type) {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        const now = audioContext.currentTime;
        if (type === 'start') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(660, now); gainNode.gain.setValueAtTime(0.1, now); oscillator.start(now); oscillator.stop(now + 0.1); } 
        else if (type === 'success') { oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(440, now); oscillator.frequency.exponentialRampToValueAtTime(880, now + 0.15); gainNode.gain.setValueAtTime(0.1, now); oscillator.start(now); oscillator.stop(now + 0.2); } 
        else if (type === 'error') { oscillator.type = 'sawtooth'; oscillator.frequency.setValueAtTime(150, now); gainNode.gain.setValueAtTime(0.15, now); oscillator.start(now); oscillator.stop(now + 0.4); }
    }

    function resetConversation() {
        chatHistory = []; 
        document.getElementById('chat-output').innerHTML = ""; 
        document.getElementById('user-input').value = "";
        selectedFile = null;
        document.getElementById('upload-btn').innerText = "é¸æ“‡æª”æ¡ˆ (Alt+Shift+U)";
        document.getElementById('file-input').value = "";
        toggleExportButtons(false);
        showTransientStatus("å°è©±ç´€éŒ„å·²æ¸…é™¤ (æ–°å°è©±)", "info");
    }

    function handlePDFToolFileSelect() {
        const input = document.getElementById('pdf-tool-input');
        if (input.files.length > 0) {
            processPDFTool(input.files[0]);
            document.getElementById('status-bar').focus(); 
        }
        input.value = ""; 
    }

    async function processPDFTool(file) {
        // å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ PDF.js å·²è¼‰å…¥
        if (typeof window.pdfjsLib === 'undefined') {
            // ç¨ç­‰ 1 ç§’å†è©¦ä¸€æ¬¡ (å¯èƒ½æ¨¡çµ„å‰›è¼‰å…¥)
            await new Promise(r => setTimeout(r, 1000));
            if (typeof window.pdfjsLib === 'undefined') {
                 alert("PDF å…ƒä»¶å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚");
                 return;
            }
        }

        if (!file || file.type !== 'application/pdf') { alert("è«‹é¸æ“‡ PDF æª”æ¡ˆ"); return; }
        resetConversation(); playAudioCue('start');
        
        const alwaysAI = document.getElementById('pdf-always-ai').checked;
        const forceTranslate = document.getElementById('pdf-translate').checked;

        try {
            // æƒ…å¢ƒ A: ä½¿ç”¨è€…å¼·åˆ¶è¦æ±‚ AI è™•ç†
            if (alwaysAI) {
                updateStatusBar("æ­£åœ¨å°‡ PDF è½‰ç‚ºåœ–ç‰‡ä»¥é€²è¡Œ AI å®Œæ•´è¾¨è­˜...", "busy");
                const images = await convertPdfToImages(file);
                await performAIProcessing(images, forceTranslate ? "translate_only" : "ocr_strict", null);
                return;
            }

            // æƒ…å¢ƒ B: å˜—è©¦æœ¬æ©Ÿæå– (æ”¯æ´å¤šåœ‹èªè¨€ CJK)
            updateStatusBar("æ­£åœ¨å˜—è©¦æœ¬æ©Ÿæå–æ–‡å­— (æ”¯æ´å¤šåœ‹èªè¨€)...", "busy");
            const localText = await extractTextFromPDF(file, true); 

            // åˆ¤æ–·æå–çµæœæ˜¯å¦æœ‰æ•ˆ (éæ¿¾ç´”ç©ºç™½æˆ–æ¥µçŸ­å…§å®¹)
            const charCount = localText ? localText.replace(/\s/g, '').length : 0;

            if (charCount > 20) {
                if (forceTranslate) {
                    updateStatusBar("æœ¬æ©Ÿæå–æˆåŠŸï¼Œæ­£åœ¨å‚³é€çµ¦ AI é€²è¡Œå®Œæ•´ç¿»è­¯...", "busy");
                    await performAIProcessing(null, "translate_text", localText);
                } else {
                    updateStatusBar("æœ¬æ©Ÿæå–å®Œæˆ", "ready");
                    addMessage('assistant', localText);
                    playAudioCue('success');
                    const output = document.getElementById('chat-output');
                    output.lastChild.focus();
                }
            } else {
                updateStatusBar(`æœ¬æ©Ÿæå–æ–‡å­—éå°‘ (${charCount} å­—)ï¼Œè½‰ç‚ºåœ–ç‰‡æ¨¡å¼äº¤ç”± AI è­˜åˆ¥...`, "busy");
                const images = await convertPdfToImages(file);
                await performAIProcessing(images, forceTranslate ? "translate_only" : "ocr_strict", null);
            }
        } catch (e) {
            console.error(e); updateStatusBar("PDF è™•ç†éŒ¯èª¤: " + e.message, "error"); playAudioCue('error'); addMessage('error', "PDF è™•ç†å¤±æ•—: " + e.message);
        }
    }

    // å°‡ PDF è½‰ç‚ºåœ–ç‰‡é™£åˆ— (è§£æ±º OpenRouter ä¸æ”¯æ´ PDF æª”æ¡ˆçš„å•é¡Œ)
    async function convertPdfToImages(file) {
        const arrayBuffer = await file.arrayBuffer();
        
        // ä¿®æ­£ï¼šæŒ‡å‘æ­£ç¢ºçš„ CDN è·¯å¾‘ (v4.10.38)
        const cMapUrl = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/cmaps/';
        const standardFontDataUrl = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/standard_fonts/';
        
        const loadingTask = window.pdfjsLib.getDocument({
            data: arrayBuffer,
            cMapUrl: cMapUrl,
            cMapPacked: true,
            standardFontDataUrl: standardFontDataUrl
        });
        
        const pdf = await loadingTask.promise;
        const maxPages = pdf.numPages;
        const images = [];
        
        const limit = Math.min(maxPages, 15); 

        for (let i = 1; i <= limit; i++) {
            updateStatusBar(`æ­£åœ¨æ¸²æŸ“ PDF é é¢ (${i}/${limit})...`, 'busy');
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport: viewport }).promise;
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            images.push(dataUrl.split(',')[1]); 
        }
        return images;
    }

    async function performAIProcessing(inputData, mode, textData) {
        let targetProvider = document.getElementById('provider-select').value;
        let targetApiKey = document.getElementById('api-key').value;
        let targetModel = currentActiveModelId;

        const isImageArray = Array.isArray(inputData);

        if (isImageArray) {
            targetProvider = 'gemini';
            const storedGeminiKey = localStorage.getItem('gemini_key');
            if (document.getElementById('provider-select').value === 'gemini') targetApiKey = document.getElementById('api-key').value;
            else if (storedGeminiKey) targetApiKey = storedGeminiKey;
            
            if (!targetApiKey) {
                if (document.getElementById('provider-select').value === 'openrouter') {
                    targetProvider = 'openrouter';
                    targetApiKey = document.getElementById('api-key').value;
                    targetModel = "google/gemini-2.5-flash"; 
                } else {
                    throw new Error("è™•ç†åœ–åƒç‰ˆ PDF å¿…é ˆä½¿ç”¨ Google Geminiã€‚è«‹åˆ‡æ›è‡³ 'Google Gemini' æˆ– 'OpenRouter' ä¸¦è¼¸å…¥ API Keyã€‚");
                }
            } else {
                targetModel = "gemini-2.5-flash";
            }
        }
        if (!targetApiKey) throw new Error("è«‹å…ˆè¨­å®š API Key");
        
        let systemPrompt = mode === "ocr_strict" ? PDF_OCR_PROMPT : (mode === "translate_only" || mode === "translate_text" ? PDF_TRANSLATE_PROMPT : DEFAULT_PROMPT);
        const controller = new AbortController(); 
        
        let userText = "";
        if (mode === "translate_text") userText = `[SOURCE TEXT TO TRANSLATE]:\n${textData}`;
        else if (isImageArray) userText = "Please process these document images according to the strict system rules.";
        else userText = "Please process this request.";

        let filePayload = isImageArray ? inputData : null; 
        let mimeType = isImageArray ? "image/jpeg" : null;

        const originalPromptVal = document.getElementById('system-prompt').value;
        document.getElementById('system-prompt').value = systemPrompt; 

        try {
            chatHistory = []; 
            const response = await callAI(targetProvider, userText, filePayload, mimeType, controller.signal, targetModel, targetApiKey);
            addMessage('assistant', response); playAudioCue('success'); updateStatusBar("è™•ç†å®Œæˆ", "ready");
            document.getElementById('chat-output').lastChild.focus();
        } catch (e) {
            if (e.message.includes("Failed to fetch") && targetProvider === 'gemini') {
                throw new Error("Google æ‹’çµ•ç€è¦½å™¨ç›´æ¥é€£ç·š (CORS éŒ¯èª¤)ã€‚\nè«‹æ”¹ç”¨ 'OpenRouter' æœå‹™å•† (å®ƒæ”¯æ´ Gemini æ¨¡å‹ä¸”å…è¨±ç€è¦½å™¨é€£ç·š)ã€‚");
            } else {
                throw e;
            }
        } finally {
            document.getElementById('system-prompt').value = originalPromptVal;
        }
    }

    async function extractTextFromPDF(file, reportProgress = false) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            
            // ã€æ ¸å¿ƒä¿®æ­£ã€‘æŒ‡å®š CMap èˆ‡ StandardFonts
            const cMapUrl = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/cmaps/';
            const standardFontDataUrl = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/standard_fonts/';
            
            const loadingTask = window.pdfjsLib.getDocument({
                data: arrayBuffer,
                cMapUrl: cMapUrl, 
                cMapPacked: true,
                standardFontDataUrl: standardFontDataUrl
            });

            const pdf = await loadingTask.promise;
            let fullText = "";
            const maxPages = pdf.numPages;
            
            for (let i = 1; i <= maxPages; i++) {
                if (reportProgress) updateStatusBar(`æ­£åœ¨æå–æ–‡å­— (ç¬¬ ${i} / ${maxPages} é )...`, "busy");
                
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                let pageStr = "";
                let lastItemStr = "";
                
                for (const item of textContent.items) {
                    const str = item.str;
                    if (!str) continue;

                    // ã€æ’ç‰ˆå„ªåŒ–ã€‘ï¼šä¸­æ—¥éŸ“ (CJK) å­—ç¬¦é–“ä¸åŠ ç©ºæ ¼
                    const isCurrentCJK = /[\u4e00-\u9fa5\u3040-\u30ff\uac00-\ud7af]/.test(str[0]);
                    const isLastCJK = lastItemStr ? /[\u4e00-\u9fa5\u3040-\u30ff\uac00-\ud7af]/.test(lastItemStr.slice(-1)) : false;
                    
                    if (lastItemStr && !item.hasEOL) {
                        if (!isLastCJK && !isCurrentCJK) {
                            pageStr += " ";
                        }
                    }
                    
                    pageStr += str;
                    if (item.hasEOL) pageStr += "\n";
                    lastItemStr = str;
                }

                if (pageStr.trim().length > 0) {
                    fullText += `[ç¬¬ ${i} é ]\n${pageStr}\n\n`;
                }
            }
            return fullText.trim();
        } catch (e) {
            console.error("PDF extract error", e);
            return null; 
        }
    }

    // ----------------- é€šç”¨åŠŸèƒ½ -----------------

    function initVoiceSystem() {
        const engine = document.getElementById('voice-engine').value;
        if (engine === 'browser') initBrowserSpeech(); else if (recognition) { recognition.stop(); recognition = null; }
    }
    function initBrowserSpeech() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition(); recognition.lang = 'zh-HK'; recognition.continuous = false; recognition.interimResults = true; 
            recognition.onstart = () => { document.getElementById('voice-btn').classList.add('recording'); showTransientStatus('æ­£åœ¨è†è½...', 'info'); playAudioCue('start'); };
            recognition.onresult = (e) => {
                let t = ''; for (let i = e.resultIndex; i < e.results.length; ++i) if (e.results[i].isFinal) t += e.results[i][0].transcript;
                if (t) document.getElementById('user-input').value += (document.getElementById('user-input').value ? " " : "") + t;
            };
            recognition.onerror = (e) => { showTransientStatus('èªéŸ³: ' + e.error, 'error'); playAudioCue('error'); stopVoiceInput(); };
            recognition.onend = stopVoiceInput;
        }
    }
    async function toggleVoiceInput() {
        const engine = document.getElementById('voice-engine').value;
        const btn = document.getElementById('voice-btn');
        if (btn.classList.contains('recording')) {
            if (engine === 'browser' && recognition) recognition.stop();
            else if (mediaRecorder && mediaRecorder.state !== 'inactive') { mediaRecorder.stop(); btn.classList.remove('recording', 'processing'); showTransientStatus('æ­£åœ¨è™•ç†...', 'busy'); }
            return;
        }
        if (engine === 'browser') recognition ? recognition.start() : null;
        else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = []; mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => { await processWhisperAudio(new Blob(audioChunks, {type: mediaRecorder.mimeType}), engine, mediaRecorder.mimeType); stream.getTracks().forEach(t=>t.stop()); };
                mediaRecorder.start(); btn.classList.add('recording'); showTransientStatus('éŒ„éŸ³ä¸­...', 'info'); playAudioCue('start');
            } catch (e) { showTransientStatus('éº¥å…‹é¢¨éŒ¯èª¤', 'error'); playAudioCue('error'); }
        }
    }
    async function processWhisperAudio(blob, engine, mime) {
        let apiKey = document.getElementById('voice-api-key').value || document.getElementById('api-key').value;
        if (!apiKey) return alert("éœ€ API Key");
        const fd = new FormData(); fd.append('file', blob, `rec.${mime.includes('mp4')?'mp4':'webm'}`);
        fd.append('model', engine === 'openai' ? 'whisper-1' : 'whisper-large-v3');
        try {
            const res = await fetch(engine==='openai'?"https://api.openai.com/v1/audio/transcriptions":"https://api.groq.com/openai/v1/audio/transcriptions", { method:'POST', headers:{'Authorization':`Bearer ${apiKey}`}, body:fd });
            const data = await res.json();
            if (data.text) { document.getElementById('user-input').value += (document.getElementById('user-input').value ? " " : "") + data.text; showTransientStatus("å®Œæˆ"); }
        } catch(e) { showTransientStatus("éŒ¯èª¤", 'error'); playAudioCue('error'); }
        finally { document.getElementById('voice-btn').classList.remove('recording'); showReadyStatus(); }
    }
    function stopVoiceInput() { document.getElementById('voice-btn').classList.remove('recording'); showReadyStatus(); }
    function saveVoiceSettings() { localStorage.setItem('voice_engine', document.getElementById('voice-engine').value); localStorage.setItem('voice_api_key', document.getElementById('voice-api-key').value); initVoiceSystem(); }
    function initPasteImage() { document.addEventListener('paste', e => { const f = e.clipboardData.files[0]; if(f && f.type.startsWith('image/')) handleFileSelect(f); }); }
    function initDragAndDrop() { const d = document.getElementById('user-input'); d.ondragover = e => {e.preventDefault(); d.classList.add('dragover')}; d.ondragleave = () => d.classList.remove('dragover'); d.ondrop = e => {e.preventDefault(); d.classList.remove('dragover'); handleFileSelect(e.dataTransfer.files[0]);}; }
    function initEnterKey() { document.getElementById('user-input').onkeydown = e => { if(e.key==='Enter' && !e.shiftKey && document.getElementById('enter-to-send').checked) { e.preventDefault(); document.getElementById('submit-btn').click(); } }; }
    
    function updateStatusBar(t, s='ready') { 
        const b = document.getElementById('status-bar'); 
        b.innerText = t; 
        b.className = s; 
        b.setAttribute('aria-live', s === 'error' ? 'assertive' : 'polite');
    }
    
    function showReadyStatus() { updateStatusBar("æº–å‚™å°±ç·’"); }
    function showTransientStatus(m, t='success') { updateStatusBar(m, t==='error'?'error':'ready'); setTimeout(()=>{ if(!document.getElementById('status-bar').classList.contains('busy')) showReadyStatus(); }, 3000); }
    function addMessage(role, content) {
        const div = document.createElement('div'); div.className = `message ${role}`; div.tabIndex = -1;
        div.innerHTML = `<h1 class="msg-heading">${role==='user'?'è¼¸å…¥å•é¡Œï¼š':(role==='error'?'ç™¼ç”ŸéŒ¯èª¤ï¼š':'å›æ‡‰çµæœï¼š')}</h1><div class="markdown-body">${role==='user'?content:DOMPurify.sanitize(marked.parse(content))}</div>`;
        if(role==='assistant') {
            const btn = document.createElement('button'); btn.className='mini-copy-btn'; btn.innerText='è¤‡è£½ (Alt+Shift+R)';
            btn.onclick = () => navigator.clipboard.writeText(div.querySelector('.markdown-body').innerText).then(()=>showTransientStatus('å·²è¤‡è£½'));
            div.appendChild(btn);
        }
        document.getElementById('chat-output').appendChild(div); return div;
    }
    function toggleExportButtons(show) { ['copy-btn','export-txt-btn','export-html-btn'].forEach(id=>document.getElementById(id).classList.toggle('hidden', !show)); }
    function handleProviderChange(save=true) {
        const p = document.getElementById('provider-select').value; const c = PROVIDERS[p];
        document.getElementById('api-key').value = localStorage.getItem(`${p}_key`) || "";
        document.getElementById('system-prompt').value = localStorage.getItem(`${p}_prompt`) || c.prompt;
        document.getElementById('openrouter-settings').classList.toggle('hidden', p!=='openrouter');
        allCurrentModels = JSON.parse(localStorage.getItem(`${p}_model_list`)) || c.models;
        handleModelFilter();
        currentActiveModelId = localStorage.getItem(`${p}_model`) || c.defaultModel;
        document.getElementById('refresh-btn').style.display = c.canFetch ? 'block' : 'none';
        if(save) localStorage.setItem('provider', p);
        resetConversation(); showReadyStatus();
    }
    function handleModelFilter() {
        const f = document.getElementById('model-filter-input').value.toLowerCase();
        updateModelSelect(allCurrentModels.filter(m=>m.toLowerCase().includes(f)), currentActiveModelId);
    }
    function updateModelSelect(list, active) {
        const s = document.getElementById('model-select'); s.innerHTML = "";
        let found = false;
        list.forEach(m => { const o = document.createElement('option'); o.value=m; o.innerText=m; if(m===active) found=true; s.appendChild(o); });
        const cust = document.createElement('option'); cust.value="CUSTOM"; cust.innerText="è‡ªè¡Œè¼¸å…¥..."; s.appendChild(cust);
        const w = document.getElementById('custom-model-wrapper');
        if(found) { s.value=active; w.classList.add('hidden'); } else { s.value="CUSTOM"; w.classList.remove('hidden'); document.getElementById('custom-model-input').value=active; }
    }
    async function fetchOnlineModels() {
        const p = document.getElementById('provider-select').value; const k = document.getElementById('api-key').value;
        if(!k && p!=='openrouter') return alert("éœ€ API Key");
        const btn = document.getElementById('refresh-btn'); btn.innerText="è®€å–ä¸­..."; btn.disabled=true;
        try {
            let list=[];
            if(p==='openrouter') list=(await(await fetch("https://openrouter.ai/api/v1/models")).json()).data.map(m=>m.id);
            else if(p==='gemini') list=(await(await fetch(PROVIDERS[p].listUrl.replace('{KEY}',k))).json()).models.filter(m=>m.supportedGenerationMethods?.includes("generateContent")).map(m=>m.name.replace("models/",""));
            else list=(await(await fetch(PROVIDERS[p].listUrl, {headers:{'Authorization':`Bearer ${k}`}})).json()).data.map(m=>m.id);
            if(list.length) { localStorage.setItem(`${p}_model_list`, JSON.stringify(list)); allCurrentModels=list; handleModelFilter(); showTransientStatus("å·²æ›´æ–°"); }
        } catch(e) { showTransientStatus("æ›´æ–°å¤±æ•—", 'error'); } finally { btn.innerText="æ›´æ–°æ¨¡å‹æ¸…å–®"; btn.disabled=false; }
    }
    function handleModelSelectChange() {
        const s = document.getElementById('model-select');
        if(s.value==="CUSTOM") document.getElementById('custom-model-wrapper').classList.remove('hidden');
        else { document.getElementById('custom-model-wrapper').classList.add('hidden'); currentActiveModelId=s.value; }
        resetConversation();
    }
    function handleCustomInputChange() { currentActiveModelId = document.getElementById('custom-model-input').value.trim(); resetConversation(); }
    function saveSettings() {
        const p = document.getElementById('provider-select').value;
        const m = document.getElementById('model-select').value==="CUSTOM" ? document.getElementById('custom-model-input').value : document.getElementById('model-select').value;
        localStorage.setItem(`${p}_key`, document.getElementById('api-key').value.trim());
        localStorage.setItem(`${p}_model`, m); currentActiveModelId = m;
        localStorage.setItem(`${p}_prompt`, document.getElementById('system-prompt').value);
        localStorage.setItem('timeout_setting', document.getElementById('timeout-setting').value);
        localStorage.setItem('enter_to_send', document.getElementById('enter-to-send').checked);
        localStorage.setItem('openrouter_web_search', document.getElementById('openrouter-web-search').checked);
        saveVoiceSettings(); showTransientStatus("å·²å„²å­˜"); document.getElementById('settings-area').open = false;
    }
    function restoreDefaults() {
        const p = document.getElementById('provider-select').value; document.getElementById('system-prompt').value = PROVIDERS[p].prompt;
        localStorage.removeItem(`${p}_model`); localStorage.removeItem(`${p}_prompt`); handleProviderChange(true); showTransientStatus("å·²é‚„åŸ");
    }
    function copyResult() { navigator.clipboard.writeText(document.getElementById('chat-output').innerText).then(()=>showTransientStatus("å·²è¤‡è£½")); }
    function exportChat(fmt) {
        const c = document.getElementById('chat-output');
        const b = new Blob([fmt==='html'?`<html><body>${c.innerHTML}</body></html>`:c.innerText], {type:fmt==='html'?'text/html':'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `export.${fmt}`; a.click();
    }
    function handleFileSelect(f) {
        if(f) { selectedFile=f; document.getElementById('upload-btn').innerText=`å·²é¸: ${f.name}`; showTransientStatus("å·²åŠ å…¥"); if(!document.getElementById('pause-send').checked) setTimeout(()=>document.querySelector('form').requestSubmit(), 500); }
    }
    function readFileAsBase64(f) { return new Promise((r,j)=>{const rd=new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.onerror=j; rd.readAsDataURL(f);}); }

    async function handleSubmit(e) {
        e.preventDefault(); const txt = document.getElementById('user-input').value.trim();
        if(!txt && !selectedFile) return showTransientStatus("è«‹è¼¸å…¥", 'error');
        playAudioCue('start'); updateStatusBar("è™•ç†ä¸­...", 'busy');
        const btn = document.getElementById('submit-btn'); btn.disabled=true;
        const ctl = new AbortController(); const tm = setTimeout(()=>ctl.abort(), document.getElementById('timeout-setting').value*1000);
        try {
            let input = txt; let fileData = null; let mime = null; let skipFile = false;
            if(selectedFile) {
                if(selectedFile.type==='application/pdf') {
                    // è‹¥æ˜¯ PDFï¼Œå˜—è©¦æå–æ–‡å­—
                    const pdfText = await extractTextFromPDF(selectedFile);
                    const charCount = pdfText ? pdfText.replace(/\s/g, '').length : 0;
                    if(charCount > 20) { input=`[PDF]:\n${pdfText}\n\n${txt}`; skipFile=true; }
                    else { 
                        // è‹¥æ–‡å­—éå°‘ (åœ–ç‰‡PDF)ï¼Œè½‰æˆåœ–ç‰‡é™£åˆ—
                        fileData = await convertPdfToImages(selectedFile); 
                        // æ¨™è¨˜ç‚ºåœ–ç‰‡é™£åˆ—
                        mime = "application/pdf-images"; 
                    }
                } else { 
                    fileData=await readFileAsBase64(selectedFile); mime=selectedFile.type; 
                }
            }
            // è‹¥ fileData æ˜¯é™£åˆ— (PDF åœ–ç‰‡)ï¼Œç›´æ¥å‚³å…¥ performAIProcessing çš„é‚è¼¯
            if (mime === "application/pdf-images") {
                await performAIProcessing(fileData, "ocr_strict", null);
            } else {
                const res = await callAI(document.getElementById('provider-select').value, input, skipFile?null:fileData, mime, ctl.signal);
                document.getElementById('user-input').value=""; document.getElementById('upload-btn').innerText="é¸æ“‡æª”æ¡ˆ (Alt+Shift+U)"; selectedFile=null;
                addMessage('user', txt||"[æª”æ¡ˆ]"); const ai = addMessage('assistant', res); ai.focus(); chatHistory.push({role:'user',content:input}); chatHistory.push({role:'assistant',content:res});
                playAudioCue('success'); showReadyStatus();
            }
        } catch(e) { addMessage('error', e.message); playAudioCue('error'); showReadyStatus(); } finally { clearTimeout(tm); btn.disabled=false; }
    }

    // ä¿®æ”¹ï¼šæ”¯æ´å¤šå¼µåœ–ç‰‡ (Vision Mode)
    async function callAI(p, txt, file, mime, sig, ovModel, ovKey) {
        const k = ovKey || document.getElementById('api-key').value; const sys = document.getElementById('system-prompt').value; const m = ovModel || currentActiveModelId;
        if(!k) throw new Error("éœ€ API Key");
        let body={}, url="", headers={'Content-Type':'application/json', 'Authorization':`Bearer ${k}`};
        
        // åˆ¤æ–·æ˜¯å¦ç‚ºå¤šå¼µåœ–ç‰‡ (PDF è½‰åœ–)
        const isMultiImage = Array.isArray(file);

        // ä¿®æ­£ï¼šç•¶ file æ˜¯é™£åˆ—æ™‚ï¼Œå¼·åˆ¶æ¨™è¨˜ç‚º jpeg
        if (isMultiImage) {
             mime = "image/jpeg";
        }

        if(p==='gemini') {
            url=`https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`; delete headers['Authorization'];
            let parts = [];
            if (isMultiImage) {
                // Gemini åŸç”Ÿæ”¯æ´å¤šåœ–
                file.forEach(b64 => parts.push({inline_data:{mime_type:"image/jpeg", data:b64}}));
                parts.push({text:txt});
            } else {
                parts = file ? [{inline_data:{mime_type:mime, data:file}}, {text:txt}] : [{text:txt}];
            }
            body = { system_instruction:{parts:[{text:sys}]}, contents:[{role:"user", parts:parts}] };
        } else {
            // OpenRouter / OpenAI / Groq
            if (p === 'openrouter') {
                url = "https://openrouter.ai/api/v1/chat/completions";
                headers['HTTP-Referer'] = location.href;
                if(document.getElementById('openrouter-web-search').checked) body.plugins = [{id:"web"}];
            } else if (p === 'mistral') {
                url = "https://api.mistral.ai/v1/chat/completions";
            } else if (p === 'perplexity') {
                url = "https://api.perplexity.ai/chat/completions";
            } else if (p === 'openai') {
                url = "https://api.openai.com/v1/chat/completions";
            } else {
                url = "https://api.groq.com/openai/v1/chat/completions";
            }

            let content = [];
            if (isMultiImage) {
                // OpenAI Vision æ ¼å¼: å¤šå€‹ image_url
                content.push({type:"text", text:txt});
                file.forEach(b64 => content.push({type:"image_url", image_url:{url:`data:image/jpeg;base64,${b64}`}}));
            } else {
                content = file ? [{type:"text",text:txt}, {type:"image_url",image_url:{url:`data:${mime};base64,${file}`}}] : txt;
            }
            
            body = { ...body, model:m, messages:[{role:"system",content:sys}, {role:"user",content:content}], temperature:0.3 };
        }
        
        const r = await fetch(url, {method:'POST', headers, body:JSON.stringify(body), signal:sig});
        if(!r.ok) throw new Error(await r.text()); const d = await r.json();
        return p==='gemini' ? (d.candidates?.[0]?.content?.parts?.[0]?.text||"ç„¡å›æ‡‰") : (d.choices?.[0]?.message?.content||"ç„¡å›æ‡‰");
    }
</script>
</body>
</html>
