<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–éšœè¼”åŠ© AI åŠ©ç† (ç©©å®šè¡¨å–®ç‰ˆ)</title>
    <!-- å¼•å…¥ Markdown è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- éŒ¯èª¤æ•æ‰è…³æœ¬ï¼šå¦‚æœç¨‹å¼å´©æ½°ï¼Œæœƒå½ˆå‡ºè­¦å‘Š -->
    <script>
        window.onerror = function(msg, url, line) {
            alert("ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤ï¼š\n" + msg + "\nè¡Œæ•¸ï¼š" + line);
            return false;
        };
    </script>

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --input-bg: #333333;
            --border-color: #555555;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --link-color: #88ccff;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 18px;
            line-height: 1.6;
        }

        *:focus {
            outline: 4px solid var(--accent-color);
            outline-offset: 2px;
        }

        h1 { color: var(--text-color); margin-bottom: 10px; }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 200px; /* é ç•™åº•éƒ¨ç©ºé–“ */
        }

        /* è¨­å®šå€å¡Š */
        details {
            background: #1a1a1a;
            border: 2px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 5px;
        }

        label { display: block; margin-top: 15px; font-weight: bold; }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 15px;
            margin-top: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 18px;
            border-radius: 6px;
            box-sizing: border-box;
        }

        textarea { min-height: 100px; font-family: monospace; }

        /* ä¸€èˆ¬æŒ‰éˆ• */
        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            width: 100%;
            border-radius: 8px;
        }
        
        button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
        button.secondary { background-color: #333; color: #fff; border: 1px solid #777; margin-top: 10px; }

        /* ç‹€æ…‹è¨Šæ¯ */
        #model-status { margin-top: 10px; font-weight: bold; color: var(--accent-color); }

        .message {
            background: #1e1e1e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 6px solid var(--accent-color);
        }

        .error-msg { border-left-color: #ff4444; background: #2a0000; }

        .loading {
            text-align: center;
            font-style: italic;
            padding: 20px;
            font-size: 1.3em;
            background: #222;
            border-radius: 8px;
        }

        /* åº•éƒ¨å›ºå®šæ§åˆ¶å€ */
        .controls-wrapper {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #000;
            padding: 15px;
            border-top: 2px solid var(--border-color);
            z-index: 100;
        }
        
        /* ä½¿ç”¨ Form ä¾†åŒ…è£åº•éƒ¨æ§åˆ¶é …ï¼Œè‡ªç„¶æ”¯æ´ Enter */
        #chat-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .file-label {
            display: block;
            background: #333;
            color: #fff;
            text-align: center;
            padding: 12px;
            border: 1px dashed #777;
            border-radius: 6px;
            cursor: pointer;
        }
        #file-input { display: none; }

        .search-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
        }
        .search-toggle input { width: 25px; height: 25px; margin: 0; }

        /* ä¾†æºé€£çµæ¨£å¼ */
        .sources-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 0.9em;
        }
        .sources-section a { color: var(--link-color); }

        /* Markdown */
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 1em; }
        .markdown-body strong { color: var(--accent-color); }
        .markdown-body ul { padding-left: 25px; }
        .markdown-body a { color: var(--link-color); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 tabindex="0">AI è¦–è¦ºåŠ©ç† (è¡¨å–®ç‰ˆ)</h1>
    </header>

    <!-- è¨­å®šå€åŸŸ -->
    <details id="settings-area">
        <summary>è¨­å®šé¸é … (é»æ­¤å±•é–‹)</summary>
        <div>
            <label for="api-key">Google Gemini API Key:</label>
            <input type="password" id="api-key" placeholder="è²¼ä¸Š AIza é–‹é ­çš„é‡‘é‘°">
            
            <button type="button" onclick="checkAndSaveKeys()" class="secondary">æ›´æ–° Key ä¸¦åµæ¸¬æ¨¡å‹</button>
            
            <label for="model-select">é¸æ“‡æ¨¡å‹:</label>
            <select id="model-select">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (æ¨è–¦)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
            <div id="model-status" role="status"></div>

            <label for="system-prompt">é è¨­æŒ‡ä»¤:</label>
            <textarea id="system-prompt"></textarea>
            
            <button type="button" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
            <p id="save-status" role="status"></p>
        </div>
    </details>

    <!-- è¼¸å‡ºå€åŸŸ -->
    <main id="chat-output" aria-live="polite">
        <div class="message">
            <strong>ç³»çµ±å°±ç·’ã€‚</strong><br>
            è«‹ç›´æ¥è¼¸å…¥æ–‡å­—ä¸¦æŒ‰ Enterï¼Œæˆ–é¸æ“‡åœ–ç‰‡å¾Œéäº¤ã€‚
        </div>
    </main>
</div>

<!-- åº•éƒ¨æ“ä½œå€ (è¡¨å–®) -->
<footer class="controls-wrapper">
    <form id="chat-form" onsubmit="handleFormSubmit(event)">
        
        <!-- æœå°‹é–‹é—œ -->
        <div class="search-toggle">
            <input type="checkbox" id="enable-search">
            <label for="enable-search" style="margin:0; cursor:pointer;">å•Ÿç”¨ Google æœå°‹ (å¤©æ°£/æ–°è)</label>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³ -->
        <label for="file-input" class="file-label" id="file-label-text">ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§</label>
        <input type="file" id="file-input" accept="image/*" capture="environment" onchange="updateFileLabel()">
        
        <!-- æ–‡å­—è¼¸å…¥ -->
        <label for="user-input" class="sr-only">è¼¸å…¥å•é¡Œ</label>
        <input type="text" id="user-input" placeholder="è¼¸å…¥å•é¡Œ... (æŒ‰ Enter å‚³é€)" autocomplete="off">
        
        <!-- éäº¤æŒ‰éˆ• (type="submit" æ”¯æ´åŸç”Ÿ Enter) -->
        <button type="submit" id="submit-btn">éäº¤ (å‚³é€)</button>
    </form>
</footer>

<script>
    // === å…¨åŸŸè®Šæ•¸èˆ‡å¸¸æ•¸ ===
    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š
ä½ æ˜¯ä¸€ä½è¦–éšœè¼”åŠ©åŠ©ç†ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡(é¦™æ¸¯)å›ç­”ã€‚
# ä»»å‹™
1. åœ–ç‰‡ï¼šæè¿°é‡é»ç´°ç¯€ã€‚
2. æœå°‹ï¼šæ•´åˆçµæœï¼Œç›´æ¥å›ç­”é‡é»ï¼Œä¸¦æ¨™è¨»ä¾†æºã€‚
3. é¢¨æ ¼ï¼šè¦ªåˆ‡ã€ç²¾ç°¡ã€é‡é»åœ¨å…ˆã€‚`;

    // === åˆå§‹åŒ– ===
    // ä½¿ç”¨ DOMContentLoaded ç¢ºä¿ç•«é¢å…ƒç´ è¼‰å…¥å¾Œæ‰åŸ·è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        try {
            loadSettings();
            const key = localStorage.getItem('gemini_api_key');
            if (!key) {
                document.getElementById('settings-area').open = true;
                document.getElementById('api-key').focus();
            } else {
                document.getElementById('user-input').focus();
            }
        } catch (e) {
            console.error("åˆå§‹åŒ–éŒ¯èª¤:", e);
        }
    });

    // === æ ¸å¿ƒåŠŸèƒ½ï¼šè¡¨å–®éäº¤ ===
    async function handleFormSubmit(event) {
        // é˜²æ­¢è¡¨å–®é‡æ–°æ•´ç†é é¢
        event.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const outputDiv = document.getElementById('chat-output');
        const useSearch = document.getElementById('enable-search').checked;
        
        const apiKey = localStorage.getItem('gemini_api_key');
        const modelName = localStorage.getItem('gemini_model') || "gemini-1.5-flash"; 
        const systemPrompt = localStorage.getItem('gemini_system_prompt') || DEFAULT_PROMPT;

        const text = userInput.value.trim();
        const file = fileInput.files[0];

        // æª¢æŸ¥ API Key
        if (!apiKey) {
            alert("è«‹å…ˆè¨­å®š API Keyï¼");
            document.getElementById('settings-area').open = true;
            return;
        }

        // æª¢æŸ¥è¼¸å…¥
        if (!text && !file) {
            alert("è«‹è¼¸å…¥æ–‡å­—æˆ–é¸æ“‡åœ–ç‰‡ã€‚");
            return;
        }

        // é–å®šä»‹é¢
        submitBtn.disabled = true;
        submitBtn.textContent = useSearch ? "æœå°‹ä¸­..." : "åˆ†æä¸­...";
        outputDiv.innerHTML = `<div class="loading">æ­£åœ¨å‘¼å« ${modelName}${useSearch ? " (å«è¯ç¶²)" : ""}...</div>`;

        try {
            let contentsParts = [];
            let fullTextPrompt = systemPrompt + "\n\nç”¨æˆ¶æŒ‡ä»¤ï¼š\n" + (text || "è«‹æè¿°åœ–ç‰‡");
            contentsParts.push({ text: fullTextPrompt });

            if (file) {
                const base64Data = await fileToBase64(file);
                contentsParts.push({ inline_data: { mime_type: file.type, data: base64Data } });
            }

            // æº–å‚™è«‹æ±‚ç‰©ä»¶
            const requestBody = {
                contents: [{ parts: contentsParts }],
                generationConfig: { temperature: 0.5, maxOutputTokens: 1000 }
            };

            // å¦‚æœé–‹å•Ÿæœå°‹
            if (useSearch) {
                requestBody.tools = [{ googleSearch: {} }];
            }

            // ç™¼é€è«‹æ±‚
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            // è™•ç†çµæœ (ä½¿ç”¨ ?. é˜²æ­¢ç•¶æ©Ÿ)
            const candidate = data.candidates?.[0];
            const resultText = candidate?.content?.parts?.[0]?.text;
            const groundingMeta = candidate?.groundingMetadata;

            if (resultText) {
                let htmlContent = marked.parse(resultText);

                // è™•ç†æœå°‹ä¾†æº
                if (groundingMeta?.groundingChunks) {
                    let sourcesList = "";
                    groundingMeta.groundingChunks.forEach(chunk => {
                        if (chunk.web?.uri) {
                            const title = chunk.web.title || "ä¾†æºé€£çµ";
                            sourcesList += `<li><a href="${chunk.web.uri}" target="_blank">${title}</a></li>`;
                        }
                    });
                    
                    if (sourcesList) {
                        htmlContent += `<div class="sources-section"><h4>ğŸ“š åƒè€ƒä¾†æºï¼š</h4><ul>${sourcesList}</ul></div>`;
                    }
                }

                outputDiv.innerHTML = `<div class="message markdown-body">${htmlContent}</div>`;
                
                // æˆåŠŸå¾Œæ¸…ç©ºè¼¸å…¥
                userInput.value = "";
                fileInput.value = ""; 
                updateFileLabel();
                
            } else {
                // éŒ¯èª¤è™•ç†
                let msg = "ç„¡æ³•å–å¾—å›æ‡‰ã€‚";
                if (data.error) msg = `API éŒ¯èª¤ï¼š${data.error.message}`;
                else if (candidate?.finishReason) msg = `è¢«é˜»æ“‹ï¼ŒåŸå› ï¼š${candidate.finishReason}`;
                
                outputDiv.innerHTML = `<div class="message error-msg">${msg}</div>`;
            }

        } catch (error) {
            console.error(error);
            outputDiv.innerHTML = `<div class="message error-msg">ç³»çµ±éŒ¯èª¤ï¼š${error.message}</div>`;
        } finally {
            // è§£é–ä»‹é¢
            submitBtn.disabled = false;
            submitBtn.textContent = "éäº¤ (å‚³é€)";
            // è®“è¢å¹•é–±è®€å™¨ç„¦é»å›åˆ°çµæœ
            outputDiv.focus();
        }
    }

    // === è¼”åŠ©åŠŸèƒ½ ===
    function loadSettings() {
        const savedPrompt = localStorage.getItem('gemini_system_prompt');
        const savedKey = localStorage.getItem('gemini_api_key');
        const savedModel = localStorage.getItem('gemini_model');
        
        document.getElementById('system-prompt').value = savedPrompt || DEFAULT_PROMPT;
        if (savedKey) document.getElementById('api-key').value = savedKey;
        if (savedModel) {
            const select = document.getElementById('model-select');
            if (![...select.options].some(o => o.value === savedModel)) {
                let opt = document.createElement('option');
                opt.value = savedModel;
                opt.text = savedModel + " (è‡ªè¨‚)";
                select.add(opt);
            }
            select.value = savedModel;
        }
    }

    function saveSettings() {
        const key = document.getElementById('api-key').value.trim();
        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
        
        localStorage.setItem('gemini_api_key', key);
        localStorage.setItem('gemini_system_prompt', document.getElementById('system-prompt').value);
        localStorage.setItem('gemini_model', document.getElementById('model-select').value);
        
        document.getElementById('save-status').textContent = "è¨­å®šå·²å„²å­˜ï¼";
        setTimeout(() => document.getElementById('save-status').textContent = "", 3000);
        document.getElementById('settings-area').open = false;
        alert("è¨­å®šå·²å„²å­˜");
    }

    function updateFileLabel() {
        const file = document.getElementById('file-input').files[0];
        const label = document.getElementById('file-label-text');
        label.textContent = file ? `âœ… å·²é¸æ“‡ï¼š${file.name}` : "ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§";
        label.style.background = file ? "#004400" : "#333";
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function checkAndSaveKeys() {
        const key = document.getElementById('api-key').value.trim();
        const statusDiv = document.getElementById('model-status');
        const select = document.getElementById('model-select');
        
        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
        statusDiv.textContent = "é€£ç·šæª¢æŸ¥ä¸­...";
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            if (!response.ok) throw new Error("Key ç„¡æ•ˆæˆ–ç¶²è·¯éŒ¯èª¤");
            const data = await response.json();
            
            select.innerHTML = "";
            let bestModel = "";
            if (data.models) {
                const validModels = data.models
                    .filter(m => m.supportedGenerationMethods?.includes("generateContent"))
                    .sort((a, b) => b.name.includes('flash') - a.name.includes('flash'));

                validModels.forEach(m => {
                    const id = m.name.replace("models/", "");
                    let opt = document.createElement("option");
                    opt.value = id;
                    opt.text = `${m.displayName} (${id})`;
                    select.appendChild(opt);
                    if (!bestModel && id.includes("flash")) bestModel = id;
                });
            }
            if (bestModel) select.value = bestModel;
            statusDiv.textContent = "âœ… æ›´æ–°æˆåŠŸ";
            localStorage.setItem('gemini_api_key', key);
        } catch (e) {
            statusDiv.textContent = "âŒ éŒ¯èª¤ï¼š" + e.message;
        }
    }
</script>

</body>
</html>
