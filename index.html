<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœè¼”åŠ©åŠ©ç† (æ™ºæ…§åˆ—è¡¨ç‰ˆ)</title>
    <!-- æŒ‡å®š Marked.js ç‰ˆæœ¬ä»¥ç¢ºä¿ç©©å®šæ€§ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --link-color: #88CCFF;
            --input-bg: #1A1A1A;
            --border-color: #555555;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --focus-ring: 4px solid #FFFF00;
            --error-bg: #440000;
            --section-bg: #111;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.1rem; line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 300px 10px;
        }

        /* ç„¦é»èˆ‡è¼¸å…¥æ¡† */
        *:focus-visible {
            outline: var(--focus-ring) !important;
            outline-offset: 2px;
            border-radius: 4px;
        }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%; padding: 15px; margin-top: 8px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem;
            border-radius: 6px; box-sizing: border-box;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 15px 20px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            border-radius: 8px; flex: 1; min-width: 120px;
        }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        button.action-btn { flex: 0 0 auto; width: auto; font-size: 0.9rem; padding: 10px; }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* éš±è—å…ƒç´ ç”¨çš„ class */
        .hidden { display: none !important; }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .input-group { display: flex; gap: 10px; align-items: flex-end; }

        details {
            background: var(--section-bg); border: 2px solid var(--border-color);
            padding: 15px; margin-bottom: 20px; border-radius: 8px;
        }
        summary {
            cursor: pointer; font-weight: bold; font-size: 1.2rem;
            list-style: none; display: flex; justify-content: space-between;
        }

        .message {
            background: #111; padding: 20px; margin-bottom: 20px;
            border-radius: 8px; border-left: 5px solid var(--accent-color);
            overflow-wrap: break-word;
        }
        .message.user { border-left-color: #0088ff; background: #0a0a1a; }
        .message.error { border-left-color: #ff0000; background: var(--error-bg); }

        .markdown-body img { max-width: 100%; height: auto; }
        .markdown-body pre { background: #222; padding: 10px; overflow-x: auto; border: 1px solid #444; }
        .markdown-body a { color: var(--link-color); }

        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(0, 0, 0, 0.95); padding: 15px;
            border-top: 3px solid var(--accent-color); z-index: 999;
        }
        
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }
        .loading-spinner {
            display: inline-block; width: 15px; height: 15px;
            border: 2px solid rgba(255,255,0,0.3); border-radius: 50%;
            border-top-color: var(--accent-color); animation: spin 1s infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 tabindex="-1">AI è¦–éšœè¼”åŠ©åŠ©ç† (2025 ç‰ˆ)</h1>
    </header>

    <details id="settings-area">
        <summary accesskey="s" role="button">
            <span>âš™ï¸ è¨­å®šèˆ‡æ¨¡å‹é¸æ“‡ (Alt + S)</span>
            <span>â–¼</span>
        </summary>
        <div style="padding-top: 15px;">
            
            <label for="provider-select">1. é¸æ“‡ AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()" style="border-color: var(--accent-color);">
                <option value="gemini">Google Gemini (æ¨è–¦: å…è²»/Gemini 2.0)</option>
                <option value="openrouter">OpenRouter (æ¨è–¦: æ•´åˆæ‰€æœ‰æ¨¡å‹)</option>
                <option value="groq">Groq (Llama 3.3/æ¥µé€Ÿ)</option>
                <option value="openai">OpenAI (GPT-4o/éœ€ä»˜è²»)</option>
                <option value="mistral">Mistral AI (Pixtral/æ­æ´²)</option>
                <option value="perplexity">Perplexity (Sonar/å³æ™‚æœå°‹)</option>
            </select>
            <p style="font-size:0.85rem; color:#aaa; margin-top:5px;">
                âš ï¸ æç¤ºï¼šé™¤ Gemini èˆ‡ OpenRouter å¤–ï¼Œå…¶ä»–å®˜æ–¹ API åŸºæ–¼å®‰å…¨æ€§ (CORS) é™åˆ¶ï¼Œä¸æ”¯æ´å¾ç¶²é è‡ªå‹•æ›´æ–°æ¨¡å‹åˆ—è¡¨ã€‚
            </p>

            <hr style="border-color:#333; margin: 20px 0;">

            <h3>2. API é‡‘é‘°èˆ‡æ¨¡å‹</h3>
            <label for="api-key">API Key (é‡‘é‘°):</label>
            <input type="password" id="api-key" placeholder="è¼¸å…¥ API Key..." autocomplete="off">
            
            <label for="model-input" style="margin-top:15px;">AI æ¨¡å‹ (Model ID):</label>
            <div class="input-group">
                <div style="flex:1; position:relative;">
                    <input type="text" id="model-input" list="model-suggestions" placeholder="è«‹é¸æ“‡æˆ–è¼¸å…¥æ¨¡å‹ ID">
                    <datalist id="model-suggestions"></datalist>
                </div>
                <!-- é€™å€‹æŒ‰éˆ•æœƒæ ¹æ“š AI å» å•†æ˜¯å¦æ”¯æ´è‡ªå‹•æŠ“å–è€Œé¡¯ç¤º/éš±è— -->
                <button type="button" id="refresh-model-btn" class="secondary action-btn" onclick="fetchAvailableModels()" title="æ›´æ–°åˆ—è¡¨">
                    ğŸ”„ æ›´æ–°æ¨¡å‹æ¸…å–®
                </button>
            </div>
            <p id="model-status" style="font-size:0.9rem; color:var(--accent-color); min-height:1.5em; margin-top:5px;"></p>

            <hr style="border-color:#333; margin: 20px 0;">

            <h3>3. é è¨­æŒ‡ä»¤ (System Prompt)</h3>
            <textarea id="system-prompt" rows="6" placeholder="è¼¸å…¥æ­¤ AI çš„è§’è‰²è¨­å®š..."></textarea>

            <div class="btn-group">
                <button type="button" onclick="saveCurrentSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button type="button" onclick="restoreDefaultPrompt()" class="secondary">â†©ï¸ æ¢å¾©é è¨­æŒ‡ä»¤</button>
            </div>
        </div>
    </details>

    <main id="chat-output" role="log" aria-live="polite"></main>
</div>

<footer class="controls-wrapper">
    <form id="chat-form" onsubmit="handleFormSubmit(event)">
        <div style="margin-bottom: 10px; display:flex; gap:10px;">
             <div style="flex:1; display:flex; align-items:center; background:#222; padding:0 10px; border-radius:6px;">
                <input type="checkbox" id="enable-search" checked style="width:20px; margin:0 10px 0 0;">
                <label for="enable-search" style="margin:0; cursor:pointer; color:#ccc;">è¯ç¶²æœå°‹ (Alt+G)</label>
            </div>
            
            <input type="file" id="file-input" class="visually-hidden" accept="image/*,application/pdf,text/plain" onchange="handleFileSelect()">
            <button type="button" id="upload-trigger-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u" style="flex:1;">
                ğŸ“ é¸æ“‡æª”æ¡ˆ (Alt+U)
            </button>
        </div>
        
        <div class="input-group">
            <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." autocomplete="off" accesskey="i">
            <button type="submit" id="submit-btn" style="flex: 0 0 80px;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // === 2025.12 æœ€æ–°æ¨¡å‹åˆ—è¡¨é…ç½® ===
    // canFetchModels: å®šç¾©è©²å» å•†æ˜¯å¦æ”¯æ´å‰ç«¯ CORS æŠ“å–æ¸…å–®
    const PROVIDERS = {
        gemini: {
            name: "Google Gemini",
            type: "gemini_native",
            canFetchModels: true, // æ”¯æ´
            defaultModel: "gemini-2.0-flash-exp",
            suggestions: ["gemini-2.0-flash-exp", "gemini-1.5-pro", "gemini-1.5-flash", "gemini-exp-1206"],
            defaultPrompt: "ä½ æ˜¯ä¸€ä½è¦–éšœè¼”åŠ©åŠ©ç†ã€‚è«‹è­˜åˆ¥åœ–ç‰‡æ–‡å­—(OCR)ã€æè¿°åœ–ç‰‡å ´æ™¯ç´°ç¯€ï¼Œæˆ–ç¸½çµPDFæ–‡ä»¶ã€‚",
            listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}",
            supportSearch: true
        },
        openrouter: {
            name: "OpenRouter",
            type: "openai_compatible",
            canFetchModels: true, // æ”¯æ´
            baseUrl: "https://openrouter.ai/api/v1",
            defaultModel: "qwen/qwen-2.5-vl-72b-instruct:free",
            suggestions: ["qwen/qwen-2.5-vl-72b-instruct:free", "google/gemini-2.0-flash-exp:free", "meta-llama/llama-3.2-90b-vision-instruct", "openai/gpt-4o"],
            defaultPrompt: "ä½ æ˜¯ä¸€ä½å…¨èƒ½ AI åŠ©ç†ã€‚è«‹æ ¹æ“šé¸ç”¨æ¨¡å‹çš„å¼·é …æä¾›å”åŠ©ã€‚",
            listUrl: "https://openrouter.ai/api/v1/models",
            supportSearch: false
        },
        groq: {
            name: "Groq",
            type: "openai_compatible",
            canFetchModels: false, // å®˜æ–¹ API ä¸æ”¯æ´å‰ç«¯ CORS
            baseUrl: "https://api.groq.com/openai/v1",
            defaultModel: "llama-3.2-90b-vision-preview",
            suggestions: ["llama-3.2-90b-vision-preview", "llama-3.3-70b-versatile", "mixtral-8x7b-32768"],
            defaultPrompt: "ä½ æ˜¯ä¸€ä½æ¥µé€Ÿ AI åŠ©ç†ã€‚è«‹ç°¡æ½”æè¿°åœ–ç‰‡å…§å®¹ï¼Œé‡é»åœ¨æ–¼éšœç¤™ç‰©èˆ‡æ–‡å­—ã€‚",
            listUrl: null,
            supportSearch: false
        },
        openai: {
            name: "OpenAI",
            type: "openai_compatible",
            canFetchModels: false, // å®˜æ–¹ API ä¸æ”¯æ´å‰ç«¯ CORS
            baseUrl: "https://api.openai.com/v1",
            defaultModel: "gpt-4o",
            suggestions: ["gpt-4o", "gpt-4o-mini", "o1-preview", "o1-mini"],
            defaultPrompt: "ä½ æ˜¯ç”± GPT-4 é©…å‹•çš„è¦–éšœåŠ©ç†ã€‚è«‹æä¾›æœ€ç´°è†©çš„è¦–è¦ºæè¿°ã€‚",
            listUrl: null,
            supportSearch: false
        },
        mistral: {
            name: "Mistral",
            type: "openai_compatible",
            canFetchModels: false, // å®˜æ–¹ API ä¸æ”¯æ´å‰ç«¯ CORS
            baseUrl: "https://api.mistral.ai/v1",
            defaultModel: "pixtral-large-latest",
            suggestions: ["pixtral-large-latest", "pixtral-12b-2409", "mistral-large-latest"],
            defaultPrompt: "è«‹ç²¾æº–è­˜åˆ¥åœ–ç‰‡æ–‡å­—èˆ‡æ–‡ä»¶çµæ§‹ã€‚",
            listUrl: null,
            supportSearch: false
        },
        perplexity: {
            name: "Perplexity",
            type: "openai_compatible",
            canFetchModels: false, // å®˜æ–¹ API ä¸æ”¯æ´å‰ç«¯ CORS
            baseUrl: "https://api.perplexity.ai",
            defaultModel: "sonar-pro", 
            suggestions: ["sonar-pro", "sonar", "sonar-reasoning", "sonar-reasoning-pro"],
            defaultPrompt: "è«‹æä¾›æœ€æ–°çš„ç¶²è·¯å³æ™‚æœå°‹è³‡è¨Šï¼Œä¸¦æ¨™è¨»ä¾†æºã€‚",
            listUrl: null,
            supportSearch: false // Perplexity æœå°‹æ˜¯å…§å»ºåŠŸèƒ½ï¼Œä¸éœ€å¤–éƒ¨å·¥å…·é–‹é—œ
        }
    };

    // === åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
        checkFirstRun();
        const savedProvider = localStorage.getItem('active_provider') || 'gemini';
        document.getElementById('provider-select').value = savedProvider;
        handleProviderChange(false);
    });

    function checkFirstRun() {
        const hasRun = localStorage.getItem('app_has_run_before');
        const details = document.getElementById('settings-area');
        if (!hasRun) {
            details.open = true;
            localStorage.setItem('app_has_run_before', 'true');
        } else {
            details.open = false;
        }
    }

    // === è¨­å®šåˆ‡æ›é‚è¼¯ ===
    function handleProviderChange(save = true) {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];
        
        // è¼‰å…¥å„²å­˜çš„è¨­å®š
        const savedKey = localStorage.getItem(`${pKey}_key`) || "";
        const savedModel = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        const savedPrompt = localStorage.getItem(`${pKey}_prompt`) || conf.defaultPrompt;
        
        document.getElementById('api-key').value = savedKey;
        document.getElementById('model-input').value = savedModel;
        document.getElementById('system-prompt').value = savedPrompt;
        
        // æ›´æ–°è¼¸å…¥æ¡†çš„å»ºè­°æ¸…å–®
        updateModelDatalist(pKey);

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶ã€Œæ›´æ–°æ¨¡å‹æ¸…å–®ã€æŒ‰éˆ•é¡¯ç¤º/éš±è— ---
        const refreshBtn = document.getElementById('refresh-model-btn');
        const statusMsg = document.getElementById('model-status');
        
        if (conf.canFetchModels) {
            refreshBtn.classList.remove('hidden');
            statusMsg.textContent = ""; // æ¸…ç©ºä¹‹å‰çš„è¨Šæ¯
        } else {
            refreshBtn.classList.add('hidden');
            statusMsg.textContent = `â„¹ï¸ ${conf.name} ä¸æ”¯æ´å¾ç¶²é æ›´æ–°åˆ—è¡¨ï¼Œè«‹ç›´æ¥è¼¸å…¥æ¨¡å‹ IDã€‚`;
        }

        // --- æ§åˆ¶è¯ç¶²æœå°‹é¸é … ---
        const searchCheck = document.getElementById('enable-search');
        const searchContainer = searchCheck.parentElement;

        if(conf.supportSearch || pKey === 'perplexity') {
            searchContainer.style.opacity = '1';
            searchCheck.disabled = false;
            // è‹¥ç‚º Geminiï¼Œé è¨­é–‹å•Ÿ
            if (pKey === 'gemini') searchCheck.checked = true;
        } else {
            searchContainer.style.opacity = '0.3';
            searchCheck.disabled = true;
            searchCheck.checked = false;
        }

        if(save) localStorage.setItem('active_provider', pKey);
    }

    function updateModelDatalist(pKey) {
        const datalist = document.getElementById('model-suggestions');
        datalist.innerHTML = "";
        
        let models = PROVIDERS[pKey].suggestions;
        // å˜—è©¦è®€å–å¿«å– (åƒ…é‡å°æ”¯æ´ Fetch çš„å» å•†)
        try {
            const cached = localStorage.getItem(`${pKey}_model_cache`);
            if (cached) {
                const parsed = JSON.parse(cached);
                if (Array.isArray(parsed) && parsed.length > 0) models = parsed;
            }
        } catch(e) {
            console.warn("å¿«å–è®€å–å¤±æ•—", e);
        }

        models.forEach(mid => {
            let opt = document.createElement('option');
            opt.value = mid;
            datalist.appendChild(opt);
        });
    }

    function saveCurrentSettings() {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];

        const currentKey = document.getElementById('api-key').value.trim();
        const currentModel = document.getElementById('model-input').value.trim();
        const currentPrompt = document.getElementById('system-prompt').value;

        const savedKey = localStorage.getItem(`${pKey}_key`) || "";
        const savedModel = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        const savedPrompt = localStorage.getItem(`${pKey}_prompt`) || conf.defaultPrompt;

        const isChanged = (currentKey !== savedKey) || (currentModel !== savedModel) || (currentPrompt !== savedPrompt);

        if (isChanged) {
            localStorage.setItem(`${pKey}_key`, currentKey);
            localStorage.setItem(`${pKey}_model`, currentModel);
            localStorage.setItem(`${pKey}_prompt`, currentPrompt);
            alert(`âœ… ${PROVIDERS[pKey].name} è¨­å®šå·²å„²å­˜ï¼`);
        } else {
            alert(`â„¹ï¸ è¨­å®šæœªè®Šæ›´ã€‚`);
        }
    }

    function restoreDefaultPrompt() {
        const pKey = document.getElementById('provider-select').value;
        document.getElementById('system-prompt').value = PROVIDERS[pKey].defaultPrompt;
    }

    // === æŠ“å–æ¨¡å‹æ¸…å–® (åƒ…é™æ”¯æ´çš„å» å•†) ===
    async function fetchAvailableModels() {
        const pKey = document.getElementById('provider-select').value;
        const apiKey = document.getElementById('api-key').value.trim();
        const conf = PROVIDERS[pKey];
        const statusMsg = document.getElementById('model-status');

        if (!conf.canFetchModels) return; // é›™é‡é˜²è­·
        if (!apiKey && pKey !== 'gemini') { alert("è«‹å…ˆè¼¸å…¥ API Key"); return; }

        statusMsg.innerHTML = '<span class="loading-spinner"></span> é€£ç·šä¸­...';
        
        try {
            let models = [];
            
            if (pKey === 'gemini') {
                const url = conf.listUrl.replace('{KEY}', apiKey);
                const res = await fetch(url);
                if (!res.ok) throw new Error("Key ç„¡æ•ˆæˆ–ç¶²è·¯éŒ¯èª¤");
                const data = await res.json();
                models = (data.models || [])
                    .filter(m => m.supportedGenerationMethods?.includes("generateContent"))
                    .map(m => m.name.replace("models/", ""))
                    .sort((a,b) => {
                        if(a.includes('flash') && !b.includes('flash')) return -1;
                        return 0;
                    });
            } else if (pKey === 'openrouter') {
                const res = await fetch(conf.listUrl, {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });
                if (!res.ok) throw new Error(`é€£ç·šå¤±æ•— (${res.status})`);
                const data = await res.json();
                models = (data.data || []).map(m => m.id).sort();
            }

            if (models.length > 0) {
                localStorage.setItem(`${pKey}_model_cache`, JSON.stringify(models));
                updateModelDatalist(pKey);
                statusMsg.textContent = `âœ… æ›´æ–°æˆåŠŸï¼æ‰¾åˆ° ${models.length} å€‹æ¨¡å‹ã€‚`;
            } else {
                throw new Error("æ‰¾ä¸åˆ°æ¨¡å‹");
            }

        } catch (e) {
            console.error(e);
            // å¤±æ•—æ™‚ä¸æ¸…é™¤èˆŠå¿«å–ï¼Œé¿å…æ¸…å–®å…¨ç©º
            statusMsg.textContent = `âŒ æ›´æ–°å¤±æ•—: ${e.message}`;
        }
    }

    // === èŠå¤©æ ¸å¿ƒé‚è¼¯ ===
    async function handleFormSubmit(e) {
        e.preventDefault();
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];
        const apiKey = document.getElementById('api-key').value;
        const model = document.getElementById('model-input').value;
        const prompt = document.getElementById('system-prompt').value;
        const input = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const output = document.getElementById('chat-output');
        const submitBtn = document.getElementById('submit-btn');

        if(!apiKey) { alert("è«‹è¼¸å…¥ API Key"); return; }
        if(!input.value && !fileInput.files[0]) return;

        submitBtn.disabled = true;
        submitBtn.innerText = "â³";
        
        if(input.value) output.innerHTML += `<div class="message user">${escapeHtml(input.value)}</div>`;
        
        const resultDiv = document.createElement('div');
        resultDiv.className = 'message';
        resultDiv.innerText = "AI æ€è€ƒä¸­...";
        output.appendChild(resultDiv);
        window.scrollTo(0, document.body.scrollHeight);

        try {
            let base64 = null, mime = null;
            if(fileInput.files[0]) {
                base64 = await toBase64(fileInput.files[0]);
                mime = fileInput.files[0].type;
            }

            let text = "";
            if(conf.type === 'gemini_native') {
                text = await callGemini(apiKey, model, prompt, input.value, base64, mime);
            } else {
                text = await callOpenAICompatible(conf.baseUrl, apiKey, model, prompt, input.value, base64, mime);
            }

            const rawHtml = (typeof marked.parse === 'function') ? marked.parse(text) : marked(text);
            resultDiv.innerHTML = rawHtml;
            resultDiv.classList.add('markdown-body');
            
            input.value = "";
            fileInput.value = "";
            document.getElementById('upload-trigger-btn').innerText = "ğŸ“ é¸æ“‡æª”æ¡ˆ (Alt+U)";

        } catch(err) {
            resultDiv.className = 'message error';
            
            if (err.message.includes("Failed to fetch") || err.message.includes("CORS")) {
                 resultDiv.innerHTML = `
                    <strong>é€£ç·šå¤±æ•— (CORS éŒ¯èª¤)ï¼š</strong><br>
                    æ‚¨çš„ç€è¦½å™¨æ””æˆªäº†å° ${conf.name} çš„ç›´æ¥é€£ç·šã€‚<br><br>
                    <strong>è§£æ±ºæ–¹æ¡ˆï¼š</strong><br>
                    1. è«‹æ”¹ç”¨ <strong>Google Gemini</strong> æˆ– <strong>OpenRouter</strong> (æ¨è–¦)ã€‚<br>
                    2. å®˜æ–¹ API (å¦‚ OpenAI/Groq) åŸºæ–¼å®‰å…¨ç†ç”±ï¼Œä¸æ”¯æ´ç´”ç¶²é ç›´æ¥é€£ç·šã€‚
                 `;
            } else {
                resultDiv.innerText = "éŒ¯èª¤: " + err.message;
            }
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "å‚³é€";
            window.scrollTo(0, document.body.scrollHeight);
        }
    }

    async function callGemini(key, model, sys, user, b64, mime) {
        const useSearch = document.getElementById('enable-search').checked;
        const parts = [];
        let finalPrompt = user;
        if (sys) finalPrompt = `${sys}\n\n${user}`;

        parts.push({text: finalPrompt});
        if(b64) parts.push({inline_data: {mime_type: mime, data: b64}});

        const body = { 
            contents: [{ role: "user", parts: parts }], 
            generationConfig: { temperature: 0.7 } 
        };
        
        if(useSearch) body.tools = [{googleSearch: {}}]; 

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if(!res.ok) throw new Error(data.error?.message || "API Error");
        
        let txt = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        const chunks = data.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
        if(chunks.length > 0) {
            txt += "\n\n**åƒè€ƒä¾†æº:**\n" + chunks.map((c,i) => c.web ? `${i+1}. [${c.web.title}](${c.web.uri})` : "").join("\n");
        }
        return txt;
    }

    async function callOpenAICompatible(url, key, model, sys, user, b64, mime) {
        if(mime === 'application/pdf') throw new Error("æ­¤æ¨¡å¼æš«ä¸æ”¯æ´ PDF ä¸Šå‚³ï¼Œè«‹æ”¹ç”¨ Geminiã€‚");

        const msgs = [];
        if(sys) msgs.push({role: "system", content: sys});
        
        let contentPayload = [];
        contentPayload.push({type: "text", text: user || "è«‹æè¿°é€™å¼µåœ–ç‰‡æˆ–å…§å®¹ã€‚"});

        if(b64) {
            contentPayload.push({
                type: "image_url", 
                image_url: { url: `data:${mime};base64,${b64}` }
            });
        }
        
        msgs.push({role: "user", content: contentPayload});

        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` };
        if(url.includes("openrouter")) {
            headers['HTTP-Referer'] = window.location.href;
            headers['X-Title'] = 'Visual Assistant';
        }

        const res = await fetch(`${url}/chat/completions`, {
            method: 'POST', headers: headers,
            body: JSON.stringify({ model, messages: msgs, temperature: 0.7 })
        });
        
        const data = await res.json();
        if(!res.ok) {
            const errMsg = data.error?.message || JSON.stringify(data);
            throw new Error(errMsg);
        }
        return data.choices[0].message.content;
    }

    function toBase64(file) {
        return new Promise((r, j) => {
            const reader = new FileReader();
            reader.onload = () => r(reader.result.split(',')[1]);
            reader.onerror = j;
            reader.readAsDataURL(file);
        });
    }

    function handleFileSelect() {
        const f = document.getElementById('file-input').files[0];
        if(f) {
            const btn = document.getElementById('upload-trigger-btn');
            btn.innerText = `âœ… å·²é¸: ${f.name}`;
        }
    }

    function escapeHtml(text) {
        if (!text) return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
</script>

</body>
</html>
