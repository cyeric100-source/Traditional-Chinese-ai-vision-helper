<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–éšœè¼”åŠ© AI åŠ©ç† (Enter éäº¤ç‰ˆ)</title>
    <!-- å¼•å…¥ Markdown è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;
            --input-bg: #333333;
            --border-color: #555555;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --link-color: #88ccff;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 18px;
            line-height: 1.6;
        }

        *:focus {
            outline: 4px solid var(--accent-color);
            outline-offset: 2px;
        }

        h1 { color: var(--text-color); margin-bottom: 10px; }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 180px;
        }

        details {
            background: #1a1a1a;
            border: 2px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 5px;
        }

        label { display: block; margin-top: 15px; font-weight: bold; }

        input[type="text"], input[type="password"], textarea, select {
            width: 100%;
            padding: 15px;
            margin-top: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 18px;
            border-radius: 6px;
            box-sizing: border-box;
        }

        textarea { min-height: 100px; font-family: monospace; }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            border-radius: 8px;
        }
        
        button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
        button.secondary { background-color: #333; color: #fff; border: 1px solid #777; margin-top: 10px; }

        #model-status { margin-top: 10px; font-weight: bold; color: var(--accent-color); }

        .message {
            background: #1e1e1e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 6px solid var(--accent-color);
        }

        .error-msg { border-left-color: #ff4444; background: #2a0000; }

        .loading {
            text-align: center;
            font-style: italic;
            padding: 20px;
            font-size: 1.3em;
            background: #222;
            border-radius: 8px;
        }

        .controls {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: #000;
            padding: 15px;
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .file-label {
            display: block;
            background: #333;
            color: #fff;
            text-align: center;
            padding: 12px;
            border: 1px dashed #777;
            border-radius: 6px;
            cursor: pointer;
        }
        #file-input { display: none; }

        .search-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
        }
        .search-toggle input {
            width: 25px;
            height: 25px;
            margin: 0;
        }

        .sources-section {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #444;
            font-size: 0.9em;
        }
        .sources-section h4 { margin: 0 0 5px 0; color: #aaa; }
        .sources-section a { color: var(--link-color); display: block; margin-bottom: 5px; text-decoration: none; }
        .sources-section a:hover { text-decoration: underline; }

        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 1em; }
        .markdown-body strong { color: var(--accent-color); }
        .markdown-body ul { padding-left: 25px; }
        .markdown-body p { margin-bottom: 15px; }
        .markdown-body a { color: var(--link-color); }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 tabindex="0">AI è¦–è¦ºåŠ©ç† (è¯ç¶²ç‰ˆ)</h1>
    </header>

    <!-- è¨­å®šå€åŸŸ -->
    <details id="settings-area">
        <summary>è¨­å®šé¸é … (é»æ­¤å±•é–‹)</summary>
        <div>
            <label for="api-key">Google Gemini API Key:</label>
            <input type="password" id="api-key" placeholder="è²¼ä¸Š AIza é–‹é ­çš„é‡‘é‘°">
            
            <button onclick="checkAndSaveKeys()" class="secondary">æ›´æ–° Key ä¸¦åµæ¸¬æ¨¡å‹</button>
            
            <label for="model-select">é¸æ“‡æ¨¡å‹:</label>
            <select id="model-select">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (æ¨è–¦)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash (å¦‚æœ‰)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (å¼·å¤§)</option>
            </select>
            <div id="model-status" role="status"></div>

            <label for="system-prompt">é è¨­æŒ‡ä»¤:</label>
            <textarea id="system-prompt"></textarea>
            
            <button onclick="saveSettings()">å„²å­˜è¨­å®š</button>
            <p id="save-status" role="status"></p>
        </div>
    </details>

    <!-- è¼¸å‡ºå€åŸŸ -->
    <main id="chat-output" aria-live="polite">
        <div class="message">
            <strong>ç³»çµ±å°±ç·’ã€‚</strong><br>
            è¼¸å…¥æ–‡å­—å¾Œï¼ŒæŒ‰ <strong>Enter</strong> éµå³å¯å‚³é€ã€‚<br>
            å¦‚éœ€æŸ¥å¤©æ°£æˆ–æ–°èï¼Œè«‹å‹¾é¸ã€Œå•Ÿç”¨ Google æœå°‹ã€ã€‚
        </div>
    </main>
</div>

<!-- åº•éƒ¨æ“ä½œå€ -->
<footer class="controls">
    <div class="search-toggle">
        <input type="checkbox" id="enable-search">
        <label for="enable-search" style="margin:0; cursor:pointer;">å•Ÿç”¨ Google æœå°‹ (æŸ¥å¤©æ°£/æ–°èç”¨)</label>
    </div>

    <label for="file-input" class="file-label" id="file-label-text">ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§</label>
    <input type="file" id="file-input" accept="image/*" capture="environment" onchange="updateFileLabel()">
    
    <label for="user-input" class="sr-only">è¼¸å…¥å•é¡Œ</label>
    <input type="text" id="user-input" placeholder="è¼¸å…¥å•é¡Œ... (æŒ‰ Enter å‚³é€)" autocomplete="off">
    
    <button id="submit-btn" onclick="handleSubmission()">éäº¤ (å‚³é€)</button>
</footer>

<script>
    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š
ä½ æ˜¯ä¸€ä½è¦–éšœè¼”åŠ©åŠ©ç†ï¼Œè«‹ç”¨ç¹é«”ä¸­æ–‡(é¦™æ¸¯)å›ç­”ã€‚
# ä»»å‹™
1. è‹¥æœ‰åœ–ç‰‡ï¼šæè¿°é‡é»ç´°ç¯€ã€‚
2. è‹¥ä½¿ç”¨æœå°‹ï¼šè«‹æ•´åˆæœå°‹çµæœï¼Œç›´æ¥å›ç­”é‡é»ï¼Œä¸¦æ¨™è¨»ä¾†æºã€‚
3. èªæ°£ï¼šè¦ªåˆ‡ã€ç²¾ç°¡ã€é‡é»åœ¨å…ˆã€‚`;

    window.onload = function() {
        loadSettings();
        const key = localStorage.getItem('gemini_api_key');
        if (!key) {
            document.getElementById('settings-area').open = true;
            document.getElementById('api-key').focus();
        } else {
            // è‡ªå‹•å°‡ç„¦é»æ”¾åˆ°è¼¸å…¥æ¡†
            document.getElementById('user-input').focus();
        }

        // === æ–°å¢ï¼šEnter éµç›£è½äº‹ä»¶ ===
        const userInput = document.getElementById('user-input');
        userInput.addEventListener('keydown', function(event) {
            // æª¢æŸ¥æ˜¯å¦æŒ‰äº† Enter
            // event.isComposing ç”¨ä¾†åˆ¤æ–·æ˜¯å¦æ­£åœ¨é€²è¡Œè¼¸å…¥æ³•çµ„å­— (ä¾‹å¦‚æ³¨éŸ³/å€‰é ¡é¸å­—ä¸­)
            // åªæœ‰åœ¨éçµ„å­—ç‹€æ…‹ä¸‹æŒ‰ Enter æ‰æœƒé€å‡º
            if (event.key === 'Enter' && !event.isComposing) {
                event.preventDefault(); // é˜²æ­¢é è¨­æ›è¡Œæˆ–å…¶ä»–è¡Œç‚º
                handleSubmission();     // åŸ·è¡Œéäº¤å‡½å¼
            }
        });
    };

    function loadSettings() {
        const savedPrompt = localStorage.getItem('gemini_system_prompt');
        const savedKey = localStorage.getItem('gemini_api_key');
        const savedModel = localStorage.getItem('gemini_model');
        
        document.getElementById('system-prompt').value = savedPrompt || DEFAULT_PROMPT;
        if (savedKey) document.getElementById('api-key').value = savedKey;
        if (savedModel) {
            const select = document.getElementById('model-select');
            if (![...select.options].some(o => o.value === savedModel)) {
                let opt = document.createElement('option');
                opt.value = savedModel;
                opt.text = savedModel + " (è‡ªè¨‚)";
                select.add(opt);
            }
            select.value = savedModel;
        }
    }

    function updateFileLabel() {
        const file = document.getElementById('file-input').files[0];
        const label = document.getElementById('file-label-text');
        if (file) {
            label.textContent = `âœ… å·²é¸æ“‡ï¼š${file.name}`;
            label.style.background = "#004400";
        } else {
            label.textContent = "ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§";
            label.style.background = "#333";
        }
    }

    async function checkAndSaveKeys() {
        const key = document.getElementById('api-key').value.trim();
        const statusDiv = document.getElementById('model-status');
        const select = document.getElementById('model-select');

        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }
        statusDiv.textContent = "é€£ç·šä¸­...";
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
            const data = await response.json();
            
            select.innerHTML = "";
            let bestModel = "";
            
            if (data.models) {
                const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes("generateContent"));
                validModels.sort((a, b) => b.name.includes('flash') - a.name.includes('flash'));

                validModels.forEach(m => {
                    const id = m.name.replace("models/", "");
                    let opt = document.createElement("option");
                    opt.value = id;
                    opt.text = `${m.displayName} (${id})`;
                    select.appendChild(opt);
                    if (!bestModel && id.includes("flash")) bestModel = id;
                });
            }
            if (bestModel) select.value = bestModel;
            statusDiv.textContent = "âœ… å·²æ›´æ–°æ¨¡å‹";
            localStorage.setItem('gemini_api_key', key);
        } catch (e) {
            statusDiv.textContent = "âŒ éŒ¯èª¤: " + e.message;
        }
    }

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('api-key').value.trim());
        localStorage.setItem('gemini_system_prompt', document.getElementById('system-prompt').value);
        localStorage.setItem('gemini_model', document.getElementById('model-select').value);
        
        const status = document.getElementById('save-status');
        status.textContent = "è¨­å®šå·²å„²å­˜ï¼";
        setTimeout(() => status.textContent = "", 3000);
        document.getEle
