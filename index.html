<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦–éšœè¼”åŠ© AI åŠ©ç† (è‡ªå‹•åµæ¸¬ç‰ˆ)</title>
    <!-- å¼•å…¥ Markdown è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00; /* é»ƒè‰²é«˜å°æ¯” */
            --input-bg: #333333;
            --border-color: #555555;
            --button-bg: #FFFF00;
            --button-text: #000000;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 10px;
            font-size: 18px;
            line-height: 1.6;
        }

        *:focus {
            outline: 4px solid var(--accent-color);
            outline-offset: 2px;
        }

        h1, h2, h3 { color: var(--text-color); }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 120px; /* é ç•™åº•éƒ¨ç©ºé–“ */
        }

        /* è¨­å®šå€å¡Š */
        details {
            background: #1a1a1a;
            border: 2px solid var(--border-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        summary {
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 5px;
            list-style: none; /* éš±è—é è¨­ç®­é ­ */
        }
        
        summary::after {
            content: " (é»æ“Šå±•é–‹/æ”¶åˆ)";
            font-size: 0.8em;
            font-weight: normal;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }

        input[type="text"], 
        input[type="password"], 
        textarea,
        select {
            width: 100%;
            padding: 15px;
            margin-top: 8px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 18px; /* å¢å¤§è¼¸å…¥æ¡†å­—é«” */
            border-radius: 6px;
            box-sizing: border-box;
        }

        textarea {
            min-height: 120px;
            font-family: monospace;
        }

        button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 15px 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            border-radius: 8px;
        }

        button:disabled {
            background-color: #555;
            color: #aaa;
            cursor: not-allowed;
        }

        button.secondary {
            background-color: #333;
            color: #fff;
            border: 1px solid #777;
            margin-top: 10px;
        }

        /* ç‹€æ…‹é¡¯ç¤º */
        #model-status {
            margin-top: 10px;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* èŠå¤©é¡¯ç¤ºå€ */
        .message {
            background: #1e1e1e;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 6px solid var(--accent-color);
        }

        .error-msg {
            border-left-color: #ff4444;
            background: #2a0000;
        }

        .loading {
            text-align: center;
            font-style: italic;
            padding: 20px;
            font-size: 1.3em;
            background: #222;
        }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            padding: 15px;
            border-top: 2px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        #file-input-container {
            position: relative;
        }

        /* è‡ªå®šç¾©æª”æ¡ˆä¸Šå‚³æŒ‰éˆ•å¤–è§€ */
        .file-label {
            display: block;
            background: #333;
            color: #fff;
            text-align: center;
            padding: 12px;
            border: 1px dashed #777;
            border-radius: 6px;
            cursor: pointer;
        }
        
        #file-input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* Markdown æ¨£å¼ */
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-top: 1em;}
        .markdown-body strong { color: var(--accent-color); }
        .markdown-body ul { padding-left: 25px; }
        .markdown-body p { margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1 tabindex="0">AI è¦–è¦ºåŠ©ç†</h1>
    </header>

    <!-- è¨­å®šå€åŸŸ -->
    <details id="settings-area">
        <summary>è¨­å®šé¸é … (API Key èˆ‡ æ¨¡å‹é¸æ“‡)</summary>
        <div>
            <label for="api-key">Google Gemini API Key:</label>
            <input type="password" id="api-key" placeholder="è²¼ä¸Š AIza é–‹é ­çš„é‡‘é‘°">
            
            <button onclick="checkAndSaveKeys()" class="secondary">æ›´æ–° Key ä¸¦åµæ¸¬æ¨¡å‹</button>
            
            <label for="model-select">é¸æ“‡ AI æ¨¡å‹:</label>
            <select id="model-select">
                <option value="gemini-1.5-flash">é è¨­ (Gemini 1.5 Flash)</option>
                <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                <option value="gemini-1.5-flash-001">Gemini 1.5 Flash (001)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
            </select>
            <div id="model-status" role="status"></div>

            <label for="system-prompt">é è¨­ç³»çµ±æŒ‡ä»¤ (System Prompt):</label>
            <textarea id="system-prompt"></textarea>
            
            <button onclick="saveSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
            <p id="save-status" role="status"></p>
        </div>
    </details>

    <!-- è¼¸å‡ºå€åŸŸ -->
    <main id="chat-output" aria-live="polite">
        <div class="message">
            æ­¡è¿ä½¿ç”¨ã€‚è«‹ç¢ºèªè¨­å®šä¸­çš„ API Key å·²æ­£ç¢ºè¼¸å…¥ã€‚<br>
            æ¥ä¸‹ä¾†è«‹è¼¸å…¥æ–‡å­—æˆ–é»æ“Šã€Œä¸Šå‚³/æ‹ç…§ã€ä¾†é–‹å§‹ã€‚
        </div>
    </main>
</div>

<!-- åº•éƒ¨æ“ä½œå€ -->
<footer class="controls">
    <!-- æª”æ¡ˆä¸Šå‚³ (æ”¯æ´ç›¸æ©Ÿ) -->
    <div id="file-input-container">
        <div class="file-label" id="file-label-text">ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§</div>
        <input type="file" id="file-input" accept="image/*" capture="environment" onchange="updateFileLabel()">
    </div>
    
    <!-- æ–‡å­—è¼¸å…¥ -->
    <label for="user-input" class="sr-only">è¼¸å…¥å•é¡Œ</label>
    <input type="text" id="user-input" placeholder="è¼¸å…¥å•é¡Œ..." autocomplete="off">
    
    <!-- éäº¤æŒ‰éˆ• -->
    <button id="submit-btn" onclick="handleSubmission()">éäº¤ (å‚³é€)</button>
</footer>

<script>
    // === é è¨­æŒ‡ä»¤ ===
    const DEFAULT_PROMPT = `# è§’è‰²è¨­å®š (Persona)
ä½ æ˜¯ä¸€ä½å°ˆç‚ºè¦–éšœäººå£«æœå‹™çš„ AI åŠ©ç†ã€‚æ ¸å¿ƒè·è²¬æ˜¯æˆç‚ºç”¨æˆ¶çš„çœ¼ç›ï¼Œæä¾›å®‰å…¨ã€ç²¾æº–ä¸”é©åˆæœ—è®€çš„è³‡è¨Šã€‚

# è¦å‰‡
1. **èªè¨€**ï¼šç¹é«”ä¸­æ–‡ï¼ˆé¦™æ¸¯æ…£ç”¨ï¼‰ã€‚ç¿»è­¯æ™‚ä¸é¡¯ç¤ºåŸæ–‡ã€‚
2. **æ ¼å¼**ï¼šå¤šç”¨æ¨™é¡Œ (#) èˆ‡æ¸…å–® (-)ï¼Œä¸ä½¿ç”¨è£é£¾ç¬¦è™Ÿã€‚
3. **é¢¨æ ¼**ï¼šç²¾ç°¡æ´—éŠï¼Œçµè«–åœ¨å…ˆã€‚

# ä»»å‹™
A. **æ–‡å­—**ï¼šç›´æ¥ç¿»è­¯æˆ–æœ—è®€ã€‚
B. **åœ–åƒ**ï¼šæè¿°å ´æ™¯ã€äººç‰©ã€ç‰©å“ç´°ç¯€ã€‚
C. **åŒ…è£**ï¼šè­˜åˆ¥ç”¢å“åç¨±èˆ‡ç”¨é€”ã€‚`;

    // === åˆå§‹åŒ– ===
    window.onload = function() {
        loadSettings();
        const key = localStorage.getItem('gemini_api_key');
        if (!key) {
            document.getElementById('settings-area').open = true;
            document.getElementById('api-key').focus();
        } else {
            // å¦‚æœæœ‰ Key ä½†æ²’æœ‰é¸éæ¨¡å‹ï¼Œå˜—è©¦è‡ªå‹•æ›´æ–°ä¸€æ¬¡
            if(!localStorage.getItem('gemini_model')) {
                checkAndSaveKeys();
            }
        }
    };

    // === è¨­å®šç®¡ç† ===
    function loadSettings() {
        const savedPrompt = localStorage.getItem('gemini_system_prompt');
        const savedKey = localStorage.getItem('gemini_api_key');
        const savedModel = localStorage.getItem('gemini_model');
        
        document.getElementById('system-prompt').value = savedPrompt || DEFAULT_PROMPT;
        if (savedKey) document.getElementById('api-key').value = savedKey;
        if (savedModel) {
            // å¦‚æœä¸‹æ‹‰é¸å–®è£¡æ²’æœ‰é€™å€‹æ¨¡å‹ï¼Œå‹•æ…‹åŠ é€²å»
            const select = document.getElementById('model-select');
            if (![...select.options].some(o => o.value === savedModel)) {
                let opt = document.createElement('option');
                opt.value = savedModel;
                opt.text = savedModel + " (å·²å„²å­˜)";
                select.add(opt);
            }
            select.value = savedModel;
        }
    }

    // æ›´æ–°æª”æ¡ˆæŒ‰éˆ•æ–‡å­—
    function updateFileLabel() {
        const file = document.getElementById('file-input').files[0];
        const label = document.getElementById('file-label-text');
        if (file) {
            label.textContent = `âœ… å·²é¸æ“‡ï¼š${file.name}`;
            label.style.background = "#004400";
        } else {
            label.textContent = "ğŸ“¸ é»æ­¤ä¸Šå‚³åœ–ç‰‡æˆ–æ‹ç…§";
            label.style.background = "#333";
        }
    }

    // === è‡ªå‹•åµæ¸¬æ¨¡å‹åŠŸèƒ½ ===
    async function checkAndSaveKeys() {
        const key = document.getElementById('api-key').value.trim();
        const statusDiv = document.getElementById('model-status');
        const select = document.getElementById('model-select');

        if (!key) {
            alert("è«‹å…ˆè¼¸å…¥ API Key");
            return;
        }

        statusDiv.textContent = "æ­£åœ¨é€£ç·š Google å–å¾—å¯ç”¨æ¨¡å‹åˆ—è¡¨...";
        
        try {
            // å‘¼å« Google API åˆ—å‡ºæ¨¡å‹
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
            
            if (!response.ok) throw new Error("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key");

            const data = await response.json();
            
            // æ¸…ç©ºèˆŠé¸é …
            select.innerHTML = "";
            let bestModel = "";

            if (data.models) {
                // éæ¿¾å‡ºæ”¯æ´ generateContent çš„æ¨¡å‹
                const validModels = data.models.filter(m => 
                    m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
                );

                // æ’åºï¼šå„ªå…ˆæ‰¾ flash, ç„¶å¾Œæ˜¯ pro
                validModels.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA.includes('flash') && !nameB.includes('flash')) return -1;
                    if (!nameA.includes('flash') && nameB.includes('flash')) return 1;
                    return 0;
                });

                validModels.forEach(m => {
                    // m.name æ ¼å¼é€šå¸¸æ˜¯ "models/gemini-1.5-flash"
                    // æˆ‘å€‘åªéœ€è¦å¾Œé¢çš„ ID
                    const modelId = m.name.replace("models/", "");
                    let option = document.createElement("option");
                    option.value = modelId;
                    option.text = `${m.displayName} (${modelId})`;
                    select.appendChild(option);

                    // è‡ªå‹•é¸æ“‡é‚è¼¯ï¼šå„ªå…ˆé¸æœ€æ–°çš„ Flash
                    if (!bestModel && modelId.includes("flash")) bestModel = modelId;
                });

                // å¦‚æœæ‰¾ä¸åˆ° flashï¼Œå°±é¸ç¬¬ä¸€å€‹
                if (!bestModel && validModels.length > 0) {
                    bestModel = validModels[0].name.replace("models/", "");
                }
            }

            if (bestModel) {
                select.value = bestModel;
                statusDiv.textContent = `âœ… æˆåŠŸï¼å·²è‡ªå‹•é¸å–æ¨è–¦æ¨¡å‹ï¼š${bestModel}`;
            } else {
                statusDiv.textContent = "âš ï¸ ç„¡æ³•è‡ªå‹•åµæ¸¬åˆ°åˆé©æ¨¡å‹ï¼Œè«‹æ‰‹å‹•é¸æ“‡æˆ–æª¢æŸ¥ Key æ¬Šé™ã€‚";
                // æ¢å¾©é è¨­é¸é …
                select.innerHTML = `
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash (Latest)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                `;
            }

            // é †ä¾¿å„²å­˜ Key
            localStorage.setItem('gemini_api_key', key);

        } catch (e) {
            console.error(e);
            statusDiv.textContent = `âŒ åµæ¸¬å¤±æ•—ï¼š${e.message}ã€‚è«‹ç¢ºèªç¶²è·¯æˆ– Key æ˜¯å¦æ­£ç¢ºã€‚`;
        }
    }

    function saveSettings() {
        const key = document.getElementById('api-key').value.trim();
        const prompt = document.getElementById('system-prompt').value;
        const model = document.getElementById('model-select').value;
        
        if (!key) { alert("è«‹è¼¸å…¥ API Key"); return; }

        localStorage.setItem('gemini_api_key', key);
        localStorage.setItem('gemini_system_prompt', prompt);
        localStorage.setItem('gemini_model', model);
        
        const status = document.getElementById('save-status');
        status.textContent = "è¨­å®šå·²å„²å­˜ï¼";
        setTimeout(() => status.textContent = "", 3000);
        document.getElementById('settings-area').open = false;
        
        // æç¤º
        document.getElementById('chat-output').innerHTML = `<div class="message">è¨­å®šå·²æ›´æ–°ã€‚ç›®å‰ä½¿ç”¨æ¨¡å‹ï¼š<strong>${model}</strong></div>`;
    }

    // === ä¸»è¦åŠŸèƒ½é‚è¼¯ ===
    async function handleSubmission() {
        const apiKey = localStorage.getItem('gemini_api_key');
        // å„ªå…ˆä½¿ç”¨å„²å­˜çš„æ¨¡å‹ï¼Œè‹¥ç„¡å‰‡ç”¨é è¨­
        const modelName = localStorage.getItem('gemini_model') || "gemini-1.5-flash"; 

        if (!apiKey) {
            alert("è«‹å…ˆåœ¨è¨­å®šä¸­è¼¸å…¥ Google API Key");
            document.getElementById('settings-area').open = true;
            return;
        }

        const submitBtn = document.getElementById('submit-btn');
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const outputDiv = document.getElementById('chat-output');
        const systemPrompt = localStorage.getItem('gemini_system_prompt') || DEFAULT_PROMPT;

        const text = userInput.value.trim();
        const file = fileInput.files[0];

        if (!text && !file) {
            alert("è«‹è¼¸å…¥æ–‡å­—æˆ–é¸æ“‡ä¸€å¼µåœ–ç‰‡");
            return;
        }

        // é–å®šä»‹é¢
        submitBtn.disabled = true;
        submitBtn.textContent = "åˆ†æä¸­...";
        outputDiv.innerHTML = `<div class="loading">æ­£åœ¨ä½¿ç”¨ ${modelName} åˆ†æ...</div>`;

        try {
            let contentsParts = [];
            let fullTextPrompt = systemPrompt + "\n\nç”¨æˆ¶æŒ‡ä»¤ï¼š\n" + (text || "è«‹è©³ç´°æè¿°åœ–ç‰‡å…§å®¹");
            contentsParts.push({ text: fullTextPrompt });

            if (file) {
                const base64Data = await fileToBase64(file);
                contentsParts.push({
                    inline_data: {
                        mime_type: file.type,
                        data: base64Data
                    }
                });
            }

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: contentsParts }],
                    generationConfig: {
                        temperature: 0.5,
                        maxOutputTokens: 1000
                    }
                })
            });

            const data = await response.json();

            if (!response.ok) {
                const errorMsg = data.error ? data.error.message : response.statusText;
                throw new Error(`API å›æ‡‰éŒ¯èª¤ (${response.status}): ${errorMsg}`);
            }
            
            if (data.candidates && data.candidates[0].content) {
                const markdownText = data.candidates[0].content.parts[0].text;
                const htmlContent = marked.parse(markdownText);
                outputDiv.innerHTML = `<div class="message markdown-body">${htmlContent}</div>`;
                
                // æ¸…ç©ºè¼¸å…¥
                userInput.value = "";
                fileInput.value = ""; 
                updateFileLabel();
            } else {
                outputDiv.innerHTML = '<div class="message error-msg">AI æ²’æœ‰å›å‚³å…§å®¹ï¼Œå¯èƒ½è¢«å®‰å…¨éæ¿¾å™¨é˜»æ“‹ã€‚</div>';
            }

        } catch (error) {
            console.error(error);
            let suggestion = "";
            if (error.message.includes("404")) {
                suggestion = "<br><strong>å»ºè­°ï¼šè«‹åˆ°è¨­å®šä¸­é»æ“Šã€Œæ›´æ–° Key ä¸¦åµæ¸¬æ¨¡å‹ã€ï¼Œé‡æ–°é¸æ“‡ä¸€å€‹æœ‰æ•ˆçš„æ¨¡å‹ã€‚</strong>";
            }
            outputDiv.innerHTML = `<div class="message error-msg">
                <h3>ç™¼ç”ŸéŒ¯èª¤</h3>
                <p>${error.message}</p>
                ${suggestion}
            </div>`;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "éäº¤ (å‚³é€)";
            outputDiv.focus();
        }
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
