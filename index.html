<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI è¦–éšœåŠ©ç† (2025 æœ€æ–°ç‰ˆ)</title>
    <!-- å¼•å…¥ Marked.js è§£æ Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.2/lib/marked.umd.min.js"></script>
    
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --accent-color: #FFFF00;     /* é»ƒè‰²é«˜äº®ï¼Œé©åˆè¦–éšœä½¿ç”¨ */
            --border-color: #555;
            --input-bg: #1A1A1A;
            --button-bg: #FFFF00;
            --button-text: #000000;
            --link-color: #88CCFF;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            font-size: 1.2rem; line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px 10px 350px 10px; /* åº•éƒ¨ç•™ç™½çµ¦å›ºå®šæ§åˆ¶åˆ— */
        }

        /* === æ¨™é¡Œå±¤ç´š === */
        .app-title { 
            font-size: 1.5rem; 
            text-align: center; 
            margin: 10px 0; 
            color: #ccc;
            font-weight: bold;
        }
        
        h2 { 
            font-size: 1.4rem; 
            color: var(--accent-color); 
            border-bottom: 2px solid #333; 
            padding-bottom: 5px; 
            margin-top: 30px; 
            outline: none;
        }

        /* === è¼¸å…¥èˆ‡äº’å‹•å…ƒä»¶ === */
        *:focus-visible {
            outline: 4px solid var(--accent-color) !important;
            outline-offset: 2px;
        }

        input, select, textarea {
            width: 100%; padding: 12px; margin-top: 5px; margin-bottom: 10px;
            background: var(--input-bg); border: 2px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem;
            border-radius: 6px; box-sizing: border-box;
        }

        button {
            background-color: var(--button-bg); color: var(--button-text);
            border: 2px solid #fff; padding: 12px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
            border-radius: 8px; margin-top: 5px;
            touch-action: manipulation;
        }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(100%); }
        button.secondary { background-color: #333; color: #fff; border-color: #777; }
        
        /* === è¨­å®šå€åŸŸ === */
        details {
            border: 1px solid var(--border-color); padding: 10px;
            border-radius: 8px; margin-bottom: 10px; background: #111;
        }
        summary { cursor: pointer; list-style: none; padding: 5px; }
        summary:focus { background-color: #222; border-radius: 4px; }
        summary::-webkit-details-marker { display: none; }
        summary h2 { display: inline-block; margin: 0; border: none; font-size: 1.2rem; }
        
        /* === è¨Šæ¯é¡¯ç¤ºå€ === */
        .message-area { min-height: 100px; padding-bottom: 20px; }
        .message {
            background: #111; padding: 15px; margin-bottom: 15px;
            border-left: 5px solid var(--accent-color);
            overflow-wrap: break-word;
            word-break: break-word;
        }
        .message:focus {
            outline: 4px solid var(--accent-color);
            background-color: #1a1a1a;
        }
        .message.user { border-left-color: #0088ff; background: #0a0a1a; }
        .message.error { border-left-color: #ff0000; background: #330000; }
        .message.info { border-left-color: #88CCFF; background: #0a1a2a; } 

        /* === åº•éƒ¨å›ºå®šæ§åˆ¶å€ === */
        .controls-wrapper {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #000; border-top: 3px solid var(--accent-color);
            padding: 10px; z-index: 100;
            box-shadow: 0 -2px 10px rgba(255, 255, 0, 0.1);
        }

        .row { display: flex; gap: 10px; margin-bottom: 8px; align-items: stretch; }
        
        /* Checkbox æ¨£å¼ */
        .check-btn {
            display: flex; align-items: center; justify-content: center;
            background: #222; border: 1px solid #555; color: #fff;
            padding: 10px; border-radius: 6px; cursor: pointer; flex: 1;
            font-size: 1rem; user-select: none;
        }
        .check-btn:focus-within { outline: 4px solid var(--accent-color); }
        .check-btn input { width: 20px; height: 20px; margin: 0 8px 0 0; cursor: pointer; }

        /* === ç‹€æ…‹æç¤º (Toast) === */
        #status-toast {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(255, 255, 0, 0.95); color: #000;
            padding: 20px 40px; border-radius: 10px;
            font-weight: bold; font-size: 1.5rem; text-align: center;
            z-index: 2000; pointer-events: none;
            opacity: 0; transition: opacity 0.3s;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        #status-toast.show { opacity: 1; }

        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

        /* Markdown æ¨£å¼å¾®èª¿ */
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { border-bottom: none; margin-top: 1.5em; color: var(--link-color); }
        .markdown-body p { margin-bottom: 10px; }
        .markdown-body ul, .markdown-body ol { padding-left: 25px; margin-bottom: 10px; }
        .markdown-body li { margin-bottom: 5px; }
        .markdown-body a { color: var(--accent-color); text-decoration: underline; }
        .markdown-body code { background: #333; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .markdown-body pre { background: #222; padding: 10px; overflow-x: auto; border-radius: 6px; border: 1px solid #444; }
        .markdown-body table { border-collapse: collapse; width: 100%; margin: 10px 0; border: 1px solid #444; }
        .markdown-body th, .markdown-body td { border: 1px solid #444; padding: 8px; text-align: left; }
        .markdown-body th { background-color: #222; color: var(--accent-color); }
    </style>
</head>
<body>

<!-- ç‹€æ…‹æç¤ºæ¡† -->
<div id="status-toast" role="status" aria-live="polite"></div>

<div class="container">
    <h1 class="app-title">AI è¦–éšœåŠ©ç† (2025.12 æœ€æ–°ç‰ˆ)</h1>

    <!-- å€åŸŸ 1: è¨­å®š -->
    <details id="settings-area">
        <summary role="button" aria-expanded="false" accesskey="s">
            <h2>âš™ï¸ è¨­å®š (Alt+S)</h2>
        </summary>
        
        <div style="margin-top: 15px;">
            <label for="provider-select">AI æœå‹™å•†:</label>
            <select id="provider-select" onchange="handleProviderChange()">
                <option value="gemini">Google Gemini (å…è²»/3.0 Pro)</option>
                <option value="openrouter">OpenRouter (DeepSeek V3.2)</option>
                <option value="groq">Groq (Llama 3.3 æ¥µé€Ÿ)</option>
                <option value="openai">OpenAI (GPT-5.1)</option>
                <option value="perplexity">Perplexity (Sonar Deep Search)</option>
            </select>

            <label for="api-key">API Key (é‡‘é‘°):</label>
            <input type="password" id="api-key" placeholder="åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ API Key" autocomplete="off">
            
            <label for="model-input">æ¨¡å‹ ID:</label>
            <div class="row" style="margin-bottom: 10px;">
                <input type="text" id="model-input" list="model-list" placeholder="é¸æ“‡æˆ–è¼¸å…¥ ID" style="margin-bottom:0;" autocomplete="off">
                <datalist id="model-list"></datalist>
                <button type="button" id="refresh-btn" class="secondary" style="width: auto; margin-top:0;" onclick="fetchOnlineModels()" title="æ›´æ–°æ¨¡å‹æ¸…å–®" aria-label="æ›´æ–°æ¨¡å‹æ¸…å–®">ğŸ”„</button>
            </div>

            <label for="system-prompt" id="prompt-label">è§’è‰²æŒ‡ä»¤ (ç›®å‰æœå‹™å•†):</label>
            <textarea id="system-prompt" rows="5" aria-labelledby="prompt-label"></textarea>

            <div class="row">
                <button type="button" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <button type="button" onclick="restoreDefaults()" class="secondary">â†©ï¸ æ¢å¾©é è¨­</button>
                <button type="button" onclick="showHelp()" class="secondary" style="background:#004488; color:white; border-color:#5599ff;">ğŸ“– ä½¿ç”¨èªªæ˜</button>
            </div>
        </div>
    </details>

    <!-- å€åŸŸ 2: çµæœé¡¯ç¤º -->
    <main>
        <h2 id="result-heading" tabindex="-1">å°è©±çµæœ</h2>
        
        <!-- å°è©±å…§å®¹å€ -->
        <div id="chat-output" class="message-area"></div>
        
        <!-- è¤‡è£½æŒ‰éˆ• -->
        <button type="button" id="copy-btn" class="secondary hidden" onclick="copyResult()" accesskey="c" style="width:100%; margin-bottom: 20px;">
            ğŸ“‹ è¤‡è£½çµæœ (Alt+C)
        </button>
    </main>
</div>

<!-- å€åŸŸ 3: åº•éƒ¨å›ºå®šæ§åˆ¶åˆ— -->
<footer class="controls-wrapper" role="region" aria-label="æ“ä½œå€">
    <form onsubmit="handleSubmit(event)">
        <!-- åŠŸèƒ½é–‹é—œèˆ‡ä¸Šå‚³ -->
        <div class="row">
            <label class="check-btn">
                <input type="checkbox" id="enable-search" checked>
                <span>è¯ç¶²æœå°‹</span>
            </label>
            
            <label class="check-btn">
                <input type="checkbox" id="pause-send">
                <span>æš«åœå‚³é€</span>
            </label>
        </div>

        <div class="row">
            <input type="file" id="file-input" class="visually-hidden" accept="image/*,application/pdf" onchange="handleFileSelect()">
            <button type="button" id="upload-btn" class="secondary" onclick="document.getElementById('file-input').click()" accesskey="u">
                ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)
            </button>
        </div>
        
        <!-- æ–‡å­—è¼¸å…¥ -->
        <div class="row">
            <input type="text" id="user-input" placeholder="è¼¸å…¥è¨Šæ¯..." accesskey="i" autocomplete="off" style="margin:0;">
            <button type="submit" id="submit-btn" style="width: 90px; margin:0;">å‚³é€</button>
        </div>
    </form>
</footer>

<script>
    // === çµ±ä¸€çš„é è¨­æŒ‡ä»¤ ===
    const UNIFIED_DEFAULT_PROMPT = `å¿…é ˆè¼¸å‡ºç¹é«”ä¸­æ–‡.
è«‹é©ç•¶åˆ©ç”¨ Markdown æ¨™é¡Œå±¤ç´šè¼¸å‡ºçµæœ.
é‡åˆ°åœ–ç‰‡å°±é€²è¡Œå·¨ç´°ç„¡éºã€å®¢è§€ã€æº–ç¢ºçš„æè¿°.
åœ–ç‰‡åŒ…å«æ–‡å­—å°±ä½œ OCR ç„¶å¾Œå…¨éƒ¨é¡¯ç¤ºå‡ºä¾†ã€‚
è‹¥è¦ä¸Šç¶²æœå°‹å°±å‹™å¿…æœå°‹ 2025 å¹´ 12 æœˆçš„æœ€æ–°è³‡æ–™ã€‚`;

    // === èªªæ˜æ–‡ä»¶å…§å®¹ (Markdown) ===
    const HELP_CONTENT = `
# AI è¦–éšœåŠ©ç†ä½¿ç”¨æ‰‹å†Š (2025.12 ç‰ˆ)

æ•´åˆä»Šæ—¥ (2025/12/04) æœ€æ–°ç™¼å¸ƒçš„ Gemini 3.0 Pro èˆ‡ GPT-5.1ï¼Œç‚ºæ‚¨æä¾›æœ€æº–ç¢ºçš„è¦–è¦ºèˆ‡æ–‡å­—è¼”åŠ©ã€‚

## å¿«é€Ÿéµåˆ—è¡¨

*   **Alt + S**ï¼šé–‹å•Ÿ/é—œé–‰ã€Œè¨­å®šã€ã€‚
*   **Alt + U**ï¼šé¸æ“‡æª”æ¡ˆæˆ–é–‹å•Ÿç›¸æ©Ÿã€‚
*   **Alt + I**ï¼šè·³è‡³ã€Œæ–‡å­—è¼¸å…¥æ¡†ã€ã€‚
*   **Alt + C**ï¼šè¤‡è£½ AI çš„å›ç­”ã€‚

## ä»Šæ—¥æœ€æ–°æ¨¡å‹ (2025/12/04)

*   **Gemini (æ¨è–¦)**ï¼šé è¨­ \`gemini-3.0-pro-preview\`ã€‚Google æœ€æ–°æ——è‰¦ï¼Œ11/18 å‰›ç™¼å¸ƒã€‚æ”¯æ´æœ€å¼·çš„ PDF èˆ‡åœ–ç‰‡é–±è®€ï¼Œä¸”åœ¨ AI Studio é€šå¸¸æœ‰å…è²»é¡åº¦ã€‚
*   **OpenAI**ï¼šæ”¯æ´ \`gpt-5.1\` (æœ€æ–°ç‰ˆ) èˆ‡ \`gpt-5.1-thinking\`ã€‚
*   **DeepSeek (OpenRouter)**ï¼šæ”¯æ´ \`deepseek/deepseek-v3.2\`ï¼Œè¢«è­½ç‚ºç›®å‰çš„é–‹æºä¹‹ç‹ï¼Œæ¨ç†èƒ½åŠ›æ¥µå¼·ã€‚
*   **Perplexity**ï¼šæ¨è–¦ \`sonar-deep-research\`ï¼Œå°ˆé–€ç”¨æ–¼æ·±åº¦è¯ç¶²æœå°‹ä»Šæ—¥æ–°èã€‚

## ä½¿ç”¨æ­¥é©Ÿ

### 1. åœ–ç‰‡æˆ–æ–‡ä»¶è¾¨è­˜
1.  æŒ‰ä¸‹ **Alt + U**ã€‚
2.  é¸æ“‡åœ–ç‰‡æˆ– PDF (PDF å»ºè­°ä½¿ç”¨ Gemini æ¨¡å¼)ã€‚
3.  ç³»çµ±å°‡ä½¿ç”¨ Gemini 3.0 Pro é€²è¡Œåˆ†æã€‚

### 2. è¨­å®š
*   è‹¥ç™¼ç¾æ¨¡å‹ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æŒ‰è¨­å®šä¸­çš„ã€ŒğŸ”„ã€æ›´æ–°æ¸…å–®ï¼Œæˆ–åˆ‡æ›å›èˆŠç‰ˆç©©å®šçš„ \`gemini-2.5-flash\`ã€‚
`;

    // === 1. æ¨¡å‹è³‡æ–™åº« (2025/12/04 æœ€æ–°æ›´æ–°) ===
    const PROVIDERS = {
        gemini: {
            prompt: UNIFIED_DEFAULT_PROMPT,
            defaultModel: "gemini-3.0-pro-preview", // Google æœ€æ–°ç™¼å¸ƒ
            canFetch: true,
            models: [
                "gemini-3.0-pro-preview",    // 2025.11.18 ç™¼å¸ƒ
                "gemini-3.0-deep-think",     // æ·±åº¦æ€è€ƒç‰ˆ
                "gemini-2.5-flash",          // ç©©å®šå¿«é€Ÿç‰ˆ
                "gemini-2.5-pro",
                "gemini-exp-1204"            // ä»Šæ—¥å¯¦é©—ç‰ˆ
            ],
            listUrl: "https://generativelanguage.googleapis.com/v1beta/models?key={KEY}"
        },
        openrouter: {
            prompt: UNIFIED_DEFAULT_PROMPT,
            defaultModel: "deepseek/deepseek-v3.2", // 2025.12 æœ€æ–°é–‹æºç‹è€…
            canFetch: true,
            models: [
                "deepseek/deepseek-v3.2",
                "deepseek/deepseek-v3.2-speciale",
                "openai/gpt-5.1",
                "google/gemini-3.0-pro-preview",
                "anthropic/claude-3.7-sonnet"
            ],
            listUrl: "https://openrouter.ai/api/v1/models"
        },
        groq: {
            prompt: UNIFIED_DEFAULT_PROMPT,
            defaultModel: "llama-3.3-70b-versatile", // Groq ç›®å‰ä¸»åŠ›
            canFetch: true, 
            models: [
                "llama-3.3-70b-versatile",
                "deepseek-r1-distill-llama-70b",
                "mixtral-8x22b-instruct-v0.1"
            ],
            listUrl: "https://api.groq.com/openai/v1/models"
        },
        openai: {
            prompt: UNIFIED_DEFAULT_PROMPT,
            defaultModel: "gpt-5.1", // 2025.11 æœ€æ–°
            canFetch: false,
            models: [
                "gpt-5.1", 
                "gpt-5.1-thinking",
                "gpt-4o-2025-11-20", 
                "gpt-4o-mini"
            ]
        },
        perplexity: {
            prompt: UNIFIED_DEFAULT_PROMPT,
            defaultModel: "sonar-deep-research", // æœ€æ–°æ·±åº¦æœå°‹
            canFetch: false,
            models: [
                "sonar-deep-research",
                "sonar-reasoning-pro", 
                "sonar-pro"
            ]
        }
    };

    // === 2. åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
        const hasVisited = localStorage.getItem('app_visited_2025_dec');
        const settingsDetails = document.getElementById('settings-area');

        if (!hasVisited) {
            settingsDetails.open = true;
            localStorage.setItem('app_visited_2025_dec', 'true');
        }

        const savedProvider = localStorage.getItem('provider') || 'gemini';
        const providerSelect = document.getElementById('provider-select');
        if (providerSelect.querySelector(`option[value="${savedProvider}"]`)) {
            providerSelect.value = savedProvider;
        }
        handleProviderChange(false);
    });

    // === 3. è¨­å®šé‚è¼¯ ===
    function handleProviderChange(save = true) {
        const pKey = document.getElementById('provider-select').value;
        const conf = PROVIDERS[pKey];

        // è¼‰å…¥è©²æœå‹™å•†çš„è¨­å®š
        document.getElementById('api-key').value = localStorage.getItem(`${pKey}_key`) || "";
        document.getElementById('model-input').value = localStorage.getItem(`${pKey}_model`) || conf.defaultModel;
        document.getElementById('system-prompt').value = localStorage.getItem(`${pKey}_prompt`) || conf.prompt;

        // æ›´æ–°æ¨™ç±¤ä»¥é¡¯ç¤ºç•¶å‰æœå‹™å•†
        const providerName = document.querySelector(`#provider-select option[value="${pKey}"]`).text.split(' ')[0];
        document.getElementById('prompt-label').innerText = `è§’è‰²æŒ‡ä»¤ (${providerName}):`;

        updateDatalist(conf.models);

        const searchCheck = document.getElementById('enable-search');
        if (pKey === 'gemini' || pKey === 'perplexity') {
            searchCheck.disabled = false;
            if(pKey === 'perplexity') searchCheck.checked = true;
        } else {
            searchCheck.disabled = true;
            searchCheck.checked = false;
        }

        const refreshBtn = document.getElementById('refresh-btn');
        refreshBtn.style.display = conf.canFetch ? 'block' : 'none';

        if (save) localStorage.setItem('provider', pKey);
    }

    function updateDatalist(models) {
        const dataList = document.getElementById('model-list');
        dataList.innerHTML = "";
        models.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m;
            dataList.appendChild(opt);
        });
    }

    function saveSettings() {
        const pKey = document.getElementById('provider-select').value;
        const currentPrompt = document.getElementById('system-prompt').value;
        
        localStorage.setItem(`${pKey}_key`, document.getElementById('api-key').value.trim());
        localStorage.setItem(`${pKey}_model`, document.getElementById('model-input').value.trim());
        localStorage.setItem(`${pKey}_prompt`, currentPrompt);
        
        showStatus("è¨­å®šå·²å„²å­˜");
        document.getElementById('settings-area').open = false;
    }

    function restoreDefaults() {
        const pKey = document.getElementById('provider-select').value;
        document.getElementById('system-prompt').value = PROVIDERS[pKey].prompt;
        document.getElementById('model-input').value = PROVIDERS[pKey].defaultModel;
        showStatus("å·²æ¢å¾©é è¨­æŒ‡ä»¤èˆ‡æ¨¡å‹");
    }

    function showHelp() {
        const output = document.getElementById('chat-output');
        const settings = document.getElementById('settings-area');
        
        settings.open = false;
        output.innerHTML = "";
        
        const helpDiv = document.createElement('div');
        helpDiv.className = 'message info markdown-body';
        helpDiv.innerHTML = marked.parse(HELP_CONTENT);
        
        helpDiv.tabIndex = -1;
        output.appendChild(helpDiv);

        document.getElementById('copy-btn').classList.add('hidden');
        
        setTimeout(() => helpDiv.focus(), 100);
    }

    // === 4. ä»‹é¢äº’å‹•èˆ‡å·¥å…·å‡½å¼ ===
    function showStatus(text, type = 'status') {
        const toast = document.getElementById('status-toast');
        toast.innerText = text;
        toast.setAttribute('role', type === 'error' ? 'alert' : 'status');
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }

    function copyResult() {
        const msgs = document.querySelectorAll('.message:not(.user):not(.error):not(.info)');
        if (msgs.length === 0) return;
        
        const text = msgs[msgs.length - 1].innerText;
        navigator.clipboard.writeText(text).then(() => {
            showStatus("å·²è¤‡è£½å…§å®¹");
        }).catch(() => showStatus("è¤‡è£½å¤±æ•—", 'error'));
    }

    function handleFileSelect() {
        const file = document.getElementById('file-input').files[0];
        if (file) {
            document.getElementById('upload-btn').innerText = `âœ… ${file.name}`;
            showStatus(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`);
            
            if (!document.getElementById('pause-send').checked) {
                setTimeout(() => {
                   document.querySelector('footer form').requestSubmit();
                }, 300);
            }
        }
    }

    async function fetchOnlineModels() {
        const pKey = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value;
        const conf = PROVIDERS[pKey];

        if (!key && pKey !== 'gemini') { 
            alert("è«‹å…ˆè¼¸å…¥ API Key æ‰èƒ½å–å¾—æ¸…å–®"); 
            return; 
        }
        
        const btn = document.getElementById('refresh-btn');
        const originalText = btn.innerText;
        btn.innerText = "â³";
        btn.disabled = true;
        
        try {
            let newModels = [];
            
            if (pKey === 'gemini') {
                const res = await fetch(conf.listUrl.replace('{KEY}', key));
                if (!res.ok) throw new Error("API Error: " + res.status);
                const data = await res.json();
                // éæ¿¾ä¸¦ä¿ç•™ 3.0, 2.0 ç­‰æ–°æ¨¡å‹
                newModels = (data.models || [])
                    .map(m => m.name.replace("models/", ""))
                    .filter(m => (m.includes("gemini-3") || m.includes("gemini-2.5")) && !m.includes("1.0"));

            } else if (pKey === 'openrouter') {
                const res = await fetch(conf.listUrl);
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                newModels = (data.data || []).map(m => m.id);

            } else if (pKey === 'groq') {
                const res = await fetch(conf.listUrl, {
                    headers: { 'Authorization': `Bearer ${key}` }
                });
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();
                newModels = (data.data || []).map(m => m.id);
            }

            if (newModels.length > 0) {
                // åˆä½µé è¨­èˆ‡ç·šä¸Šæ¨¡å‹ï¼Œå»é™¤é‡è¤‡
                const allModels = Array.from(new Set([...conf.models, ...newModels]));
                updateDatalist(allModels);
                showStatus(`æ›´æ–°æˆåŠŸï¼Œå…± ${allModels.length} å€‹æ¨¡å‹`);
            } else {
                showStatus("æœªæ‰¾åˆ°å¯ç”¨æ¨¡å‹");
            }
        } catch (e) {
            console.error(e);
            showStatus("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯", 'error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // === 5. å°è©±æ ¸å¿ƒé‚è¼¯ ===
    async function handleSubmit(e) {
        e.preventDefault();
        const pKey = document.getElementById('provider-select').value;
        const key = document.getElementById('api-key').value;
        const model = document.getElementById('model-input').value;
        const prompt = document.getElementById('system-prompt').value; // ç›´æ¥è®€å–ç›®å‰æ–‡å­—æ¡†çš„å€¼
        const userInput = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const output = document.getElementById('chat-output');
        const submitBtn = document.getElementById('submit-btn');

        if (!key) { 
            showStatus("è«‹å…ˆè¼¸å…¥ API Key", 'error'); 
            document.getElementById('settings-area').open = true; 
            document.getElementById('api-key').focus();
            return; 
        }
        
        const hasFile = fileInput.files.length > 0;
        if (!userInput.value && !hasFile) {
            showStatus("è«‹è¼¸å…¥æ–‡å­—æˆ–é¸æ“‡æª”æ¡ˆ");
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = "è™•ç†ä¸­...";

        // æ¸…ç©ºä¹‹å‰çš„çµæœ
        output.innerHTML = "";

        // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
        const userText = userInput.value || (hasFile ? `åˆ†ææª”æ¡ˆ: ${fileInput.files[0].name}` : "...");
        output.innerHTML += `<div class="message user">${safeHtml(userText)}</div>`;
        
        // å»ºç«‹å›æ‡‰å€å¡Š
        const responseDiv = document.createElement('div');
        responseDiv.className = 'message';
        
        responseDiv.setAttribute('role', 'status'); 
        responseDiv.setAttribute('aria-live', 'polite');
        responseDiv.innerText = "ğŸ¤” æ­£åœ¨æ€è€ƒä¸¦åˆ†æ (Model: " + model + ")...";
        output.appendChild(responseDiv);
        
        document.getElementById('copy-btn').classList.add('hidden');
        window.scrollTo(0, document.body.scrollHeight);

        try {
            let base64 = null, mime = null;
            if (hasFile) {
                const file = fileInput.files[0];
                mime = file.type;
                if (mime === 'application/pdf' && pKey !== 'gemini') {
                    throw new Error("PDF æ–‡ä»¶ç›®å‰åƒ…æ”¯æ´ Google Gemini æœå‹™å•†ï¼Œè«‹è‡³è¨­å®šåˆ‡æ›ã€‚");
                }
                base64 = await toBase64(file);
            }

            let text = "";
            const textPrompt = userInput.value || "è«‹è©³ç´°æè¿°é€™å€‹æª”æ¡ˆçš„å…§å®¹ï¼Œå¦‚æœæ˜¯æ–‡å­—è«‹è¾¨è­˜å‡ºä¾†ã€‚";

            if (pKey === 'gemini') {
                text = await callGemini(key, model, prompt, textPrompt, base64, mime);
            } else {
                text = await callOpenAICompatible(pKey, key, model, prompt, textPrompt, base64, mime);
            }

            // === ç¢ºä¿æœ—è®€ ===
            responseDiv.innerHTML = marked.parse(text);
            responseDiv.classList.add('markdown-body');
            
            responseDiv.removeAttribute('role'); 
            responseDiv.removeAttribute('aria-live'); 
            
            responseDiv.setAttribute('tabindex', '-1'); 
            responseDiv.setAttribute('role', 'article'); 
            responseDiv.setAttribute('aria-label', 'AI å›ç­”çµæœ'); 

            document.getElementById('copy-btn').classList.remove('hidden');

            userInput.value = "";
            fileInput.value = "";
            document.getElementById('upload-btn').innerText = "ğŸ“· æ‹æ”/æª”æ¡ˆ (Alt+U)";

            setTimeout(() => {
                responseDiv.focus();
            }, 100);

        } catch (err) {
            responseDiv.className = 'message error';
            
            let errMsg = err.message;
            if (errMsg.includes('404') || errMsg.includes('not found')) {
                errMsg += "\n(æç¤º: è‹¥ " + model + " å°šæœªå°æ‚¨çš„å¸³è™Ÿé–‹æ”¾ï¼Œè«‹å˜—è©¦ gemini-2.5-flash)";
            }
            
            responseDiv.innerText = "éŒ¯èª¤: " + errMsg;
            
            responseDiv.setAttribute('tabindex', '-1');
            responseDiv.setAttribute('role', 'alert');
            setTimeout(() => {
                responseDiv.focus();
            }, 100);
            
            showStatus("ç™¼ç”ŸéŒ¯èª¤", 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "å‚³é€";
            window.scrollTo(0, document.body.scrollHeight);
        }
    }

    // === API å‘¼å«å¯¦ä½œ ===
    async function callGemini(key, model, sys, user, b64, mime) {
        const useSearch = document.getElementById('enable-search').checked;
        const parts = [{text: sys + "\n\nä½¿ç”¨è€…å•é¡Œ: " + user}];
        
        if (b64) {
            parts.push({inline_data: {mime_type: mime, data: b64}});
        }

        const body = { 
            contents: [{ parts }], 
            generationConfig: { temperature: 0.7 } 
        };
        
        if (useSearch) body.tools = [{ googleSearch: {} }];

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || "Gemini API Error");
        
        let txt = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!txt) txt = "ç„¡æ³•ç”¢ç”Ÿå›æ‡‰ï¼Œè«‹ç¢ºèªæ¨¡å‹æˆ–åœ–ç‰‡å…§å®¹ã€‚";

        const chunks = data.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
        if (chunks.length > 0) {
            const sources = chunks
                .map((c, i) => c.web ? `${i+1}. [${c.web.title || 'ä¾†æºç¶²é '}](${c.web.uri})` : "")
                .filter(s => s !== "")
                .join("\n");
            if (sources) txt += "\n\n**åƒè€ƒä¾†æº (2025 æœ€æ–°):**\n" + sources;
        }
        
        return txt;
    }

    async function callOpenAICompatible(provider, key, model, sys, user, b64, mime) {
        let url = PROVIDERS[provider].listUrl; 
        if (provider === 'openrouter') url = "https://openrouter.ai/api/v1";
        else if (provider === 'groq') url = "https://api.groq.com/openai/v1";
        else if (provider === 'openai') url = "https://api.openai.com/v1";
        else if (provider === 'perplexity') url = "https://api.perplexity.ai";

        const contentPayload = [{type: "text", text: user}];
        if (b64) {
            contentPayload.push({
                type: "image_url", 
                image_url: { url: `data:${mime};base64,${b64}` }
            });
        }

        const headers = { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${key}` 
        };
        if (provider === 'openrouter') { 
            headers['HTTP-Referer'] = location.href; 
            headers['X-Title'] = 'Visual Assistant 2025'; 
        }

        const body = {
            model: model,
            messages: [
                {role: "system", content: sys},
                {role: "user", content: contentPayload}
            ],
            temperature: 0.7
        };

        const res = await fetch(`${url}/chat/completions`, {
            method: 'POST', headers, body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || JSON.stringify(data));
        return data.choices[0].message.content;
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function safeHtml(text) { 
        if(!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); 
    }
</script>

</body>
</html>
